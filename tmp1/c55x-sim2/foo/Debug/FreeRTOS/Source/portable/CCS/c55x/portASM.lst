TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    1

    1882              ; Temporary Registers Used: None
       1              ; .cdecls C, LIST, "FreeRTOSConfig.h"
       2              ;  .include "FreeRTOSConfig.h"
       3              ; 32-bit stack slow mode
       4                      .mmregs
       5                       .C54CM_off
       6              ;     .CPL_off
       7                    .ARMS_off
       8                       .align 4
       9              ;       .c28_amode
      10              
      11                           .global _usCriticalNesting
      12                           .global _save_xsp
      13                           .global _Ssave_xssp
      14                           .global _Ssave_xsp
      15                           .global _save_xssp
      16                           .global _restore_xsp
      17                           .global _restore_xssp
      18                           .global _first_save_xsp
      19                           .global _first_save_xssp
      20                           .global _first_flag
      21                           .global _save_xar7
      22                           .global _tZero
      23                           .global _save_xar6
      24                                .global _save_xar1
      25                        .global _save_xar2
      26                        .global _save_xar3
      27                        .global _save_xar4
      28                        .global _root_xsp
      29                        .global _root_xssp
      30              
      31                           .global _pxCurrentTCB                              ;; our currently exectuting TCB
      32                           .global _xTaskIncrementTick
      33                           .ref    _xTaskIncrementTick
      34                           .global _vTaskSwitchContext
      35                           .global _prvSetupTimerInterrupt
      36                           .global _tickIRQctr                                ;; debug - to be disabled during normal run/r
      37                           .global _save_new_pxcode                           ;; updated program counter that task suspende
      38                           .global _save_new_pxlcode                          ;; sysstack contents plus loop counter conten
      39                           .global _xCompareTCB                               ;; task Control Block for comparison
      40                                        .global _save_ac0
      41                                        .global _save_ac1
      42              ;                         .ref configUSE_TICK_CTR
      43              ;                         .ref configUSE_PREEMPTION
      44                                    .global _context_switch_counter
      45                           .def _vPortYield
      46                           .def _xPortStartScheduler
      47                           .def _vTickISR
      48              ;            .def _portSAVE_CONTEXT_CALL
      49              ;            .global _portSAVE_CONTEXT_CALL
      50                           .global _vPortYield
      51                           .global _xPortStartScheduler
      52                           .global _vTickISR
      53                           .global _INT14_ISR
      54                           .global _portFLAGS_INT_ENABLED
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    2

      55                           .global _portFLAGS_INT_ENABLED_POPPED
      56                           .global _DBSTAT_SAVE
      57                           .global _DBSTAT_RESTORE
      58                           .global _LOOP_BITS
      59                           .global _STATUS0_LOW
      60                           .global _STATUS0_HIGH
      61                           .global _STATUS1_LOW
      62                           .global _STATUS1_HIGH
      63                           .global _STATUS2_LOW
      64                           .global _STATUS2_HIGH
      65                           .global _PC_REG_HIGH_SAVE
      66                           .global _PC_REG_LOW_SAVE
      67                           .global _PC_REG_HIGH_RESTORE
      68                           .global _PC_REG_LOW_RESTORE
      69              ;            .cdecls C,NOLIST,"portmacro.h"
      70              ;            .cdecls C,LIST,"FreeRTOSConfig.h"
      71              ;                       CLRC AMODE
      72              ;       System Stack
      73 000000               .text
      74              ;_portSAVE_CONTEXT_CALL:
      75              portSAVE_CONTEXT .macro 
      76              ;                       ;CONTEXT_SAVE
      77              ;                       ASP  ; Align Stack Pointer
      78              ;                       CLRC       OVM,PAGE0
      79              ;                       CLRC       AMODE
      80              ;                       EALLOW
      81                              bclr C54CM      ; temp - until we figure out what is setting this
      82              ;;;             bset INTM               ; disable interrupts - already done
      83              ;                       aadd #1, sp
      84                                      nop
      85                                      nop
      86                                      nop
      87              
      88                                      mov xsp,  dbl (*(#_Ssave_xsp))                  ; save xsp
      89                                      mov xssp, dbl (*(#_Ssave_xssp))                 ; save xssp
      90              ;;;                     mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
      91              ;;;                     mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
      92              
      93              ;                       pshboth xar7
      94              ;                       pshboth xar6
      95              ;                       pshboth xar5
      96              
      97              ;;;;                    mov xar7, dbl (*(#_save_xar7))                  ; save xar7 (already saved)
      98              ;                       .if configUSE_CONTEXT_DEBUG == 1
      99              ;;;;                    mov xar6, dbl (*(#_save_xar6))                  ; saved in vTick ISR already
     100              ;                       .endif
     101                                      aadd #1, sp
     102              ; +++===+++
     103              
     104                                      .if 1                                                           ; need to figure out 
     105                                      mov xar1, dbl (*(#_save_xar1))
     106                                      mov xar2, dbl (*(#_save_xar2))
     107                                      mov xar3, dbl (*(#_save_xar3))
     108                                      mov xar4, dbl (*(#_save_xar4))
     109                                      amov #0x000000, xar5
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    3

     110                                      amov #0x000000, xar6
     111                                      mov xsp, xar5
     112                                      mov xssp, xar6
     113                                      amov #0x000000, xar2
     114                                      amov #0x000000, xar1
     115                                      amov #0x000000, xar3
     116                                      amov #0x000000, xar4
     117                                      mov dbl (*(#_pxCurrentTCB)), xar7
     118              
     119                                      mov dbl (*ar7), xar4                            ; xsp contains our TCB now
     120                                      mov dbl (*ar7(#2)), xar3
     121                                      add #-3, ar4
     122                                      add #-3, ar3
     123              
     124                                      mov *ar5(#0), ar2                               ; current xsp contents
     125                                      mov *ar6(#0), ar1                               ; current xssp contents
     126              ;                       mov ar4, *ar6                           ; stack pointers fixed up
     127                                      mov ar2, *ar4                           ; saves our new PC - but, does this work in e
     128                                      mov ar1, *ar3
     129                                      .endif
     130              ;;                      aadd #1, sp
     131                                      .if 0
     132                          amov #0x000000, xar7
     133                                      mov dbl (*(#_pxCurrentTCB)), xar7
     134                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     135                                      mov dbl (*ar7(#2)), xssp
     136                          amov #0x000000, xar7
     137                                      amov #0x000000, xar6
     138                          mov *(#_save_new_pxcode), ar7
     139                          mov ar7, *sp(#0)
     140                          amov #0x000000, xar7
     141                          mov ssp, ar6
     142                          mov *(#_save_new_pxlcode), ar7
     143              ;            mov ar7, *ssp(#0)
     144                          mov ar7, *ar6(#0)
     145                              .endif
     146              
     147              ;                       mov ssp, ar7
     148              ;                       mov *ar7(#1), ar6                               ; this is (one)two away now
     149              ;                       mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
     150              ;                       .endif
     151              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7
     152              ;            mov xar6, dbl (*(#_save_xar6))                  ; save x
     153                                      .if 0
     154                                      amov #0x000000, xar7
     155                                      amov #0x000000, xar6
     156                          mov *sp(#0), ar7                                            ;; sp+3
     157                          mov ar7, *(#_save_new_pxcode)
     158                          mov ssp, ar6
     159                          mov *ar6(#1), ar7                                                       ;; ssp+3
     160                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and if a task, it
     161                                   ;   nop
     162                          mov dbl (*(#_pxCurrentTCB)), xar7
     163                          mov xar7, dbl(*(#_xCompareTCB))
     164                          .endif
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    4

     165              ; +++===+++
     166              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     167              ;
     168              
     169              
     170              ; +++===+++
     171                                      .if 0
     172              ;                       mov dbl (*(_xCompareTCB)), xar6                 ; need to save our return address
     173              ;                       mov xar7, ac0
     174              ;               mov xar6, ac1
     175              ;                       CMPU AC1 != AC0, TC1
     176              ;                               BCC $5,TC1
     177                                      amov #0x000000, xar7
     178                                          amov #0x000000, xar6
     179                                          mov  *(#_save_new_pxcode), ar7
     180                                          mov ar7, *sp(#0)
     181                              mov *(#_save_new_pxlcode) , ar7
     182                              mov ssp, ar6
     183                              mov ar7, *ar6(#0)
     184                              mov dbl (*(#_save_xar6)), xar6
     185                                         .endif
     186              ; +++===+++
     187              $5:
     188                                              
     189              ; +++===+++
     190              ;; what about xssp here?
     191              ;;                              mov xsp, dbl (*(#_save_xsp))                    ; save xsp
     192              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
     193                                 .if configUSE_CONTEXT_DEBUG == 1
     194              ;; save current PC (and possible loop bits values)
     195              ;; for debug - to see if this is being corrupted
     196                                      mov dbl(*ar7), xar6
     197                                      mov dbl(*ar6), xar7
     198                                      mov xar7, dbl (*(#_PC_REG_LOW_SAVE))            ; save off the PC
     199                                      mov xssp, xar7
     200                                      mov dbl(*ar7), xar6
     201                                      mov dbl(*ar6), xar7
     202                                      mov xar7, dbl (*(#_PC_REG_HIGH_SAVE))           ; save off the PC
     203                                      mov xssp, xar7
     204                                      add #-2, ar7
     205                                      mov dbl(*ar7), xar6
     206                                      mov xar6,  dbl (*(_DBSTAT_SAVE))
     207                          mov dbl (*(#_save_xar6)), xar6
     208              
     209              ;            mov (*ar7), (*(#_PC_REG_LOW_SAVE))
     210              ;            mov dbl(*xssp),(*(#_PC_REG_HIGH_SAVE))
     211              ;                       mov (*ssp(#-2)), (*(#_DBSTAT_SAVE))
     212                                      .endif
     213              ; +++===+++
     214                                      ; save context in our stack(s) frame
     215              
     216              ;;;;                    mov dbl (*(#_pxCurrentTCB)), xar7
     217              ;;;                     mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     218              ;;;                     mov dbl (*ar7(#2)), xssp
     219              ; +++===+++
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    5

     220              ;                   mov dbl (*(#_pxCurrentTCB)), xar7
     221                                  ; add #0x0064, ar7
     222              ;                       mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
     223              ;                       mov dbl (*ar7(#2)), xssp
     224              ;           add #0x0064, ar4
     225              ;                       add #0x0064, ar3
     226              ;                       mov dbl (*ar5), xar4                            ; xsp contains our TCB now
     227              ;                       mov dbl (*ar5(#2)), xar3                        ; xssp
     228              ;                       add #0x0064, ar4
     229              ;                       add #0x0064, ar3
     230                              amov #0x000000, xar7
     231                                      amov #0x000000, xar6
     232                                      mov dbl (*(#_pxCurrentTCB)), xar7
     233                                      mov dbl (*ar7), xar6                            ; xsp normal position
     234                                      add #-3, ar6
     235                                      mov xar6, xsp                                           ; actual xsp
     236                                      mov dbl (*ar7(#2)), xar6                        ; xssp
     237                                      add #-3, ar6
     238                                      mov xar6, xssp
     239              
     240                          mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
     241                          mov dbl (*(#_save_xar6)), xar6
     242              ;            mov dbl (*(#_save_xar1)), xar1                  ; restore xar7
     243              ;            mov dbl (*(#_save_xar2)), xar2
     244              ;            mov dbl (*(#_save_xar3)), xar3                  ; restore xar7
     245              ;            mov dbl (*(#_save_xar4)), xar4
     246                                        ; restore xar6
     247              ;;; begin context save:
     248                                      aadd #-26, sp
     249              
     250                                      mov xar7, dbl(*sp(#20))                         ; save xar7
     251                                      mov ar7, *sp(#21)
     252              
     253                                      mov xar6, dbl(*sp(#18))
     254                                      mov ar6, *sp(#19)
     255              
     256                                      mov xar5, dbl(*sp(#16))
     257                                      mov ar5, *sp(#17)
     258              
     259                                      mov xar4, dbl(*sp(#14))
     260                                      mov ar4, *sp(#15)
     261              
     262                                      mov xar3, dbl(*sp(#12))
     263                                      mov ar3, *sp(#13)
     264              
     265                                      mov xar2, dbl(*sp(#10))
     266                                      mov ar2, *sp(#11)
     267              
     268                                      mov xar1, dbl(*sp(#8))
     269                                      mov ar1, *sp(#9)
     270              
     271                                      mov xar0, dbl(*sp(#6))
     272                                      mov ar0, *sp(#7)
     273              
     274                                      mov  ac0, dbl(*sp(#4))
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    6

     275                                      mov ac0, *sp(#5)
     276              
     277                                      mov t3, *sp(#3)
     278                                      mov t2, *sp(#2)
     279                                      mov t1, *sp(#1)
     280                                      mov t0, *sp(#0)
     281              ; +++===+++
     282              ;;                      mov mmap(ST0_55), t0
     283              ; - this is ok - we are not pushing - it's a relative stack frame
     284              ;                       mov t0, *sp(#25)
     285              ;;                      mov t0, *sp(#23)
     286              ;;                      mov mmap(ST1_55), t1
     287              ;                       mov t1, *sp(#26)                ; stomping on own mem
     288              ;;                      mov t1, *sp(#21)                ; stomping on own mem
     289              ;;                      mov mmap(ST2_55), t2
     290              ;;                      mov t2, *sp(#22)
     291              ;                       mov t2, *sp(#27)
     292              ;;                      mov mmap(ST2_55), t3
     293              ;                       mov t3, *sp(#28)
     294              ;;                      mov t3, *sp(#24)
     295              
     296              ;                       PSH dbl(AR0) ; 32-bit
     297              ;                       PSH dbl(AR1) 
     298              ;                       PSH dbl(AR2) ; 32-bit
     299              ;                       PUSH XAR3 ; 32-bit
     300              ;                       PUSH XAR4 ; 32-bit
     301                              ;-- Comment these to save cycles --------
     302              ;                       PUSH XAR5 ; 32-bit
     303              ;                       PUSH XAR6 ; 32-bit
     304              ;                       PUSH XAR7 ; 32-bit
     305                              ;----------------------------------------
     306              
     307              ;                       PUSH XT   ; 32-bit
     308              
     309              ;                       movl xar6, @_portFLAGS_INT_ENABLED
     310              ;                       push xar6 ; portFLAGS_INT_ENABLED
     311              ; +++===+++
     312              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     313              ;                       mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
     314              ;                       mov dbl (*ar7(#2)), xssp
     315              
     316                                      mov dbl (*(#_portFLAGS_INT_ENABLED)), xar6
     317                                      mov xar6, dbl(*sp(#25))
     318              
     319              ;                       movl xar7, @_usCriticalNesting
     320              ;                       push xar7
     321                                      mov dbl (*(#_usCriticalNesting)), xar7
     322                                      mov xar7, dbl(*sp(#23))
     323              
     324                                      amov #0x000000, xar7
     325                                      amov #0x000000, xar6
     326              
     327                                      mov mmap(ST1_55), ar7
     328                                      mov ar7, *sp(#1)
     329                                      mov  mmap(ST2_55), ar7
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    7

     330                                      mov ar7, *sp(#2)
     331              
     332                                      mov ssp, ar7
     333              ;                       mov *(#_LOOP_BITS), ar6                 ; save LOOP_BITS (CFCT)
     334              ;                       and #0xFF00, ar6
     335              ;                       mov ar6, *ar7(#1)
     336              
     337                                      mov mmap(ST0_55), ar6
     338                                      mov ar6, *ar7(#2)
     339                                      
     340                                      mov *(#_DBSTAT_SAVE), ar6               ; save DBSTAT
     341                                      mov ar6, *ar7(#1)
     342              ; +++===+++
     343              ;                       mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
     344              ;                       mov dbl (*(#_save_xssp)), xssp          
     345              ;;;                     mov  dbl (*(_DBSTAT_SAVE)), *xar7(#2)   ; needs to be DBSTAT - don't overwrite DBSTAT
     346              ;;;                     mov ar6, *ar7(#2)
     347              ;                       mov ar7, mmap(ST0_55)
     348              ;                       mov *ssp(#2), ar7
     349              ; fix up
     350              ;                       aadd #20, sp
     351              ;                       mov sp, t0
     352              ;                       sub #1, t0
     353              ;                       mov t0, ssp
     354              
     355                                      ; move contents of SP into address of current TCB
     356              ;                       mov xsp, dbl (*(#_pxCurrentTCB))                ; xsp contains our TCB now
     357              
     358              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
     359              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     360              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     361              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     362              ;                       mov dbl (*ar7+), xssp
     363              
     364              ;                       mov sp, t0              ; we've already saved t0
     365              ;                       add #1, t0
     366              ;                       mov t0, ssp
     367              ; ??
     368              ;                       mov xsp, dbl (*(#_pxCurrentTCB))
     369              
     370              ;                       movl xar6, @_pxCurrentTCB ; XAR6 contains current TCB addr
     371              ;                       mov al, @sp
     372              ;                       movl  *xar6, acc        
     373              ;;                      mov  ar0, @sp
     374              ;;                      mov  @ar6, alxd
     375              ;;                      mov  ar0, @sp
     376              ;;                      movl 0(xar6), sp
     377              ;                       EDIS
     378              ;                       NASP
     379              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
     380              ;                       NOP
     381              ;                       .if configSTACK_PTR_DEBUG == 1
     382              ;                       mov xsp, dbl(*(#_Ssave_xsp))
     383              ;            mov xssp, dbl(*(#_Ssave_xssp))
     384              ;            .endif
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    8

     385                              .if 0
     386                                      mov  xar7, dbl (*(#_save_xar7))                 ; restore xar7
     387                          mov  xar6, dbl (*(#_save_xar6))
     388              
     389                              amov #0x000000, xar7
     390                                      amov #0x000000, xar6
     391                                  mov dbl (*(#_pxCurrentTCB)), xar7
     392                                      mov dbl (*ar7), xar6                            ; xsp normal position
     393                                      add #0x0064, ar6
     394                                      mov xar6, xsp                                           ; actual xsp
     395                                      mov dbl (*ar7(#2)), xar6                        ; xssp
     396                                      add #0x0002, ar6
     397                                      mov xar6, xssp
     398              
     399                          mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
     400                          mov dbl (*(#_save_xar6)), xar6
     401                        .endif
     402              
     403              ;;;;                    mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
     404              ;;;;                    mov dbl (*(#_save_xssp)), xssp
     405              
     406                                      mov dbl (*(#_Ssave_xsp)), xsp                   ; restore xsp*
     407                                      mov dbl (*(#_Ssave_xssp)), xssp                 ; restore xssp
     408              
     409                                      nop
     410              ;                       aadd #-1, sp
     411                                      nop
     412              
     413                                      nop
     414                                                                                      ; ?
     415                                      .endm
     416              
     417              portRESTORE_CONTEXT .macro
     418                                      .C54CM_off
     419              ;                       .CPL_off
     420                                      .ARMS_off
     421                                      .align 4
     422              
     423              ; Restore context & return - here we need to know what context we're in
     424                                      ;CONTEXT_RESTORE
     425              ;                       ASP
     426              ;                       EALLOW
     427              ;                       nop
     428              ;                       nop
     429              ;                       nop
     430              ;                       nop
     431                              bclr C54CM
     432                              nop
     433                              nop
     434                              nop
     435                              nop
     436                              nop
     437                              nop
     438              ;               xssp = dbl(*(#_pxCurrentTCB))
     439              ;               xsp  = dbl(*(#_pxCurrentTCB))
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    9

     440                                      mov xar7, dbl (*(#_save_xar7))  
     441                                      mov xar6, dbl (*(#_save_xar6))
     442              
     443              ;;;;                     aadd #-3, sp                           ;;;;
     444              ;            aadd #-3, xsp
     445              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
     446              ;            BCC $1,TC1 ; |216|
     447              ;;                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
     448              ;;                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
     449              ;            B $4
     450              ;;              aadd #-2, sp
     451                                      mov xsp, dbl (*(#_restore_xsp))                 ; save xsp
     452                                      mov xssp, dbl (*(#_restore_xssp))                       ; save xssp
     453               ;                      aadd #3, xsp
     454              ;;;             aadd #-3, sp
     455              
     456              ;;;;            mov dbl(*(#_root_xsp)), xsp
     457              ;;;;                    mov dbl(*(#_root_xssp)), xssp
     458              ;;;                     aadd #3, sp
     459              
     460              ;$1
     461              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
     462              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
     463              ;$4
     464                                      .if 1
     465              ;;                      mov xsp, xar7
     466              ;;                      mov xssp, xar6
     467                                      amov #0x000000, xar2
     468                                      amov #0x000000, xar1
     469              
     470                                      mov dbl (*(#_pxCurrentTCB)), xar5
     471                                                                                               ;; points to our variables n
     472                                      mov dbl (*ar5), xar4                            ; xsp contains our TCB now
     473                                      mov dbl (*ar5(#2)), xar3
     474                                      add #-3, ar4
     475                                      add #-3, ar3
     476                                      
     477                                      mov xar4, xsp
     478                                      mov xar3, xssp
     479              
     480              ;;;                     mov *ar4, ar2
     481              ;;;                     mov *ar3, ar1                           ; maybe not on a yield here
     482              ;                       mov ar4, *ar6                           ; stack pointers fixed up
     483              ;;;                     mov ar2, *ar7
     484              ;;;                     mov ar1, *ar6
     485              
     486                                      mov mmap(ST1_55), ar7
     487                                      and #0xf7ff, ar7                        ; <here>#0800h
     488                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
     489                                      mov ar7, *ar4(#1)                       ; save in TCB
     490                                      mov mmap(ST2_55), ar7
     491                                      mov ar7, *sp(#2)
     492                                      mov ar7, *ar4(#2)
     493              
     494                                      mov ssp, ar7
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   10

     495                                      mov mmap(ST0_55), ar6
     496                                      mov ar6, *ar7(#2)
     497                                      mov ar6, *ar3(#2)
     498                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
     499              ;;                      mov ar6, *ar7(#1)
     500                                      mov ar6, *ar3(#1)
     501                                      .endif
     502              
     503              ;                       mov #0, ssp     
     504              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
     505              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     506                                      ; 32-bit mode - will act on SP and SSP:
     507              ;                       'fix-up' current SP and SSP - is this dangerous????
     508              ;                       aadd #-3, sp
     509              ;;                      mov *ar7, *sp
     510              ;                       mov dbl (*ar7), ar6
     511              ;                       mov ar6, *sp                            ; xsp contains our TCB now
     512              ;                       mov *ar7(#2), *ssp                      
     513              ;                       POP mmap(ST3_55)
     514              ;                       pshboth xar7                            ; should increment both
     515                                      .if 0
     516                                      mov mmap(ST1_55), ar7
     517                                      and #0xf7ff, ar7                        ; <here>#0800h
     518                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
     519                                      mov mmap(ST2_55), ar7
     520                                      mov ar7, *sp(#2)
     521              
     522                                      mov ssp, ar7
     523                                      mov mmap(ST0_55), ar6
     524                                      mov ar6, *ar7(#2)
     525              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
     526              ;;                      mov ar6, *ar7(#1)
     527                                      .endif
     528              ; +++===+++
     529                                      .if 0
     530                                      mov dbl (*(#_pxCurrentTCB)), xar7
     531                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     532                                      mov dbl (*ar7(#2)), xssp        
     533                                      .endif
     534              ; +++===+++
     535                                      .if 0
     536                                      mov dbl (*(_xCompareTCB)), xar6
     537              ; need to restore our return address
     538                                      mov xar7, ac0
     539                                          mov xar6, ac1
     540                                          CMPU AC1 != AC0, TC1 ; |1393|
     541                                          BCC $6,TC1 ; |1393|
     542                                          amov #0x000000, xar7
     543                                          amov #0x000000, xar6
     544                                          mov  *(#_save_new_pxcode), ar7
     545                                          mov ar7, *sp(#0)
     546                                          mov *(#_save_new_pxlcode) , ar7
     547                                          mov ssp, ar6
     548                                          mov ar7, *ar6(#0)
     549              
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   11

     550                                          mov dbl (*(#_save_xar6)), xar6
     551                                                              .endif
     552              ; +++===+++
     553              $6:
     554              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
     555              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
     556                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
     557                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
     558                                      mov xar6, dbl (*(#_save_xar6))
     559              
     560              ;; this is for debug
     561                                      mov dbl(*ar7), xar6
     562                                      mov dbl(*ar6), xar7
     563                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
     564                                      mov xssp, xar7
     565                                      mov dbl(*ar7), xar6
     566                                      mov dbl(*ar6), xar7
     567                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
     568                                      mov xssp, xar7
     569                                      add #-2, ar7
     570                                      mov dbl(*ar7), xar6
     571                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
     572                                      mov dbl (*(#_save_xar6)), xar6
     573                                      
     574                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
     575                                      .endif
     576              ; +++===+++
     577              ;                       mov mmap(ST0_55), *ssp(#1)
     578              ;                       mov mmap(STO_55), *ssp(#2)
     579              ;                       mov mmap(ST1_55), *sp(#1)
     580              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
     581              ;                       mov *ar7, t0
     582              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
     583              ;                       mov *ar7(#2), t0
     584              ;                       mov t0, *ssp(#0)                        
     585              
     586              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
     587              ; what about xssp?
     588              ;                       mov xar6, xsp
     589              ;                       mov xssp, xar7
     590              ;                       add #1, ar7
     591              ;                       mov xar7, xsp
     592              ;                       mov sp, t0
     593              ;                       mov ssp, t1
     594              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
     595              ;                       ar0 = *ar6
     596              ;                       xssp = xar0
     597              ;                       mov *xar6, xar0
     598              ;                       mov xar0, xssp  ; stack now points to our TCB
     599              ;;                      mov sp, *ar6
     600              ;;                      mov sp, ar0
     601              ;;                      mov sp, *_pxCurrentTCB
     602              ;;                      clr ar0
     603              ;;                      mov ar0, @xar6
     604              ;;                      mov sp, AR0
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   12

     605              ;;                      add sp, xar6
     606              
     607              ;;                      pshboth xar7
     608              ;;                      pshboth xar6
     609              ;;                      pshboth xar5
     610              
     611              ;;                      popboth xar5
     612              ;;                      popboth xar6
     613              ;;                      popboth xar7
     614              
     615              ;;;                     mov *sp(#1), ar7 
     616              ;                       mov dbl(*sp(#1)), ar7
     617              ;;;                     mov  ar7, mmap(ST1_55)
     618              ; +++===+++
     619              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     620              ;                       add #0x0064, ar7
     621              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     622              ;                       mov *ar7(#2)
     623              ;                       mov dbl (*ar7(#2)), xssp
     624              ; ===+++===
     625                 .if 1
     626                              amov #0x000000, xar7
     627                                      amov #0x000000, xar6
     628                                  mov dbl (*(#_pxCurrentTCB)), xar7
     629                                      mov dbl (*ar7), xar6                            ; xsp normal position
     630                                      add #-3, ar6
     631                                      mov xar6, xsp                                           ; actual xsp
     632                                      mov dbl (*ar7(#2)), xar6                        ; xssp
     633                                      add #-3, ar6
     634                                      mov xar6, xssp
     635                 .endif
     636              ; ===+++===
     637              ;                       add #0x0064, xssp
     638              ; +++===+++
     639                                      .if 0
     640                                      mov *sp(#2), ar7
     641                                      mov ar7, mmap(ST2_55)
     642                                      mov ssp, ar7
     643                                      mov *ar7(#2), ar6
     644                                      mov ar6, mmap(ST0_55)
     645                                      .endif
     646              ;                       mov *ar7(#2), ar6
     647              ;                       mov ar6, *ssp(#2)
     648              ;                       mov *ssp(#2), ar7
     649              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
     650              ;
     651              ; restore context
     652              
     653                                      amov #0x000000, xar2
     654                                      amov #0x000000, xar1
     655              
     656                                      .if 0
     657                                      mov mmap(ST1_55), ar7
     658                                      and #0xf7ff, ar7                        ; <here>#0800h
     659                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   13

     660                                      mov ar7, mmap(ST1_55)
     661              ;                       mov ar7, *ar4(#1)                       ; save in TCB
     662                                      mov mmap(ST2_55), ar7
     663                                      mov ar7, *sp(#2)
     664              ;                       mov ar7, *ar4(#2)
     665              
     666                                      mov ssp, ar7
     667                                      mov mmap(ST0_55), ar6
     668                                      mov ar6, *ar7(#2)
     669              ;                       mov ar6, *ar3(#2)
     670                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
     671                                      mov ar6, *ar7(#1)
     672              ;                       mov ar6, *ar3(#2)
     673                                      .endif
     674              ;;                      mov *(#_LOOP_BITS), ar6         ; have to restore this
     675              ;;                      and #0xFF00, ar6
     676              ;;                      mov ar6, *ar7(#1)
     677              
     678                                      aadd #-26, sp
     679              
     680                                      amov #0x000000, xar7
     681                                      mov dbl(*sp(#25)), xar7
     682              ;                       mov *sp(#1), ar7
     683                                      mov xar7, dbl(*(#_usCriticalNesting))
     684                          amov #0x000000, xar6
     685                                      mov dbl(*sp(#23)), xar6
     686              ;                       mov *sp(#3), ar6
     687              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
     688                                      mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))
     689              
     690              
     691                                      mov *sp(#0), t0
     692                                      mov *sp(#1), t1
     693                                      mov *sp(#2), t2
     694                                      mov *sp(#3), t3
     695                                      mov dbl(*sp(#4)), ac0
     696                          mov *sp(#5), ac0
     697                                  mov dbl(*sp(#6)), xar0
     698                                      mov *sp(#7), ar0
     699                                      mov dbl(*sp(#8)), xar1
     700                                      mov *sp(#9), ar1
     701                                      mov dbl(*sp(#10)), xar2
     702                                      mov *sp(#11), ar2
     703                                      mov dbl(*sp(#12)), xar3
     704                                      mov *sp(#13), ar3
     705              ;; pvPararmeters currently here - needs to be verified --- jcw
     706                                      mov dbl(*sp(#14)), xar4
     707                                      mov *sp(#15), ar4
     708                                      mov dbl(*sp(#16)), xar5
     709                                      mov *sp(#17), ar5
     710                                      mov dbl(*sp(#18)), xar6
     711                                      mov *sp(#19), ar6
     712              
     713              ;                       POP XT
     714                              ;-- Comment these to save cycles ---
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   14

     715                                      mov dbl(*sp(#20)), xar7
     716                                      mov *sp(#21), ar7
     717              
     718                                      .if 0
     719              
     720                                      mov dbl(*sp(#4)), xar7
     721              ;                       mov *sp(#1), ar7
     722                                      mov xar7, dbl(*(#_usCriticalNesting))   
     723              
     724                                      mov dbl(*sp(#6)), xar6
     725              ;                       mov *sp(#3), ar6
     726              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
     727                                      mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))       
     728              ;                       POP XT
     729                              ;-- Comment these to save cycles ---
     730                                      mov dbl(*sp(#8)), xar7
     731                                      mov *sp(#7), ar7
     732              ;                       mov *sp(#5), ar7
     733              ;                       mov dbl(*sp(#0)), hi(ar7)
     734              ;                       mov (*sp(#0)), lo(ar7)
     735                                      mov dbl(*sp(#10)), xar6
     736                                      mov *sp(#9), ar6
     737                                      mov dbl(*sp(#12)), xar5
     738                                      mov *sp(#11), ar5
     739              ;; pvPararmeters currently here - needs to be verified --- jcw
     740                                      mov dbl(*sp(#14)), xar4
     741                                      mov *sp(#13), ar4
     742                                      mov dbl(*sp(#16)), xar3
     743                                      mov *sp(#15), ar3
     744                                      mov dbl(*sp(#18)), xar2
     745                                      mov *sp(#17), ar2
     746                                      mov dbl(*sp(#20)), xar1
     747                                      mov *sp(#19), ar1
     748                                      mov dbl(*sp(#22)), xar0
     749                                      mov *sp(#21), ar0
     750                                  mov dbl(*sp(#24)), ac0
     751                          mov *sp(#23), ac0
     752              
     753                                      mov *sp(#25), t3
     754                                      mov *sp(#26), t2
     755                                      mov *sp(#27), t1
     756                                      mov *sp(#28), t0
     757                                      .endif
     758              
     759              ;                       mov dbl(*sp(#21)), *xssp(#0)
     760              ;                       mov *sp(#21), *ssp
     761              ;                       mov *sp(#21), RETA
     762              ; need to move 23-16 to XSSP contents
     763              ;                       mov xar0, dbl (*(#_save_xar7))
     764              ;                       mov ssp, ar0
     765              ;                       mov #0, ssp 
     766              ;                       mov xssp, xar0
     767              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
     768              ;                       aadd #20, sp            ; this is ok - ssp also incremented
     769                      ;               add #1, xssp            ; 32-bit return address pointer
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   15

     770                      ;               amar *xssp+
     771              ;                       mov sp, t0
     772              ;                       add #1, t0
     773              ;                       mov t0, ssp
     774              ;                       incr ssp
     775              ;                       asub #20, ar0
     776              ;                       mov xar0, xssp
     777              ;                       mov ar0, ssp
     778              ;                       mov ar0, 
     779              ;;                      mov *sp(#1), t0
     780              ;;                      mov *sp(#3), t3         ; ST0
     781              ;;                      mov *sp(#4), t2         ; DBSTAT
     782              ;;                      mov t3, *ar0(#2)
     783                      ;;              mov t2, *ar0(#1)
     784              ;;                      mov t0, *ar0(#0)
     785              
     786              ;;                      mov *sp(#5), t0
     787              ;;                      mov *sp(#6), t1
     788              ;;                      mov *sp(#7), t2
     789                      ;;              mov *sp(#8), t3
     790              
     791              ; restore ar0
     792              ;                       mov dbl(*sp(#-2)), xar0
     793              ;                       mov #-1, ar0
     794              ;;                      mov dbl (*(#_save_xar7)), xar0
     795              ;;
     796              ;;                      mov sp, t0
     797              ;;                      add #1, t0
     798              ;;                      mov t0, ssp
     799              
     800              ;                       mov *sp(#3), *(#00004ch+#1)
     801              
     802              ;                       mov t3, *ssp(#1) 
     803              ;                       mov t2, *ssp(#2)
     804              
     805              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
     806              ;;                      mov t3, *(ssp(#0))
     807              ;                       mov t3, *ssp
     808              ;                       mov *sp(#3), t3 ; 
     809              ;                       mov t3, *ssp(#1)
     810              ;;                      mov *sp(#21), PC        
     811              
     812              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
     813              ;                       mov dbl(xsp), dbl(lcrpc)
     814              ;                       popboth XAR7
     815              ;                       add #1, sp
     816              ;                       add #1, ssp
     817              ;                       add #2, t0
     818              ;                       add #2, t1
     819              ;                       mov t0, sp
     820              ;                       mov t1, ssp
     821              ;                       popboth XAR6
     822              ;                       add #2, t0
     823              ;                       add #2, t1
     824              ;                       mov t0, sp
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   16

     825              ;                       mov t1, ssp
     826              ;                       popboth XAR5
     827              ;                       add #2, t0
     828              ;                       add #2, t1
     829              ;                       mov t0, sp
     830              ;                       mov t1, ssp
     831                              ;-----------------------------------
     832              ;                       popboth XAR4
     833              ;                       add #2, t0
     834              ;                       add #2, t1
     835              ;                       mov t0, sp
     836              ;                       mov t1, ssp
     837              ;                       popboth XAR3
     838              ;                       add #2, t0
     839              ;                       add #2, t1
     840              ;                       mov t0, sp
     841              ;                       mov t1, ssp
     842              ;                       popboth XAR2
     843              ;                       add #2, t0
     844              ;                       add #2, t1
     845              ;                       mov t0, sp
     846              ;                       mov t1, ssp
     847              ;                       popboth XAR1
     848              ;                       add #2, t0
     849              ;                       add #2, t1
     850              ;                       mov t0, sp
     851              ;                       mov t1, ssp
     852              ;                       popboth XAR0
     853              ;                       add #2, t0
     854              ;                       add #2, t1
     855              ;                       mov t0, sp
     856              ;                       mov t1, ssp
     857              ;                       EDIS
     858              ;                       NASP    ; Un-align stack pointer
     859              ;;                      pop mmap(ST3_55)
     860              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
     861              ;            BCC $2,TC1 ; |216|
     862                                      .if 0
     863                                      mov dbl (*(#_pxCurrentTCB)), xar7
     864              
     865                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     866                                      mov dbl (*ar7(#2)), xssp                
     867                                      .endif
     868              
     869              ;;;              mov dbl(*(#_restore_xsp)), xsp
     870              ;;;=-=             mov dbl(*(#_restore_xssp)), xssp
     871              ;;;=-=             mov dbl(*(#_restore_xsp)), xsp
     872              ;;;;                    mov dbl(*(#_root_xssp)), xssp
     873              ;;;                     aadd #3, sp
     874              ;;;;;;                  mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
     875              ;;;;;;                  mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
     876              
     877              
     878                                      .if 0
     879                                      mov dbl (*(_xCompareTCB)), xar6
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   17

     880              ; need to restore our return address
     881                                      mov xar7, ac0
     882                          mov xar6, ac1
     883                              CMPU AC1 != AC0, TC1 ; |1393|
     884                          BCC $6,TC1 ; |1393|
     885                          amov #0x000000, xar7
     886                                      amov #0x000000, xar6
     887                          mov  *(#_save_new_pxcode), ar7
     888                                      mov ar7, *sp(#0)
     889                          mov *(#_save_new_pxlcode) , ar7
     890                          mov ssp, ar6
     891                          mov ar7, *ar6(#0)
     892              
     893                          mov dbl (*(#_save_xar6)), xar6
     894                                      .endif
     895              
     896              ;;                      mov dbl (*(#_save_xar7)), xar7
     897              
     898              ;               .if configSTACK_PTR_DEBUG == 1
     899              ;;                      mov dbl(*(#_restore_xsp)), xsp
     900              ;;            mov dbl(*(#_restore_xssp)), xssp
     901              ;;            .endif
     902              
     903              ;                       B $3
     904              ;$2
     905              ;           MOV #0, *(#_first_flag) ; |217|
     906              ;               mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
     907              ;                       mov dbl (*(#_first_save_xssp)), xssp
     908              ;$3
     909                                      .if 0
     910                              amov #0x000000, xar7
     911                                      amov #0x000000, xar6
     912                                  mov dbl (*(#_pxCurrentTCB)), xar7
     913                                      mov dbl (*ar7), xar6                            ; xsp normal position
     914                                      add #0x0064, ar6
     915                                      mov xar6, xsp                                           ; actual xsp
     916                                      mov dbl (*ar7(#2)), xar6                        ; xssp
     917                                      add #0x0002, ar6
     918                                      mov xar6, xssp
     919                                      .endif
     920              
     921              ;;;;                    aadd #-1, sp                    ; on yield, need to do this
     922                                      aadd #26, sp
     923                                      bclr INTM               ; enable interrupts
     924                                      nop
     925                                      nop
     926                                      nop
     927                                      nop
     928                                      nop
     929                                      nop
     930              
     931              ;                       aadd #1, sp
     932                                      RETI
     933              ;                       mov #1860h, ssp
     934                                      nop
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   18

     935                                      nop
     936              ;                       nop
     937                                      .endm
     938              
     939              
     940              portRESTORE_FIRST_CONTEXT .macro
     941                                      .C54CM_off
     942              ;                       .CPL_off
     943                                      .ARMS_off
     944                                      .align 4
     945              
     946              ; Restore context & return - here we restore into 'root' context
     947                                      ;CONTEXT_RESTORE
     948              ;                       ASP
     949              ;                       EALLOW
     950              ;                       nop
     951              ;                       nop
     952              ;                       nop
     953              ;                       nop
     954                              bclr C54CM
     955                              nop
     956                              nop
     957                              nop
     958              
     959              ;               xssp = dbl(*(#_pxCurrentTCB))
     960              ;               xsp  = dbl(*(#_pxCurrentTCB))
     961                                      mov xar7, dbl (*(#_save_xar7))  
     962              
     963              ; ****************************************************************************
     964              ; * Init Stack Pointer. Remember stack grows from high to low address *
     965              ; ****************************************************************************
     966              ;                       stm #_stack, sp ; set to begging of stack memory
     967              ;                       addm #(_STACK_SIZE  1), *(SP) ; add size to get to the top
     968              ;                       andm #0FFFEh, *(SP) ; make sure it is an even address
     969              
     970                                      aadd #-1, sp
     971              ;            aadd #-3, xsp
     972              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
     973              ;            BCC $1,TC1 ; |216|
     974              ;                       mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
     975              ;                       mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
     976              ;            B $4
     977              
     978              ;;                      mov xsp, dbl (*(#_save_xsp))                    ; save xsp
     979              ;;                      mov xssp, dbl (*(#_save_xssp))                  ; save xssp
     980              
     981              ;                       aadd #-3, sp
     982              ;$1
     983              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
     984              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
     985              ;$4
     986                          mov dbl(*(#_root_xsp)), xsp
     987                                      mov dbl(*(#_root_xssp)), xssp
     988              
     989                                      .if 1
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   19

     990              ;;                      mov xsp, xar7
     991              ;;                      mov xssp, xar6
     992                                      mov  xsp, dbl (*(#_first_save_xsp))                     ; restore xsp
     993                                      mov  xssp, dbl (*(#_first_save_xssp))
     994                                      amov #0x000000, xar2
     995                                      amov #0x000000, xar1
     996                                      amov #0x000000, xar3
     997                                      amov #0x000000, xar4
     998              
     999                                      mov dbl (*(#_pxCurrentTCB)), xar5                               
    1000                                                                                              ;; everything from here is re
    1001                                      mov dbl (*ar5), xar4                            ; xsp contains our TCB now
    1002                                      mov dbl (*ar5(#2)), xar3                        ; xssp          
    1003                                      add #-3, ar4
    1004                                      add #-3, ar3
    1005              
    1006                                      mov xar4, xsp
    1007                                      mov xar3, xssp
    1008              
    1009              ;;;                     mov *ar4, ar2
    1010              ;;;                     mov *ar3, ar1
    1011              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1012              ;;;                     mov ar2, *ar7
    1013              ;;;                     mov ar1, *ar6
    1014                                      .endif;
    1015              ;                       amov #0x000000, xar7
    1016              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1017              
    1018              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1019              ;                       mov dbl (*ar7(#2)), xssp
    1020                                      .if 1
    1021                          amov #0x000000, xar7
    1022                                  mov mmap(ST1_55), ar7
    1023                                      and #0xf7ff, ar7                        ; <here>#0800h
    1024                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1025                                      mov ar7, *ar4(#1)                       ; save in TCB
    1026                                      mov mmap(ST2_55), ar7
    1027                                      mov ar7, *sp(#2)
    1028                                      mov ar7, *ar4(#2)
    1029                          amov #0x000000, xar6
    1030                                      amov #0x000000, xar7
    1031              
    1032                                      mov ssp, ar7
    1033                                      mov mmap(ST0_55), ar6
    1034                                      mov ar6, *ar7(#2)
    1035                                      mov ar6, *ar3(#2)
    1036                                      
    1037                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
    1038                                      mov ar6, *ar7(#1)
    1039                                      mov ar6, *ar3(#1)
    1040              
    1041                                      .endif
    1042              ;                       mov #0, ssp     
    1043              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1044              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   20

    1045                                      ; 32-bit mode - will act on SP and SSP:
    1046              ;                       'fix-up' current SP and SSP - is this dangerous????
    1047              ;                       aadd #-3, sp
    1048              ;;                      mov *ar7, *sp
    1049              ;                       mov dbl (*ar7), ar6
    1050              ;                       mov ar6, *sp                            ; xsp contains our TCB now
    1051              ;                       mov *ar7(#2), *ssp                      
    1052              ;                       POP mmap(ST3_55)
    1053              ;                       pshboth xar7                            ; should increment both
    1054                                      .if 0
    1055                                      mov mmap(ST1_55), ar7
    1056                                      and #0xf7ff, ar7                        ; <here>#0800h
    1057                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1058                                      mov mmap(ST2_55), ar7
    1059                                      mov ar7, *sp(#2)
    1060              
    1061                                      mov ssp, ar7
    1062                                      mov mmap(ST0_55), ar6
    1063                                      mov ar6, *ar7(#2)
    1064                                      .endif
    1065              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
    1066              ;;                      mov ar6, *ar7(#1)
    1067              
    1068                                      .if 0
    1069                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1070              
    1071                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1072                                      mov dbl (*ar7(#2)), xssp        
    1073                                      .endif
    1074              
    1075                                      .if 0                                           ; first task - no pxcode update
    1076                                          mov dbl (*(_xCompareTCB)), xar6
    1077              ; need to restore our return address
    1078                                          mov xar7, ac0
    1079                                          mov xar6, ac1
    1080                                          CMPU AC1 != AC0, TC1 ; |1393|
    1081                                          BCC $7,TC1 ; |1393|
    1082                                          amov #0x000000, xar7
    1083                                          amov #0x000000, xar6
    1084                                          mov  *(#_save_new_pxcode), ar7
    1085                                          mov ar7, *sp(#0)
    1086                                          mov *(#_save_new_pxlcode) , ar7
    1087                                          mov ssp, ar6
    1088                                          mov ar7, *ar6(#0)
    1089              
    1090                                          mov dbl (*(#_save_xar6)), xar6
    1091                                          .endif
    1092              $7:
    1093              
    1094              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
    1095              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1096                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
    1097                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1098                                      mov xar6, dbl (*(#_save_xar6))
    1099              
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   21

    1100              ;; this is for debug
    1101                                      mov dbl(*ar7), xar6
    1102                                      mov dbl(*ar6), xar7
    1103                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
    1104                                      mov xssp, xar7
    1105                                      mov dbl(*ar7), xar6
    1106                                      mov dbl(*ar6), xar7
    1107                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
    1108                                      mov xssp, xar7
    1109                                      add #-2, ar7
    1110                                      mov dbl(*ar7), xar6
    1111                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
    1112                                      mov dbl (*(#_save_xar6)), xar6
    1113                                      
    1114                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1115                                      .endif
    1116              
    1117              ;                       mov mmap(ST0_55), *ssp(#1)
    1118              ;                       mov mmap(STO_55), *ssp(#2)
    1119              ;                       mov mmap(ST1_55), *sp(#1)
    1120              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
    1121              ;                       mov *ar7, t0
    1122              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
    1123              ;                       mov *ar7(#2), t0
    1124              ;                       mov t0, *ssp(#0)                        
    1125              
    1126              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
    1127              ; what about xssp?
    1128              ;                       mov xar6, xsp
    1129              ;                       mov xssp, xar7
    1130              ;                       add #1, ar7
    1131              ;                       mov xar7, xsp
    1132              ;                       mov sp, t0
    1133              ;                       mov ssp, t1
    1134              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
    1135              ;                       ar0 = *ar6
    1136              ;                       xssp = xar0
    1137              ;                       mov *xar6, xar0
    1138              ;                       mov xar0, xssp  ; stack now points to our TCB
    1139              ;;                      mov sp, *ar6
    1140              ;;                      mov sp, ar0
    1141              ;;                      mov sp, *_pxCurrentTCB
    1142              ;;                      clr ar0
    1143              ;;                      mov ar0, @xar6
    1144              ;;                      mov sp, AR0
    1145              ;;                      add sp, xar6
    1146              
    1147              ;;                      pshboth xar7
    1148              ;;                      pshboth xar6
    1149              ;;                      pshboth xar5
    1150              
    1151              ;;                      popboth xar5
    1152              ;;                      popboth xar6
    1153              ;;                      popboth xar7
    1154              
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   22

    1155              ;;;                     mov *sp(#1), ar7 
    1156              ;                       mov dbl(*sp(#1)), ar7
    1157              ;;;                     mov  ar7, mmap(ST1_55)
    1158                      .if 1
    1159                                      amov #0x000000, xar7
    1160                                      amov #0x000000, xar6
    1161                                  mov dbl (*(#_pxCurrentTCB)), xar7
    1162                                      mov dbl (*ar7), xar6                            ; xsp normal position
    1163                                      add #-3, ar6
    1164                                      mov xar6, xsp                                           ; actual xsp
    1165                                      mov dbl (*ar7(#2)), xar6                        ; xssp
    1166                                      add #-3, ar6
    1167                                      mov xar6, xssp
    1168                  .endif
    1169                                      .if 0
    1170                                      mov *sp(#2), ar7
    1171                                      mov ar7, mmap(ST2_55)
    1172                                      mov ssp, ar7
    1173                                      mov *ar7(#2), ar6
    1174                                      mov ar6, mmap(ST0_55)
    1175                                      .endif
    1176              ;                       mov *ar7(#2), ar6
    1177              ;                       mov ar6, *ssp(#2)
    1178              ;                       mov *ssp(#2), ar7
    1179              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
    1180              
    1181                          amov #0x000000, xar7
    1182                                      amov #0x000000, xar6
    1183                                      .if 0
    1184                                      mov mmap(ST1_55), ar7
    1185                                      and #0xf7ff, ar7                        ; <here>#0800h
    1186                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1187                                      mov ar7, *ar4(#1)                       ; save in TCB
    1188                          amov #0x000000, xar7
    1189                                      mov mmap(ST2_55), ar7
    1190                                      mov ar7, *sp(#2)
    1191                                      mov ar7, *ar4(#2)
    1192                          amov #0x000000, xar7
    1193                          amov #0x000000, xar6
    1194                                      mov ssp, ar7
    1195                                      mov mmap(ST0_55), ar6
    1196                                      mov ar6, *ar7(#2)
    1197                                      mov ar6, *ar3(#2)
    1198                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
    1199                                      mov ar6, *ar7(#1)
    1200              ;                       mov ar6, *ar3(#2)
    1201                                      .endif
    1202              ;                       mov *(#_LOOP_BITS), ar6         ; have to restore this
    1203              ;                       and #0xFF00, ar6
    1204              ;                       mov ar6, *ar7(#2)
    1205              
    1206                                      aadd #-26, sp                           ; to restore
    1207              
    1208                                      amov #0x000000, xar7
    1209                                      mov dbl(*sp(#25)), xar7
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   23

    1210              ;                       mov *sp(#1), ar7
    1211                                      mov xar7, dbl(*(#_usCriticalNesting))
    1212                          amov #0x000000, xar6
    1213                                      mov dbl(*sp(#23)), xar6
    1214              ;                       mov *sp(#3), ar6
    1215              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
    1216                                      mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))
    1217              
    1218              
    1219                                      mov *sp(#0), t0
    1220                                      mov *sp(#1), t1
    1221                                      mov *sp(#2), t2
    1222                                      mov *sp(#3), t3
    1223                                      mov dbl(*sp(#4)), ac0
    1224                                      mov *sp(#5), ac0
    1225                                  mov dbl(*sp(#6)), xar0
    1226                                      mov *sp(#7), ar0
    1227                                      mov dbl(*sp(#8)), xar1
    1228                                      mov *sp(#9), ar1
    1229                                      mov dbl(*sp(#10)), xar2
    1230                                      mov *sp(#11), ar2
    1231                                      mov dbl(*sp(#12)), xar3
    1232                                      mov *sp(#13), ar3
    1233              ;; pvPararmeters currently here - needs to be verified --- jcw
    1234                                      mov dbl(*sp(#14)), xar4
    1235                                      mov *sp(#15), ar4
    1236                                      mov dbl(*sp(#16)), xar5
    1237                                      mov *sp(#17), ar5
    1238                                      mov dbl(*sp(#18)), xar6
    1239                                      mov *sp(#19), ar6
    1240              
    1241              ;                       POP XT
    1242                              ;-- Comment these to save cycles ---
    1243                                      mov dbl(*sp(#20)), xar7
    1244                                      mov *sp(#21), ar7
    1245              
    1246              ;                       mov *sp(#5), ar7
    1247              ;                       mov dbl(*sp(#0)), hi(ar7)
    1248              ;                       mov (*sp(#0)), lo(ar7)
    1249              
    1250              
    1251              ;                       mov dbl(*sp(#21)), *xssp(#0)
    1252              ;                       mov *sp(#21), *ssp
    1253              ;                       mov *sp(#21), RETA
    1254              ; need to move 23-16 to XSSP contents
    1255              ;                       mov xar0, dbl (*(#_save_xar7))
    1256              ;                       mov ssp, ar0
    1257              ;                       mov #0, ssp 
    1258              ;                       mov xssp, xar0
    1259              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
    1260              ;                       aadd #20, sp            ; this is ok - ssp also incremented
    1261                      ;               add #1, xssp            ; 32-bit return address pointer
    1262                      ;               amar *xssp+
    1263              ;                       mov sp, t0
    1264              ;                       add #1, t0
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   24

    1265              ;                       mov t0, ssp
    1266              ;                       incr ssp
    1267              ;                       asub #20, ar0
    1268              ;                       mov xar0, xssp
    1269              ;                       mov ar0, ssp
    1270              ;                       mov ar0, 
    1271              ;;                      mov *sp(#1), t0
    1272              ;;                      mov *sp(#3), t3         ; ST0
    1273              ;;                      mov *sp(#4), t2         ; DBSTAT
    1274              ;;                      mov t3, *ar0(#2)
    1275                      ;;              mov t2, *ar0(#1)
    1276              ;;                      mov t0, *ar0(#0)
    1277              
    1278              ;;                      mov *sp(#5), t0
    1279              ;;                      mov *sp(#6), t1
    1280              ;;                      mov *sp(#7), t2
    1281                      ;;              mov *sp(#8), t3
    1282              
    1283              ; restore ar0
    1284              ;                       mov dbl(*sp(#-2)), xar0
    1285              ;                       mov #-1, ar0
    1286              ;;                      mov dbl (*(#_save_xar7)), xar0
    1287              ;;
    1288              ;;                      mov sp, t0
    1289              ;;                      add #1, t0
    1290              ;;                      mov t0, ssp
    1291              
    1292              ;                       mov *sp(#3), *(#00004ch+#1)
    1293              
    1294              ;                       mov t3, *ssp(#1) 
    1295              ;                       mov t2, *ssp(#2)
    1296              
    1297              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
    1298              ;;                      mov t3, *(ssp(#0))
    1299              ;                       mov t3, *ssp
    1300              ;                       mov *sp(#3), t3 ; 
    1301              ;                       mov t3, *ssp(#1)
    1302              ;;                      mov *sp(#21), PC        
    1303              
    1304              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1305              ;                       mov dbl(xsp), dbl(lcrpc)
    1306              ;                       popboth XAR7
    1307              ;                       add #1, sp
    1308              ;                       add #1, ssp
    1309              ;                       add #2, t0
    1310              ;                       add #2, t1
    1311              ;                       mov t0, sp
    1312              ;                       mov t1, ssp
    1313              ;                       popboth XAR6
    1314              ;                       add #2, t0
    1315              ;                       add #2, t1
    1316              ;                       mov t0, sp
    1317              ;                       mov t1, ssp
    1318              ;                       popboth XAR5
    1319              ;                       add #2, t0
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   25

    1320              ;                       add #2, t1
    1321              ;                       mov t0, sp
    1322              ;                       mov t1, ssp
    1323                              ;-----------------------------------
    1324              ;                       popboth XAR4
    1325              ;                       add #2, t0
    1326              ;                       add #2, t1
    1327              ;                       mov t0, sp
    1328              ;                       mov t1, ssp
    1329              ;                       popboth XAR3
    1330              ;                       add #2, t0
    1331              ;                       add #2, t1
    1332              ;                       mov t0, sp
    1333              ;                       mov t1, ssp
    1334              ;                       popboth XAR2
    1335              ;                       add #2, t0
    1336              ;                       add #2, t1
    1337              ;                       mov t0, sp
    1338              ;                       mov t1, ssp
    1339              ;                       popboth XAR1
    1340              ;                       add #2, t0
    1341              ;                       add #2, t1
    1342              ;                       mov t0, sp
    1343              ;                       mov t1, ssp
    1344              ;                       popboth XAR0
    1345              ;                       add #2, t0
    1346              ;                       add #2, t1
    1347              ;                       mov t0, sp
    1348              ;                       mov t1, ssp
    1349              ;                       EDIS
    1350              ;                       NASP    ; Un-align stack pointer
    1351              ;;                      pop mmap(ST3_55)
    1352              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1353              ;            BCC $2,TC1 ; |216|
    1354                                      .if 0
    1355                                      amov #0x000000, xar7
    1356                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1357              
    1358                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1359                                      mov dbl (*ar7(#2)), xssp                
    1360                                      .endif
    1361              
    1362              ;;                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1363              ;;                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1364              
    1365                                      .if 0
    1366                                      mov dbl (*(_xCompareTCB)), xar6
    1367              ; need to restore our return address
    1368                                      mov xar7, ac0
    1369                          mov xar6, ac1
    1370                              CMPU AC1 != AC0, TC1 ; |1393|
    1371                          BCC $6,TC1 ; |1393|
    1372                          amov #0x000000, xar7
    1373                                      amov #0x000000, xar6
    1374                          mov  *(#_save_new_pxcode), ar7
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   26

    1375                                      mov ar7, *sp(#0)
    1376                          mov *(#_save_new_pxlcode) , ar7
    1377                          mov ssp, ar6
    1378                          mov ar7, *ar6(#0)
    1379              
    1380                          mov dbl (*(#_save_xar6)), xar6
    1381                                      .endif
    1382              
    1383              ;;                      mov dbl (*(#_save_xar7)), xar7
    1384               ;           .if configSTACK_PTR_DEBUG == 1
    1385              ;                       mov xsp, dbl(*(#_restore_xsp))
    1386              ;            mov xssp, dbl(*(#_restore_xssp))
    1387              ;            .endif
    1388              ;                       B $3
    1389              ;$2
    1390              ;            MOV #0, *(#_first_flag) ; |217|
    1391              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1392              ;                       mov dbl (*(#_first_save_xssp)), xssp
    1393              ;$3
    1394              ;;                      mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1395              ;;                      mov xssp, dbl (*(#_save_xssp))                  ; save xssp
    1396              
    1397              ;;                      aadd #-3, sp
    1398              ;;                      mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1399              ;;                      mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
    1400              ;$4
    1401              ;;;            mov dbl(*(#_root_xsp)), xsp
    1402              ;;;                     mov dbl(*(#_root_xssp)), xssp
    1403              
    1404              ;                       aadd #-3, sp
    1405                                      aadd #26, sp
    1406                                      bclr INTM               ; enable interrupts
    1407                                      nop
    1408                                      nop
    1409                                      nop
    1410                                      nop
    1411                                      nop
    1412                                      nop
    1413              ;                       aadd #1, sp
    1414                                      RETI
    1415              ;                       mov #1860h, ssp
    1416                                      nop
    1417                                      nop
    1418              ;                       nop
    1419                                      .endm
    1420              ; /*-----------------------------------------------------------*/
    1421              
    1422              
    1423              
    1424              ; /*-----------------------------------------------------------*/
    1425              
    1426              ; /*
    1427              ; * The RTOS tick ISR.
    1428              ; *
    1429              ; * If the cooperative scheduler is in use this simply increments the tick
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   27

    1430              ; * count.
    1431              ; *
    1432              ; * If the preemptive scheduler is in use a context switch can also occur.
    1433              ; */
    1434              
    1435              
    1436 000000       _xPortStartScheduler:
    1437              
    1438              ;                /* Setup the hardware to generate the tick.  Interrupts are disabled
    1439              ;                when this function is called. */
    1440              
    1441 000000 EB31              mov xsp, dbl(*(#_root_xsp))
         000002 4500 
         000004 0000!
    1442 000006 EB31                          mov xssp, dbl(*(#_root_xssp))
         000008 5500 
         00000a 0000!
    1443              
    1444 00000c 4EFF                 aadd #-1, sp
    1445 00000e 6C00             call    #_prvSetupTimerInterrupt
         000010 0000!
    1446              
    1447              ;                /* Restore the context of the first task that is going to run. */
    1448              
    1449              ;;              INTR INT14      ; force interrupt - just for debug purposes.
    1450              
    1451              ;;            psh mmap(ST3_55)
    1452 000012 EB31                          mov xar7, dbl (*(#_save_xar7))                  ; save xar7
         000014 F500 
         000016 0000!
    1453 000018 EB31                          mov xar6, dbl (*(#_save_xar6))                  ; save xar6
         00001a E500 
         00001c 0000!
    1454              
    1455 00001e EC31                          amov #0x000000, xar7
         000020 FE00 
         000022 0000 
    1456 000024 EC31                          amov #0x000000, xar6
         000026 EE00 
         000028 0000 
    1457              
    1458 00002a ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         00002c FF00 
         00002e 0000!
    1459              ;                       add #0x0064, ar7
    1460              ; does this *always* work?
    1461 000030 EDED                          mov dbl (*ar7(#0)), xar6
         000032 EF00 
         000034 00   
    1462              ;;                      add #0x0064, ar6
    1463              
    1464              ;                       mov xsp, dbl (*(#_save_xsp))
    1465 000035 90E4                          mov xar6, xsp
    1466 000037 EB31                          mov xar6, dbl (*(#_save_xsp))
         000039 E500 
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   28

         00003b 0000!
    1467 00003d EB31                          mov xar6, dbl (*(#_first_save_xsp))     ; (init) xsp contains our TCB now
         00003f E500 
         000041 0000!
    1468                                                                              ; (init) xsp contains our TCB now
    1469 000043 EDED                          mov dbl (*ar7(#2)), xar6
         000045 EF00 
         000047 02   
    1470              ;;                      add #0x0002, ar6
    1471 000048 90E5                          mov xar6, xssp
    1472              ;                       mov xar6, dbl (*(#_save_xsp))
    1473 00004a EB31                          mov xar6, dbl (*(#_save_xssp))
         00004c E500 
         00004e 0000!
    1474 000050 EB31                          mov xar6, dbl (*(#_first_save_xssp))
         000052 E500 
         000054 0000!
    1475              
    1476              ;                       mov #1, *(#_first_flag)
    1477                                      .if 0
    1478                                      amov #0x000000, xar7
    1479                                      amov #0x000000, xar6
    1480                                      mov ssp, ar7
    1481                                      mov *ar7(#2), ar6                               ; this is two away now
    1482                                      mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
    1483                                      .endif
    1484              ; what about xssp here?
    1485 000056 ED31                          mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         000058 FF00 
         00005a 0000!
    1486 00005c ED31                          mov dbl (*(#_save_xar6)), xar6                  ; restore xar6
         00005e EF00 
         000060 0000!
    1487 000062 4E01                          aadd #1, sp
    1488              
    1489                          .if configSTACK_PTR_DEBUG == 1
    1490                                      mov xsp, dbl(*(#_restore_xsp))
    1491                          mov xssp, dbl(*(#_restore_xssp))
    1492                          .endif
    1493              
    1494              
    1495              
    1496 ****** MACRO                         portRESTORE_FIRST_CONTEXT
    1496                                      .C54CM_off
    1496              ;                       .CPL_off
    1496                                      .ARMS_off
    1496                                      .align 4
    1496              
    1496              ; Restore context & return - here we restore into 'root' context
    1496                                      ;CONTEXT_RESTORE
    1496              ;                       ASP
    1496              ;                       EALLOW
    1496              ;                       nop
    1496              ;                       nop
    1496              ;                       nop
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   29

    1496              ;                       nop
    1496 000064 4652                  bclr C54CM
    1496 000066 20                    nop
    1496 000067 20                    nop
    1496 000068 20                    nop
    1496              
    1496              ;               xssp = dbl(*(#_pxCurrentTCB))
    1496              ;               xsp  = dbl(*(#_pxCurrentTCB))
    1496 000069 EB31                          mov xar7, dbl (*(#_save_xar7))  
         00006b F500 
         00006d 0000!
    1496              
    1496              ; ****************************************************************************
    1496              ; * Init Stack Pointer. Remember stack grows from high to low address *
    1496              ; ****************************************************************************
    1496              ;                       stm #_stack, sp ; set to begging of stack memory
    1496              ;                       addm #(_STACK_SIZE  1), *(SP) ; add size to get to the top
    1496              ;                       andm #0FFFEh, *(SP) ; make sure it is an even address
    1496              
    1496 00006f 4EFF                          aadd #-1, sp
    1496              ;            aadd #-3, xsp
    1496              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1496              ;            BCC $1,TC1 ; |216|
    1496              ;                       mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1496              ;                       mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1496              ;            B $4
    1496              
    1496              ;;                      mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1496              ;;                      mov xssp, dbl (*(#_save_xssp))                  ; save xssp
    1496              
    1496              ;                       aadd #-3, sp
    1496              ;$1
    1496              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1496              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
    1496              ;$4
    1496 000071 ED31              mov dbl(*(#_root_xsp)), xsp
         000073 4F00 
         000075 0000!
    1496 000077 ED31                          mov dbl(*(#_root_xssp)), xssp
         000079 5F00 
         00007b 0000!
    1496              
    1496                                      .if 1
    1496              ;;                      mov xsp, xar7
    1496              ;;                      mov xssp, xar6
    1496 00007d EB31                          mov  xsp, dbl (*(#_first_save_xsp))                     ; restore xsp
         00007f 4500 
         000081 0000!
    1496 000083 EB31                          mov  xssp, dbl (*(#_first_save_xssp))
         000085 5500 
         000087 0000!
    1496 000089 EC31                          amov #0x000000, xar2
         00008b AE00 
         00008d 0000 
    1496 00008f EC31                          amov #0x000000, xar1
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   30

         000091 9E00 
         000093 0000 
    1496 000095 EC31                          amov #0x000000, xar3
         000097 BE00 
         000099 0000 
    1496 00009b EC31                          amov #0x000000, xar4
         00009d CE00 
         00009f 0000 
    1496              
    1496 0000a1 ED31                          mov dbl (*(#_pxCurrentTCB)), xar5                               
         0000a3 DF00 
         0000a5 0000!
    1496                                                                                              ;; everything from here is re
    1496 0000a7 EDA1                          mov dbl (*ar5), xar4                            ; xsp contains our TCB now
         0000a9 CF   
    1496 0000aa EDAD                          mov dbl (*ar5(#2)), xar3                        ; xssp          
         0000ac BF00 
         0000ae 02   
    1496 0000af 7BFF                          add #-3, ar4
         0000b1 FDCC 
    1496 0000b3 7BFF                          add #-3, ar3
         0000b5 FDBB 
    1496              
    1496 0000b7 90C4                          mov xar4, xsp
    1496 0000b9 90B5                          mov xar3, xssp
    1496              
    1496              ;;;                     mov *ar4, ar2
    1496              ;;;                     mov *ar3, ar1
    1496              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1496              ;;;                     mov ar2, *ar7
    1496              ;;;                     mov ar1, *ar6
    1496                                      .endif;
    1496              ;                       amov #0x000000, xar7
    1496              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1496              
    1496              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1496              ;                       mov dbl (*ar7(#2)), xssp
    1496                                      .if 1
    1496 0000bb EC31              amov #0x000000, xar7
         0000bd FE00 
         0000bf 0000 
    1496 0000c1 AF06                      mov mmap(ST1_55), ar7
         0000c3 98   
    1496 0000c4 7DF7                          and #0xf7ff, ar7                        ; <here>#0800h
         0000c6 FFFF 
    1496 0000c8 CF02                          mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1496 0000ca CF8D                          mov ar7, *ar4(#1)                       ; save in TCB
         0000cc 0001 
    1496 0000ce AF96                          mov mmap(ST2_55), ar7
         0000d0 98   
    1496 0000d1 CF04                          mov ar7, *sp(#2)
    1496 0000d3 CF8D                          mov ar7, *ar4(#2)
         0000d5 0002 
    1496 0000d7 EC31              amov #0x000000, xar6
         0000d9 EE00 
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   31

         0000db 0000 
    1496 0000dd EC31                          amov #0x000000, xar7
         0000df FE00 
         0000e1 0000 
    1496              
    1496 0000e3 449F                          mov ssp, ar7
    1496 0000e5 AE04                          mov mmap(ST0_55), ar6
         0000e7 98   
    1496 0000e8 CEED                          mov ar6, *ar7(#2)
         0000ea 0002 
    1496 0000ec CE6D                          mov ar6, *ar3(#2)
         0000ee 0002 
    1496                                      
    1496 0000f0 AE31                          mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
         0000f2 0000 
         0000f4 00!  
    1496 0000f5 CEED                          mov ar6, *ar7(#1)
         0000f7 0001 
    1496 0000f9 CE6D                          mov ar6, *ar3(#1)
         0000fb 0001 
    1496              
    1496                                      .endif
    1496              ;                       mov #0, ssp     
    1496              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1496              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1496                                      ; 32-bit mode - will act on SP and SSP:
    1496              ;                       'fix-up' current SP and SSP - is this dangerous????
    1496              ;                       aadd #-3, sp
    1496              ;;                      mov *ar7, *sp
    1496              ;                       mov dbl (*ar7), ar6
    1496              ;                       mov ar6, *sp                            ; xsp contains our TCB now
    1496              ;                       mov *ar7(#2), *ssp                      
    1496              ;                       POP mmap(ST3_55)
    1496              ;                       pshboth xar7                            ; should increment both
    1496                                      .if 0
    1496                                      mov mmap(ST1_55), ar7
    1496                                      and #0xf7ff, ar7                        ; <here>#0800h
    1496                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1496                                      mov mmap(ST2_55), ar7
    1496                                      mov ar7, *sp(#2)
    1496              
    1496                                      mov ssp, ar7
    1496                                      mov mmap(ST0_55), ar6
    1496                                      mov ar6, *ar7(#2)
    1496                                      .endif
    1496              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
    1496              ;;                      mov ar6, *ar7(#1)
    1496              
    1496                                      .if 0
    1496                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1496              
    1496                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1496                                      mov dbl (*ar7(#2)), xssp        
    1496                                      .endif
    1496              
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   32

    1496                                      .if 0                                           ; first task - no pxcode update
    1496                                          mov dbl (*(_xCompareTCB)), xar6
    1496              ; need to restore our return address
    1496                                          mov xar7, ac0
    1496                                          mov xar6, ac1
    1496                                          CMPU AC1 != AC0, TC1 ; |1393|
    1496                                          BCC $7,TC1 ; |1393|
    1496                                          amov #0x000000, xar7
    1496                                          amov #0x000000, xar6
    1496                                          mov  *(#_save_new_pxcode), ar7
    1496                                          mov ar7, *sp(#0)
    1496                                          mov *(#_save_new_pxlcode) , ar7
    1496                                          mov ssp, ar6
    1496                                          mov ar7, *ar6(#0)
    1496              
    1496                                          mov dbl (*(#_save_xar6)), xar6
    1496                                          .endif
    1496 0000fd       $7_$1$:
    1496              
    1496              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
    1496              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1496                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
    1496                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1496                                      mov xar6, dbl (*(#_save_xar6))
    1496              
    1496              ;; this is for debug
    1496                                      mov dbl(*ar7), xar6
    1496                                      mov dbl(*ar6), xar7
    1496                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
    1496                                      mov xssp, xar7
    1496                                      mov dbl(*ar7), xar6
    1496                                      mov dbl(*ar6), xar7
    1496                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
    1496                                      mov xssp, xar7
    1496                                      add #-2, ar7
    1496                                      mov dbl(*ar7), xar6
    1496                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
    1496                                      mov dbl (*(#_save_xar6)), xar6
    1496                                      
    1496                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1496                                      .endif
    1496              
    1496              ;                       mov mmap(ST0_55), *ssp(#1)
    1496              ;                       mov mmap(STO_55), *ssp(#2)
    1496              ;                       mov mmap(ST1_55), *sp(#1)
    1496              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
    1496              ;                       mov *ar7, t0
    1496              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
    1496              ;                       mov *ar7(#2), t0
    1496              ;                       mov t0, *ssp(#0)                        
    1496              
    1496              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
    1496              ; what about xssp?
    1496              ;                       mov xar6, xsp
    1496              ;                       mov xssp, xar7
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   33

    1496              ;                       add #1, ar7
    1496              ;                       mov xar7, xsp
    1496              ;                       mov sp, t0
    1496              ;                       mov ssp, t1
    1496              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
    1496              ;                       ar0 = *ar6
    1496              ;                       xssp = xar0
    1496              ;                       mov *xar6, xar0
    1496              ;                       mov xar0, xssp  ; stack now points to our TCB
    1496              ;;                      mov sp, *ar6
    1496              ;;                      mov sp, ar0
    1496              ;;                      mov sp, *_pxCurrentTCB
    1496              ;;                      clr ar0
    1496              ;;                      mov ar0, @xar6
    1496              ;;                      mov sp, AR0
    1496              ;;                      add sp, xar6
    1496              
    1496              ;;                      pshboth xar7
    1496              ;;                      pshboth xar6
    1496              ;;                      pshboth xar5
    1496              
    1496              ;;                      popboth xar5
    1496              ;;                      popboth xar6
    1496              ;;                      popboth xar7
    1496              
    1496              ;;;                     mov *sp(#1), ar7 
    1496              ;                       mov dbl(*sp(#1)), ar7
    1496              ;;;                     mov  ar7, mmap(ST1_55)
    1496                      .if 1
    1496 0000fd EC31                          amov #0x000000, xar7
         0000ff FE00 
         000101 0000 
    1496 000103 EC31                          amov #0x000000, xar6
         000105 EE00 
         000107 0000 
    1496 000109 ED31                      mov dbl (*(#_pxCurrentTCB)), xar7
         00010b FF00 
         00010d 0000!
    1496 00010f EDE1                          mov dbl (*ar7), xar6                            ; xsp normal position
         000111 EF   
    1496 000112 7BFF                          add #-3, ar6
         000114 FDEE 
    1496 000116 90E4                          mov xar6, xsp                                           ; actual xsp
    1496 000118 EDED                          mov dbl (*ar7(#2)), xar6                        ; xssp
         00011a EF00 
         00011c 02   
    1496 00011d 7BFF                          add #-3, ar6
         00011f FDEE 
    1496 000121 90E5                          mov xar6, xssp
    1496                  .endif
    1496                                      .if 0
    1496                                      mov *sp(#2), ar7
    1496                                      mov ar7, mmap(ST2_55)
    1496                                      mov ssp, ar7
    1496                                      mov *ar7(#2), ar6
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   34

    1496                                      mov ar6, mmap(ST0_55)
    1496                                      .endif
    1496              ;                       mov *ar7(#2), ar6
    1496              ;                       mov ar6, *ssp(#2)
    1496              ;                       mov *ssp(#2), ar7
    1496              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
    1496              
    1496 000123 EC31              amov #0x000000, xar7
         000125 FE00 
         000127 0000 
    1496 000129 EC31                          amov #0x000000, xar6
         00012b EE00 
         00012d 0000 
    1496                                      .if 0
    1496                                      mov mmap(ST1_55), ar7
    1496                                      and #0xf7ff, ar7                        ; <here>#0800h
    1496                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1496                                      mov ar7, *ar4(#1)                       ; save in TCB
    1496                          amov #0x000000, xar7
    1496                                      mov mmap(ST2_55), ar7
    1496                                      mov ar7, *sp(#2)
    1496                                      mov ar7, *ar4(#2)
    1496                          amov #0x000000, xar7
    1496                          amov #0x000000, xar6
    1496                                      mov ssp, ar7
    1496                                      mov mmap(ST0_55), ar6
    1496                                      mov ar6, *ar7(#2)
    1496                                      mov ar6, *ar3(#2)
    1496                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
    1496                                      mov ar6, *ar7(#1)
    1496              ;                       mov ar6, *ar3(#2)
    1496                                      .endif
    1496              ;                       mov *(#_LOOP_BITS), ar6         ; have to restore this
    1496              ;                       and #0xFF00, ar6
    1496              ;                       mov ar6, *ar7(#2)
    1496              
    1496 00012f 4EE6                          aadd #-26, sp                           ; to restore
    1496              
    1496 000131 EC31                          amov #0x000000, xar7
         000133 FE00 
         000135 0000 
    1496 000137 ED32                          mov dbl(*sp(#25)), xar7
         000139 FF   
    1496              ;                       mov *sp(#1), ar7
    1496 00013a EB31                          mov xar7, dbl(*(#_usCriticalNesting))
         00013c F500 
         00013e 0000!
    1496 000140 EC31              amov #0x000000, xar6
         000142 EE00 
         000144 0000 
    1496 000146 ED2E                          mov dbl(*sp(#23)), xar6
         000148 EF   
    1496              ;                       mov *sp(#3), ar6
    1496              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
    1496 000149 EB31                          mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   35

         00014b E500 
         00014d 0000!
    1496              
    1496              
    1496 00014f A400                          mov *sp(#0), t0
    1496 000151 A502                          mov *sp(#1), t1
    1496 000153 A604                          mov *sp(#2), t2
    1496 000155 A706                          mov *sp(#3), t3
    1496 000157 ED08                          mov dbl(*sp(#4)), ac0
         000159 08   
    1496 00015a A00A                          mov *sp(#5), ac0
    1496 00015c ED0C                      mov dbl(*sp(#6)), xar0
         00015e 8F   
    1496 00015f A80E                          mov *sp(#7), ar0
    1496 000161 ED10                          mov dbl(*sp(#8)), xar1
         000163 9F   
    1496 000164 A912                          mov *sp(#9), ar1
    1496 000166 ED14                          mov dbl(*sp(#10)), xar2
         000168 AF   
    1496 000169 AA16                          mov *sp(#11), ar2
    1496 00016b ED18                          mov dbl(*sp(#12)), xar3
         00016d BF   
    1496 00016e AB1A                          mov *sp(#13), ar3
    1496              ;; pvPararmeters currently here - needs to be verified --- jcw
    1496 000170 ED1C                          mov dbl(*sp(#14)), xar4
         000172 CF   
    1496 000173 AC1E                          mov *sp(#15), ar4
    1496 000175 ED20                          mov dbl(*sp(#16)), xar5
         000177 DF   
    1496 000178 AD22                          mov *sp(#17), ar5
    1496 00017a ED24                          mov dbl(*sp(#18)), xar6
         00017c EF   
    1496 00017d AE26                          mov *sp(#19), ar6
    1496              
    1496              ;                       POP XT
    1496                              ;-- Comment these to save cycles ---
    1496 00017f ED28                          mov dbl(*sp(#20)), xar7
         000181 FF   
    1496 000182 AF2A                          mov *sp(#21), ar7
    1496              
    1496              ;                       mov *sp(#5), ar7
    1496              ;                       mov dbl(*sp(#0)), hi(ar7)
    1496              ;                       mov (*sp(#0)), lo(ar7)
    1496              
    1496              
    1496              ;                       mov dbl(*sp(#21)), *xssp(#0)
    1496              ;                       mov *sp(#21), *ssp
    1496              ;                       mov *sp(#21), RETA
    1496              ; need to move 23-16 to XSSP contents
    1496              ;                       mov xar0, dbl (*(#_save_xar7))
    1496              ;                       mov ssp, ar0
    1496              ;                       mov #0, ssp 
    1496              ;                       mov xssp, xar0
    1496              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
    1496              ;                       aadd #20, sp            ; this is ok - ssp also incremented
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   36

    1496                      ;               add #1, xssp            ; 32-bit return address pointer
    1496                      ;               amar *xssp+
    1496              ;                       mov sp, t0
    1496              ;                       add #1, t0
    1496              ;                       mov t0, ssp
    1496              ;                       incr ssp
    1496              ;                       asub #20, ar0
    1496              ;                       mov xar0, xssp
    1496              ;                       mov ar0, ssp
    1496              ;                       mov ar0, 
    1496              ;;                      mov *sp(#1), t0
    1496              ;;                      mov *sp(#3), t3         ; ST0
    1496              ;;                      mov *sp(#4), t2         ; DBSTAT
    1496              ;;                      mov t3, *ar0(#2)
    1496                      ;;              mov t2, *ar0(#1)
    1496              ;;                      mov t0, *ar0(#0)
    1496              
    1496              ;;                      mov *sp(#5), t0
    1496              ;;                      mov *sp(#6), t1
    1496              ;;                      mov *sp(#7), t2
    1496                      ;;              mov *sp(#8), t3
    1496              
    1496              ; restore ar0
    1496              ;                       mov dbl(*sp(#-2)), xar0
    1496              ;                       mov #-1, ar0
    1496              ;;                      mov dbl (*(#_save_xar7)), xar0
    1496              ;;
    1496              ;;                      mov sp, t0
    1496              ;;                      add #1, t0
    1496              ;;                      mov t0, ssp
    1496              
    1496              ;                       mov *sp(#3), *(#00004ch+#1)
    1496              
    1496              ;                       mov t3, *ssp(#1) 
    1496              ;                       mov t2, *ssp(#2)
    1496              
    1496              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
    1496              ;;                      mov t3, *(ssp(#0))
    1496              ;                       mov t3, *ssp
    1496              ;                       mov *sp(#3), t3 ; 
    1496              ;                       mov t3, *ssp(#1)
    1496              ;;                      mov *sp(#21), PC        
    1496              
    1496              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1496              ;                       mov dbl(xsp), dbl(lcrpc)
    1496              ;                       popboth XAR7
    1496              ;                       add #1, sp
    1496              ;                       add #1, ssp
    1496              ;                       add #2, t0
    1496              ;                       add #2, t1
    1496              ;                       mov t0, sp
    1496              ;                       mov t1, ssp
    1496              ;                       popboth XAR6
    1496              ;                       add #2, t0
    1496              ;                       add #2, t1
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   37

    1496              ;                       mov t0, sp
    1496              ;                       mov t1, ssp
    1496              ;                       popboth XAR5
    1496              ;                       add #2, t0
    1496              ;                       add #2, t1
    1496              ;                       mov t0, sp
    1496              ;                       mov t1, ssp
    1496                              ;-----------------------------------
    1496              ;                       popboth XAR4
    1496              ;                       add #2, t0
    1496              ;                       add #2, t1
    1496              ;                       mov t0, sp
    1496              ;                       mov t1, ssp
    1496              ;                       popboth XAR3
    1496              ;                       add #2, t0
    1496              ;                       add #2, t1
    1496              ;                       mov t0, sp
    1496              ;                       mov t1, ssp
    1496              ;                       popboth XAR2
    1496              ;                       add #2, t0
    1496              ;                       add #2, t1
    1496              ;                       mov t0, sp
    1496              ;                       mov t1, ssp
    1496              ;                       popboth XAR1
    1496              ;                       add #2, t0
    1496              ;                       add #2, t1
    1496              ;                       mov t0, sp
    1496              ;                       mov t1, ssp
    1496              ;                       popboth XAR0
    1496              ;                       add #2, t0
    1496              ;                       add #2, t1
    1496              ;                       mov t0, sp
    1496              ;                       mov t1, ssp
    1496              ;                       EDIS
    1496              ;                       NASP    ; Un-align stack pointer
    1496              ;;                      pop mmap(ST3_55)
    1496              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1496              ;            BCC $2,TC1 ; |216|
    1496                                      .if 0
    1496                                      amov #0x000000, xar7
    1496                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1496              
    1496                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1496                                      mov dbl (*ar7(#2)), xssp                
    1496                                      .endif
    1496              
    1496              ;;                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1496              ;;                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1496              
    1496                                      .if 0
    1496                                      mov dbl (*(_xCompareTCB)), xar6
    1496              ; need to restore our return address
    1496                                      mov xar7, ac0
    1496                          mov xar6, ac1
    1496                              CMPU AC1 != AC0, TC1 ; |1393|
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   38

    1496                          BCC $6,TC1 ; |1393|
    1496                          amov #0x000000, xar7
    1496                                      amov #0x000000, xar6
    1496                          mov  *(#_save_new_pxcode), ar7
    1496                                      mov ar7, *sp(#0)
    1496                          mov *(#_save_new_pxlcode) , ar7
    1496                          mov ssp, ar6
    1496                          mov ar7, *ar6(#0)
    1496              
    1496                          mov dbl (*(#_save_xar6)), xar6
    1496                                      .endif
    1496              
    1496              ;;                      mov dbl (*(#_save_xar7)), xar7
    1496               ;           .if configSTACK_PTR_DEBUG == 1
    1496              ;                       mov xsp, dbl(*(#_restore_xsp))
    1496              ;            mov xssp, dbl(*(#_restore_xssp))
    1496              ;            .endif
    1496              ;                       B $3
    1496              ;$2
    1496              ;            MOV #0, *(#_first_flag) ; |217|
    1496              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1496              ;                       mov dbl (*(#_first_save_xssp)), xssp
    1496              ;$3
    1496              ;;                      mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1496              ;;                      mov xssp, dbl (*(#_save_xssp))                  ; save xssp
    1496              
    1496              ;;                      aadd #-3, sp
    1496              ;;                      mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1496              ;;                      mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
    1496              ;$4
    1496              ;;;            mov dbl(*(#_root_xsp)), xsp
    1496              ;;;                     mov dbl(*(#_root_xssp)), xssp
    1496              
    1496              ;                       aadd #-3, sp
    1496 000184 4E1A                          aadd #26, sp
    1496 000186 46B2                          bclr INTM               ; enable interrupts
    1496 000188 20                            nop
    1496 000189 20                            nop
    1496 00018a 20                            nop
    1496 00018b 20                            nop
    1496 00018c 20                            nop
    1496 00018d 20                            nop
    1496              ;                       aadd #1, sp
    1496 00018e 4805                          RETI
    1496              ;                       mov #1860h, ssp
    1496 000190 20                            nop
    1496 000191 20                            nop
    1496              ;                       nop
    1497              
    1498              
    1499 000192       _vTickISR:              ; the timer ISR is aggregated for this processor architecture
    1500               ;               bclr IFR0.IF4          ; enable interrupts
    1501 000192 F406          AND #0xf91f, mmap(ST1_55)
         000194 F91F 
         000196 98   
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   39

    1502 000197 F506          OR #0x4100, mmap(ST1_55)
         000199 4100 
         00019b 98   
    1503 00019c F496          AND #0xfa00, mmap(ST2_55)
         00019e FA00 
         0001a0 98   
    1504 0001a1 F596          OR #0x8000, mmap(ST2_55)
         0001a3 8000 
         0001a5 98   
    1505 0001a6 4EFF          aadd #-1, sp
    1506              
    1507                          .if 0
    1508                                                  mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1509                                      mov xar6, dbl (*(#_save_xar6))                  ; save x
    1510              
    1511                                                              amov #0x000000, xar7
    1512                                                              amov #0x000000, xar6
    1513              
    1514              
    1515                                      mov *sp(#0), ar7                                            ;; sp+3
    1516                                      mov ar7, *(#_save_new_pxcode)
    1517                                      mov ssp, ar6
    1518                                      mov *ar6(#0), ar7                                                       ;; ssp+3
    1519                                      mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and i
    1520                                      amov #0x000000, xar7
    1521                                      mov *ar6(#1), ar7                               ; this is two away now
    1522                                                              mov ar7, *(#_DBSTAT_SAVE)
    1523                                   ;   nop
    1524                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1525                                      mov xar7, dbl(*(#_xCompareTCB))
    1526                                      .endif
    1527              
    1528                                                      .if 0
    1529              
    1530                                   PSH mmap(@ST3_55)
    1531                                   AND #30976,mmap(@ST1_55)
    1532                                   BSET ST2_ARMS
    1533                                   BSET ST1_CPL
    1534                                   BSET ST3_SMUL
    1535                                   BSET ST1_SXMD
    1536                                               BCLR ST3_SATA
    1537                                               BCLR ST3_SST
    1538                                   AND #64000,mmap(@ST2_55)
    1539                                   PSHBOTH XAR0
    1540                                   PSHBOTH XAR1
    1541                                   PSHBOTH XAR2
    1542                                   PSHBOTH XAR3
    1543                                   PSHBOTH XAR4
    1544                                   PSH T0,T1
    1545                                   PSH mmap(@AC0G)
    1546                                   PSHBOTH AC0
    1547                                   PSH mmap(@AC1G)
    1548                                   PSHBOTH AC1
    1549                                   PSH mmap(@AC2G)
    1550                                   PSHBOTH AC2
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   40

    1551                                   PSH mmap(@AC3G)
    1552                                   PSHBOTH AC3
    1553                                   PSH mmap(@BRS1)
    1554                                   PSH mmap(@BRC1)
    1555                                   PSH mmap(@TRN0)
    1556                                   PSH mmap(@RPTC)
    1557                                   PSH mmap(@BK03)
    1558                                   PSH mmap(@BRC0)
    1559                                   PSH mmap(@CDP)
    1560                                   PSH mmap(@DPH)
    1561                                   AMAR *(#0002eh),XAR1               ; cpu st3_55
    1562                                   RPT #10            ;       repeats next 10 times
    1563                                   PSH dbl(*AR1+)
    1564                                   PSH mmap(@CDPH)
    1565                                   PSHBOTH XAR5
    1566                                   MOV XSP,XAR5                       ; xsp
    1567                                   AND #65534,mmap(@SP)               ; SP alignment (?)
    1568                                                      .endif
    1569                                                                      ;;
    1570 0001a8 E651                  MOV #0, *port(#6166) ; |119|
         0001aa 0018 
         0001ac 16   
    1571 0001ad F402                  AND #0x0010, mmap(@IFR0)
         0001af 0010 
         0001b1 98   
    1572 0001b2 46B3                  bset INTM
    1573 0001b4 20                    nop
    1574 0001b5 20                    nop
    1575 0001b6 20                    nop
    1576 0001b7 20                    nop
    1577 0001b8 20                    nop
    1578 0001b9 20                    nop
    1579              
    1580              ;           MOV *port(#7188), AR1 ; |68|                ;; TIMER0 is only timer that is active
    1581              ;        BSET @#0, AR1 ; |68|
    1582              ;        BCC $1,AR1 == #0 ; |68|
    1583              ;        AND #0x0010, *(#1)
    1584              ;               bset INTM               ; disable interrupts
    1585                              .if configUSE_TICK_CTR == 1
    1586 0001ba F731                  add #1, *(#_tickIRQctr)
         0001bc 0001 
         0001be 0000 
         0001c0 00!  
    1587                              .endif
    1588              ;;              psh mmap(ST3_55)
    1589                  .if 1
    1590 0001c1 EB31                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
         0001c3 F500 
         0001c5 0000!
    1591 0001c7 EB31                          mov xar6, dbl (*(#_save_xar6))                  ; save x
         0001c9 E500 
         0001cb 0000!
    1592 0001cd EC31                                                  amov #0x000000, xar7
         0001cf FE00 
         0001d1 0000 
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   41

    1593 0001d3 EC31                                                  amov #0x000000, xar6
         0001d5 EE00 
         0001d7 0000 
    1594              
    1595 0001d9 AF02                          mov *sp(#1), ar7                                            ;; sp+3
    1596 0001db CF31                          mov ar7, *(#_save_new_pxcode)
         0001dd 0000 
         0001df 00!  
    1597 0001e0 449E                          mov ssp, ar6
    1598 0001e2 AFCD                          mov *ar6(#1), ar7                                                       ;; ssp+3
         0001e4 0001 
    1599 0001e6 CF31                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and i
         0001e8 0000 
         0001ea 00!  
    1600 0001eb EC31                          amov #0x000000, xar7
         0001ed FE00 
         0001ef 0000 
    1601 0001f1 AFCD                          mov *ar6(#2), ar7                               ; this is two away now
         0001f3 0002 
    1602 0001f5 CF31                                                  mov ar7, *(#_DBSTAT_SAVE)               ;; this is just for r
         0001f7 0000 
         0001f9 00!  
    1603                                   ;   nop
    1604 0001fa ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         0001fc FF00 
         0001fe 0000!
    1605 000200 EB31                          mov xar7, dbl(*(#_xCompareTCB))
         000202 F500 
         000204 0000!
    1606                                      .endif
    1607                      .if 0
    1608                      ;               mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1609                  ;        mov xar6, dbl (*(#_save_xar6))
    1610                                      amov #0x000000, xar7
    1611                                      amov #0x000000, xar6
    1612                                      mov ssp, ar7
    1613                                      mov *ar7(#2), ar6                               ; this is two away now
    1614                                      mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
    1615                                      .endif
    1616                          ;;            mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1617                          ;;            mov dbl (*(#_save_xar6)), xar6                  ; restore xar6
    1618              ;;              mov xsp, dbl (*(#_save_xsp))
    1619              ;;              mov xssp, dbl (*(#_save_xssp))
    1620                                      .if configSTACK_PTR_DEBUG == 1
    1621                                      mov xsp, dbl(*(#_Ssave_xsp))
    1622                          mov xssp, dbl(*(#_Ssave_xssp))
    1623                          .endif
    1624              ;;;        aadd #1, sp
    1625 ****** MACRO         portSAVE_CONTEXT
    1625              ;                       ;CONTEXT_SAVE
    1625              ;                       ASP  ; Align Stack Pointer
    1625              ;                       CLRC       OVM,PAGE0
    1625              ;                       CLRC       AMODE
    1625              ;                       EALLOW
    1625 000206 4652                  bclr C54CM      ; temp - until we figure out what is setting this
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   42

    1625              ;;;             bset INTM               ; disable interrupts - already done
    1625              ;                       aadd #1, sp
    1625 000208 20                            nop
    1625 000209 20                            nop
    1625 00020a 20                            nop
    1625              
    1625 00020b EB31                          mov xsp,  dbl (*(#_Ssave_xsp))                  ; save xsp
         00020d 4500 
         00020f 0000!
    1625 000211 EB31                          mov xssp, dbl (*(#_Ssave_xssp))                 ; save xssp
         000213 5500 
         000215 0000!
    1625              ;;;                     mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1625              ;;;                     mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1625              
    1625              ;                       pshboth xar7
    1625              ;                       pshboth xar6
    1625              ;                       pshboth xar5
    1625              
    1625              ;;;;                    mov xar7, dbl (*(#_save_xar7))                  ; save xar7 (already saved)
    1625              ;                       .if configUSE_CONTEXT_DEBUG == 1
    1625              ;;;;                    mov xar6, dbl (*(#_save_xar6))                  ; saved in vTick ISR already
    1625              ;                       .endif
    1625 000217 4E01                          aadd #1, sp
    1625              ; +++===+++
    1625              
    1625                                      .if 1                                                           ; need to figure out 
    1625 000219 EB31                          mov xar1, dbl (*(#_save_xar1))
         00021b 9500 
         00021d 0000!
    1625 00021f EB31                          mov xar2, dbl (*(#_save_xar2))
         000221 A500 
         000223 0000!
    1625 000225 EB31                          mov xar3, dbl (*(#_save_xar3))
         000227 B500 
         000229 0000!
    1625 00022b EB31                          mov xar4, dbl (*(#_save_xar4))
         00022d C500 
         00022f 0000!
    1625 000231 EC31                          amov #0x000000, xar5
         000233 DE00 
         000235 0000 
    1625 000237 EC31                          amov #0x000000, xar6
         000239 EE00 
         00023b 0000 
    1625 00023d 904D                          mov xsp, xar5
    1625 00023f 905E                          mov xssp, xar6
    1625 000241 EC31                          amov #0x000000, xar2
         000243 AE00 
         000245 0000 
    1625 000247 EC31                          amov #0x000000, xar1
         000249 9E00 
         00024b 0000 
    1625 00024d EC31                          amov #0x000000, xar3
         00024f BE00 
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   43

         000251 0000 
    1625 000253 EC31                          amov #0x000000, xar4
         000255 CE00 
         000257 0000 
    1625 000259 ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         00025b FF00 
         00025d 0000!
    1625              
    1625 00025f EDE1                          mov dbl (*ar7), xar4                            ; xsp contains our TCB now
         000261 CF   
    1625 000262 EDED                          mov dbl (*ar7(#2)), xar3
         000264 BF00 
         000266 02   
    1625 000267 7BFF                          add #-3, ar4
         000269 FDCC 
    1625 00026b 7BFF                          add #-3, ar3
         00026d FDBB 
    1625              
    1625 00026f AAAD                          mov *ar5(#0), ar2                               ; current xsp contents
         000271 0000 
    1625 000273 A9CD                          mov *ar6(#0), ar1                               ; current xssp contents
         000275 0000 
    1625              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1625 000277 CA81                          mov ar2, *ar4                           ; saves our new PC - but, does this work in e
    1625 000279 C961                          mov ar1, *ar3
    1625                                      .endif
    1625              ;;                      aadd #1, sp
    1625                                      .if 0
    1625                          amov #0x000000, xar7
    1625                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1625                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1625                                      mov dbl (*ar7(#2)), xssp
    1625                          amov #0x000000, xar7
    1625                                      amov #0x000000, xar6
    1625                          mov *(#_save_new_pxcode), ar7
    1625                          mov ar7, *sp(#0)
    1625                          amov #0x000000, xar7
    1625                          mov ssp, ar6
    1625                          mov *(#_save_new_pxlcode), ar7
    1625              ;            mov ar7, *ssp(#0)
    1625                          mov ar7, *ar6(#0)
    1625                              .endif
    1625              
    1625              ;                       mov ssp, ar7
    1625              ;                       mov *ar7(#1), ar6                               ; this is (one)two away now
    1625              ;                       mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
    1625              ;                       .endif
    1625              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1625              ;            mov xar6, dbl (*(#_save_xar6))                  ; save x
    1625                                      .if 0
    1625                                      amov #0x000000, xar7
    1625                                      amov #0x000000, xar6
    1625                          mov *sp(#0), ar7                                            ;; sp+3
    1625                          mov ar7, *(#_save_new_pxcode)
    1625                          mov ssp, ar6
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   44

    1625                          mov *ar6(#1), ar7                                                       ;; ssp+3
    1625                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and if a task, it
    1625                                   ;   nop
    1625                          mov dbl (*(#_pxCurrentTCB)), xar7
    1625                          mov xar7, dbl(*(#_xCompareTCB))
    1625                          .endif
    1625              ; +++===+++
    1625              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1625              ;
    1625              
    1625              
    1625              ; +++===+++
    1625                                      .if 0
    1625              ;                       mov dbl (*(_xCompareTCB)), xar6                 ; need to save our return address
    1625              ;                       mov xar7, ac0
    1625              ;               mov xar6, ac1
    1625              ;                       CMPU AC1 != AC0, TC1
    1625              ;                               BCC $5,TC1
    1625                                      amov #0x000000, xar7
    1625                                          amov #0x000000, xar6
    1625                                          mov  *(#_save_new_pxcode), ar7
    1625                                          mov ar7, *sp(#0)
    1625                              mov *(#_save_new_pxlcode) , ar7
    1625                              mov ssp, ar6
    1625                              mov ar7, *ar6(#0)
    1625                              mov dbl (*(#_save_xar6)), xar6
    1625                                         .endif
    1625              ; +++===+++
    1625 00027b       $5_$2$:
    1625                                              
    1625              ; +++===+++
    1625              ;; what about xssp here?
    1625              ;;                              mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1625              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1625                                 .if configUSE_CONTEXT_DEBUG == 1
    1625              ;; save current PC (and possible loop bits values)
    1625              ;; for debug - to see if this is being corrupted
    1625                                      mov dbl(*ar7), xar6
    1625                                      mov dbl(*ar6), xar7
    1625                                      mov xar7, dbl (*(#_PC_REG_LOW_SAVE))            ; save off the PC
    1625                                      mov xssp, xar7
    1625                                      mov dbl(*ar7), xar6
    1625                                      mov dbl(*ar6), xar7
    1625                                      mov xar7, dbl (*(#_PC_REG_HIGH_SAVE))           ; save off the PC
    1625                                      mov xssp, xar7
    1625                                      add #-2, ar7
    1625                                      mov dbl(*ar7), xar6
    1625                                      mov xar6,  dbl (*(_DBSTAT_SAVE))
    1625                          mov dbl (*(#_save_xar6)), xar6
    1625              
    1625              ;            mov (*ar7), (*(#_PC_REG_LOW_SAVE))
    1625              ;            mov dbl(*xssp),(*(#_PC_REG_HIGH_SAVE))
    1625              ;                       mov (*ssp(#-2)), (*(#_DBSTAT_SAVE))
    1625                                      .endif
    1625              ; +++===+++
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   45

    1625                                      ; save context in our stack(s) frame
    1625              
    1625              ;;;;                    mov dbl (*(#_pxCurrentTCB)), xar7
    1625              ;;;                     mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1625              ;;;                     mov dbl (*ar7(#2)), xssp
    1625              ; +++===+++
    1625              ;                   mov dbl (*(#_pxCurrentTCB)), xar7
    1625                                  ; add #0x0064, ar7
    1625              ;                       mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
    1625              ;                       mov dbl (*ar7(#2)), xssp
    1625              ;           add #0x0064, ar4
    1625              ;                       add #0x0064, ar3
    1625              ;                       mov dbl (*ar5), xar4                            ; xsp contains our TCB now
    1625              ;                       mov dbl (*ar5(#2)), xar3                        ; xssp
    1625              ;                       add #0x0064, ar4
    1625              ;                       add #0x0064, ar3
    1625 00027b EC31                  amov #0x000000, xar7
         00027d FE00 
         00027f 0000 
    1625 000281 EC31                          amov #0x000000, xar6
         000283 EE00 
         000285 0000 
    1625 000287 ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         000289 FF00 
         00028b 0000!
    1625 00028d EDE1                          mov dbl (*ar7), xar6                            ; xsp normal position
         00028f EF   
    1625 000290 7BFF                          add #-3, ar6
         000292 FDEE 
    1625 000294 90E4                          mov xar6, xsp                                           ; actual xsp
    1625 000296 EDED                          mov dbl (*ar7(#2)), xar6                        ; xssp
         000298 EF00 
         00029a 02   
    1625 00029b 7BFF                          add #-3, ar6
         00029d FDEE 
    1625 00029f 90E5                          mov xar6, xssp
    1625              
    1625 0002a1 ED31              mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         0002a3 FF00 
         0002a5 0000!
    1625 0002a7 ED31              mov dbl (*(#_save_xar6)), xar6
         0002a9 EF00 
         0002ab 0000!
    1625              ;            mov dbl (*(#_save_xar1)), xar1                  ; restore xar7
    1625              ;            mov dbl (*(#_save_xar2)), xar2
    1625              ;            mov dbl (*(#_save_xar3)), xar3                  ; restore xar7
    1625              ;            mov dbl (*(#_save_xar4)), xar4
    1625                                        ; restore xar6
    1625              ;;; begin context save:
    1625 0002ad 4EE6                          aadd #-26, sp
    1625              
    1625 0002af EB28                          mov xar7, dbl(*sp(#20))                         ; save xar7
         0002b1 F5   
    1625 0002b2 CF2A                          mov ar7, *sp(#21)
    1625              
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   46

    1625 0002b4 EB24                          mov xar6, dbl(*sp(#18))
         0002b6 E5   
    1625 0002b7 CE26                          mov ar6, *sp(#19)
    1625              
    1625 0002b9 EB20                          mov xar5, dbl(*sp(#16))
         0002bb D5   
    1625 0002bc CD22                          mov ar5, *sp(#17)
    1625              
    1625 0002be EB1C                          mov xar4, dbl(*sp(#14))
         0002c0 C5   
    1625 0002c1 CC1E                          mov ar4, *sp(#15)
    1625              
    1625 0002c3 EB18                          mov xar3, dbl(*sp(#12))
         0002c5 B5   
    1625 0002c6 CB1A                          mov ar3, *sp(#13)
    1625              
    1625 0002c8 EB14                          mov xar2, dbl(*sp(#10))
         0002ca A5   
    1625 0002cb CA16                          mov ar2, *sp(#11)
    1625              
    1625 0002cd EB10                          mov xar1, dbl(*sp(#8))
         0002cf 95   
    1625 0002d0 C912                          mov ar1, *sp(#9)
    1625              
    1625 0002d2 EB0C                          mov xar0, dbl(*sp(#6))
         0002d4 85   
    1625 0002d5 C80E                          mov ar0, *sp(#7)
    1625              
    1625 0002d7 EB08                          mov  ac0, dbl(*sp(#4))
         0002d9 08   
    1625 0002da C00A                          mov ac0, *sp(#5)
    1625              
    1625 0002dc C706                          mov t3, *sp(#3)
    1625 0002de C604                          mov t2, *sp(#2)
    1625 0002e0 C502                          mov t1, *sp(#1)
    1625 0002e2 C400                          mov t0, *sp(#0)
    1625              ; +++===+++
    1625              ;;                      mov mmap(ST0_55), t0
    1625              ; - this is ok - we are not pushing - it's a relative stack frame
    1625              ;                       mov t0, *sp(#25)
    1625              ;;                      mov t0, *sp(#23)
    1625              ;;                      mov mmap(ST1_55), t1
    1625              ;                       mov t1, *sp(#26)                ; stomping on own mem
    1625              ;;                      mov t1, *sp(#21)                ; stomping on own mem
    1625              ;;                      mov mmap(ST2_55), t2
    1625              ;;                      mov t2, *sp(#22)
    1625              ;                       mov t2, *sp(#27)
    1625              ;;                      mov mmap(ST2_55), t3
    1625              ;                       mov t3, *sp(#28)
    1625              ;;                      mov t3, *sp(#24)
    1625              
    1625              ;                       PSH dbl(AR0) ; 32-bit
    1625              ;                       PSH dbl(AR1) 
    1625              ;                       PSH dbl(AR2) ; 32-bit
    1625              ;                       PUSH XAR3 ; 32-bit
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   47

    1625              ;                       PUSH XAR4 ; 32-bit
    1625                              ;-- Comment these to save cycles --------
    1625              ;                       PUSH XAR5 ; 32-bit
    1625              ;                       PUSH XAR6 ; 32-bit
    1625              ;                       PUSH XAR7 ; 32-bit
    1625                              ;----------------------------------------
    1625              
    1625              ;                       PUSH XT   ; 32-bit
    1625              
    1625              ;                       movl xar6, @_portFLAGS_INT_ENABLED
    1625              ;                       push xar6 ; portFLAGS_INT_ENABLED
    1625              ; +++===+++
    1625              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1625              ;                       mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
    1625              ;                       mov dbl (*ar7(#2)), xssp
    1625              
    1625 0002e4 ED31                          mov dbl (*(#_portFLAGS_INT_ENABLED)), xar6
         0002e6 EF00 
         0002e8 0000!
    1625 0002ea EB32                          mov xar6, dbl(*sp(#25))
         0002ec E5   
    1625              
    1625              ;                       movl xar7, @_usCriticalNesting
    1625              ;                       push xar7
    1625 0002ed ED31                          mov dbl (*(#_usCriticalNesting)), xar7
         0002ef FF00 
         0002f1 0000!
    1625 0002f3 EB2E                          mov xar7, dbl(*sp(#23))
         0002f5 F5   
    1625              
    1625 0002f6 EC31                          amov #0x000000, xar7
         0002f8 FE00 
         0002fa 0000 
    1625 0002fc EC31                          amov #0x000000, xar6
         0002fe EE00 
         000300 0000 
    1625              
    1625 000302 AF06                          mov mmap(ST1_55), ar7
         000304 98   
    1625 000305 CF02                          mov ar7, *sp(#1)
    1625 000307 AF96                          mov  mmap(ST2_55), ar7
         000309 98   
    1625 00030a CF04                          mov ar7, *sp(#2)
    1625              
    1625 00030c 449F                          mov ssp, ar7
    1625              ;                       mov *(#_LOOP_BITS), ar6                 ; save LOOP_BITS (CFCT)
    1625              ;                       and #0xFF00, ar6
    1625              ;                       mov ar6, *ar7(#1)
    1625              
    1625 00030e AE04                          mov mmap(ST0_55), ar6
         000310 98   
    1625 000311 CEED                          mov ar6, *ar7(#2)
         000313 0002 
    1625                                      
    1625 000315 AE31                          mov *(#_DBSTAT_SAVE), ar6               ; save DBSTAT
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   48

         000317 0000 
         000319 00!  
    1625 00031a CEED                          mov ar6, *ar7(#1)
         00031c 0001 
    1625              ; +++===+++
    1625              ;                       mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
    1625              ;                       mov dbl (*(#_save_xssp)), xssp          
    1625              ;;;                     mov  dbl (*(_DBSTAT_SAVE)), *xar7(#2)   ; needs to be DBSTAT - don't overwrite DBSTAT
    1625              ;;;                     mov ar6, *ar7(#2)
    1625              ;                       mov ar7, mmap(ST0_55)
    1625              ;                       mov *ssp(#2), ar7
    1625              ; fix up
    1625              ;                       aadd #20, sp
    1625              ;                       mov sp, t0
    1625              ;                       sub #1, t0
    1625              ;                       mov t0, ssp
    1625              
    1625                                      ; move contents of SP into address of current TCB
    1625              ;                       mov xsp, dbl (*(#_pxCurrentTCB))                ; xsp contains our TCB now
    1625              
    1625              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1625              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1625              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1625              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1625              ;                       mov dbl (*ar7+), xssp
    1625              
    1625              ;                       mov sp, t0              ; we've already saved t0
    1625              ;                       add #1, t0
    1625              ;                       mov t0, ssp
    1625              ; ??
    1625              ;                       mov xsp, dbl (*(#_pxCurrentTCB))
    1625              
    1625              ;                       movl xar6, @_pxCurrentTCB ; XAR6 contains current TCB addr
    1625              ;                       mov al, @sp
    1625              ;                       movl  *xar6, acc        
    1625              ;;                      mov  ar0, @sp
    1625              ;;                      mov  @ar6, alxd
    1625              ;;                      mov  ar0, @sp
    1625              ;;                      movl 0(xar6), sp
    1625              ;                       EDIS
    1625              ;                       NASP
    1625              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1625              ;                       NOP
    1625              ;                       .if configSTACK_PTR_DEBUG == 1
    1625              ;                       mov xsp, dbl(*(#_Ssave_xsp))
    1625              ;            mov xssp, dbl(*(#_Ssave_xssp))
    1625              ;            .endif
    1625                              .if 0
    1625                                      mov  xar7, dbl (*(#_save_xar7))                 ; restore xar7
    1625                          mov  xar6, dbl (*(#_save_xar6))
    1625              
    1625                              amov #0x000000, xar7
    1625                                      amov #0x000000, xar6
    1625                                  mov dbl (*(#_pxCurrentTCB)), xar7
    1625                                      mov dbl (*ar7), xar6                            ; xsp normal position
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   49

    1625                                      add #0x0064, ar6
    1625                                      mov xar6, xsp                                           ; actual xsp
    1625                                      mov dbl (*ar7(#2)), xar6                        ; xssp
    1625                                      add #0x0002, ar6
    1625                                      mov xar6, xssp
    1625              
    1625                          mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1625                          mov dbl (*(#_save_xar6)), xar6
    1625                        .endif
    1625              
    1625              ;;;;                    mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
    1625              ;;;;                    mov dbl (*(#_save_xssp)), xssp
    1625              
    1625 00031e ED31                          mov dbl (*(#_Ssave_xsp)), xsp                   ; restore xsp*
         000320 4F00 
         000322 0000!
    1625 000324 ED31                          mov dbl (*(#_Ssave_xssp)), xssp                 ; restore xssp
         000326 5F00 
         000328 0000!
    1625              
    1625 00032a 20                            nop
    1625              ;                       aadd #-1, sp
    1625 00032b 20                            nop
    1625              
    1625 00032c 20                            nop
    1625                                                                                      ; ?
    1626              ;        aadd #1, sp
    1627 00032d 6C00          call     #_xTaskIncrementTick
         00032f 0000!
    1628              ;        aadd #-1, sp
    1629                      .if configUSE_PREEMPTION == 1
    1630              ;        mov xsp, dbl (*(#_save_xsp))                   ; save xsp
    1631              ;           mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1632              ;        aadd #1, sp
    1633 000331 6C00          call    #_vTaskSwitchContext
         000333 0000!
    1634              ;        aadd #-1, sp
    1635              
    1636                                      .if 1
    1637 000335 EB31                          mov xar7, dbl (*(#_save_xar7))                  ; save xar7
         000337 F500 
         000339 0000!
    1638 00033b EB31              mov xar6, dbl (*(#_save_xar6))
         00033d E500 
         00033f 0000!
    1639 000341 EB31              mov ac0, dbl (*(#_save_ac0))                  ; save xar7
         000343 0800 
         000345 0000!
    1640 000347 EB31              mov ac1, dbl (*(#_save_ac1))
         000349 1800 
         00034b 0000!
    1641 00034d EB31              mov xar1, dbl(*(#_save_xar1))
         00034f 9500 
         000351 0000!
    1642 000353 EC31              amov #0x000000, xar7
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   50

         000355 FE00 
         000357 0000 
    1643 000359 EC31                          amov #0x000000, xar6
         00035b EE00 
         00035d 0000 
    1644 00035f ED31                          mov dbl (*(_xCompareTCB)), xar6
         000361 EF00 
         000363 0000!
    1645 000365 ED31                      mov dbl (*(#_pxCurrentTCB)), xar7
         000367 FF00 
         000369 0000!
    1646                          ; need to restore our return address
    1647 00036b 3C00              mov #0x000000, ac0
    1648 00036d 3C01                          mov #0x000000, ac1
    1649 00036f 90F0                          mov xar7, ac0
    1650 000371 90E1              mov xar6, ac1
    1651 000373 1210                  CMPU AC1 == AC0, TC1 ; |1393|
         000375 04   
    1652 000376 6464              BCC $A,TC1 ; |1393|
    1653 000378 20                nop                 ; breakpoint here - context switch has occurred
    1654                          .if configUSE_TICK_CTR == 1
    1655 000379 F731                      add #1, *(#_context_switch_counter)
         00037b 0001 
         00037d 0000 
         00037f 00!  
    1656                                  .endif
    1657                                  .if 0
    1658                                  amov #0x000000, xar7
    1659                                  amov #0x000000, xar1
    1660                                  mov *(#_save_new_pxcode), ar7
    1661                                  mov *ar6(#0), ar1
    1662                                  add #0x0064, ar1
    1663                                  mov ar7, *ar1
    1664                                  mov *(#_save_new_pxlcode), ar7
    1665                                  amov #0x000000, xar1
    1666                                  mov *ar6(#2), ar1
    1667                                  add #0x0002, ar1
    1668                                  mov ar7, *ar1
    1669                                  .endif
    1670                                  ; amov #0x000000, xar7
    1671                                      ;    amov #0x000000, xar6
    1672                          ;  mov  *(#_save_new_pxcode), ar7
    1673                                      ;    mov ar7, *sp(#0)
    1674                          ;                mov *(#_save_new_pxlcode) , ar7
    1675                          ;                mov ssp, ar6
    1676                          ;                mov ar7, *ar6(#0)
    1677              
    1678                          ;                mov dbl (*(#_save_xar6)), xar6
    1679                                      ;                       .endif
    1680              ; +++===+++
    1681 000380       $A:
    1682 000380 ED31              mov dbl (*(#_save_ac0)), ac0                  ; save xar7
         000382 0800 
         000384 0000!
    1683 000386 ED31              mov dbl (*(#_save_ac1)), ac1
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   51

         000388 1800 
         00038a 0000!
    1684 00038c ED31              mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         00038e FF00 
         000390 0000!
    1685 000392 ED31              mov dbl (*(#_save_xar6)), xar6
         000394 EF00 
         000396 0000!
    1686 000398 ED31              mov dbl (*(#_save_xar1)), xar1
         00039a 9F00 
         00039c 0000!
    1687                       .endif
    1688                      .endif
    1689              ;$1:
    1690              ;               bclr INTM
    1691 00039e E651                  mov #1, *port(#6166) ; |127|
         0003a0 0118 
         0003a2 16   
    1692              ;               MOV #0, *port(#6294) ; |92|
    1693 0003a3 F551                  or #0x0001, *port(#7188) ; |130|
         0003a5 0001 
         0003a7 1C14 
    1694               ;       OR #0x0007, *port(#7188) ; |100|
    1695 0003a9 4E01              aadd #1, sp ;;;
    1696                                              .if 0
    1697                                 POPBOTH XAR5
    1698                                 POP mmap(@CDPH)
    1699                                AMAR *(#00042h),XAR1
    1700                                RPT #10
    1701                                POP dbl(*AR1-)
    1702                                POP mmap(@DPH)
    1703                                POP mmap(@CDP)
    1704                                POP mmap(@BRC0)
    1705                               POP mmap(@BK03)
    1706                              POP mmap(@RPTC)
    1707                              POP mmap(@TRN0)
    1708                             POP mmap(@BRC1)
    1709                               POP mmap(@BRS1)
    1710                                POPBOTH AC3
    1711                               POP mmap(@AC3G)
    1712                               POPBOTH AC2
    1713                              POP mmap(@AC2G)
    1714                             POPBOTH AC1
    1715                               POP mmap(@AC1G)
    1716                                POPBOTH AC0
    1717                               POP mmap(@AC0G)
    1718                               POP T0,T1
    1719                                POPBOTH XAR4
    1720                                POPBOTH XAR3
    1721                               POPBOTH XAR2
    1722                              POPBOTH XAR1
    1723                              POPBOTH XAR0
    1724                               POP mmap(@ST3_55)
    1725                                  NOP
    1726                                   NOP
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   52

    1727                                  NOP
    1728                                   NOP
    1729                                   NOP
    1730                                    NOP
    1731                                              .endif
    1732              
    1733              
    1734                              .if configSTACK_PTR_DEBUG == 1
    1735                                      mov xsp, dbl(*(#_restore_xsp))
    1736                          mov xssp, dbl(*(#_restore_xssp))
    1737                         .endif
    1738 ****** MACRO         portRESTORE_CONTEXT
    1738                                      .C54CM_off
    1738              ;                       .CPL_off
    1738                                      .ARMS_off
    1738                                      .align 4
    1738              
    1738              ; Restore context & return - here we need to know what context we're in
    1738                                      ;CONTEXT_RESTORE
    1738              ;                       ASP
    1738              ;                       EALLOW
    1738              ;                       nop
    1738              ;                       nop
    1738              ;                       nop
    1738              ;                       nop
    1738 0003ac 4652                  bclr C54CM
    1738 0003ae 20                    nop
    1738 0003af 20                    nop
    1738 0003b0 20                    nop
    1738 0003b1 20                    nop
    1738 0003b2 20                    nop
    1738 0003b3 20                    nop
    1738              ;               xssp = dbl(*(#_pxCurrentTCB))
    1738              ;               xsp  = dbl(*(#_pxCurrentTCB))
    1738 0003b4 EB31                          mov xar7, dbl (*(#_save_xar7))  
         0003b6 F500 
         0003b8 0000!
    1738 0003ba EB31                          mov xar6, dbl (*(#_save_xar6))
         0003bc E500 
         0003be 0000!
    1738              
    1738              ;;;;                     aadd #-3, sp                           ;;;;
    1738              ;            aadd #-3, xsp
    1738              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1738              ;            BCC $1,TC1 ; |216|
    1738              ;;                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1738              ;;                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1738              ;            B $4
    1738              ;;              aadd #-2, sp
    1738 0003c0 EB31                          mov xsp, dbl (*(#_restore_xsp))                 ; save xsp
         0003c2 4500 
         0003c4 0000!
    1738 0003c6 EB31                          mov xssp, dbl (*(#_restore_xssp))                       ; save xssp
         0003c8 5500 
         0003ca 0000!
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   53

    1738               ;                      aadd #3, xsp
    1738              ;;;             aadd #-3, sp
    1738              
    1738              ;;;;            mov dbl(*(#_root_xsp)), xsp
    1738              ;;;;                    mov dbl(*(#_root_xssp)), xssp
    1738              ;;;                     aadd #3, sp
    1738              
    1738              ;$1
    1738              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1738              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
    1738              ;$4
    1738                                      .if 1
    1738              ;;                      mov xsp, xar7
    1738              ;;                      mov xssp, xar6
    1738 0003cc EC31                          amov #0x000000, xar2
         0003ce AE00 
         0003d0 0000 
    1738 0003d2 EC31                          amov #0x000000, xar1
         0003d4 9E00 
         0003d6 0000 
    1738              
    1738 0003d8 ED31                          mov dbl (*(#_pxCurrentTCB)), xar5
         0003da DF00 
         0003dc 0000!
    1738                                                                                               ;; points to our variables n
    1738 0003de EDA1                          mov dbl (*ar5), xar4                            ; xsp contains our TCB now
         0003e0 CF   
    1738 0003e1 EDAD                          mov dbl (*ar5(#2)), xar3
         0003e3 BF00 
         0003e5 02   
    1738 0003e6 7BFF                          add #-3, ar4
         0003e8 FDCC 
    1738 0003ea 7BFF                          add #-3, ar3
         0003ec FDBB 
    1738                                      
    1738 0003ee 90C4                          mov xar4, xsp
    1738 0003f0 90B5                          mov xar3, xssp
    1738              
    1738              ;;;                     mov *ar4, ar2
    1738              ;;;                     mov *ar3, ar1                           ; maybe not on a yield here
    1738              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1738              ;;;                     mov ar2, *ar7
    1738              ;;;                     mov ar1, *ar6
    1738              
    1738 0003f2 AF06                          mov mmap(ST1_55), ar7
         0003f4 98   
    1738 0003f5 7DF7                          and #0xf7ff, ar7                        ; <here>#0800h
         0003f7 FFFF 
    1738 0003f9 CF02                          mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1738 0003fb CF8D                          mov ar7, *ar4(#1)                       ; save in TCB
         0003fd 0001 
    1738 0003ff AF96                          mov mmap(ST2_55), ar7
         000401 98   
    1738 000402 CF04                          mov ar7, *sp(#2)
    1738 000404 CF8D                          mov ar7, *ar4(#2)
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   54

         000406 0002 
    1738              
    1738 000408 449F                          mov ssp, ar7
    1738 00040a AE04                          mov mmap(ST0_55), ar6
         00040c 98   
    1738 00040d CEED                          mov ar6, *ar7(#2)
         00040f 0002 
    1738 000411 CE6D                          mov ar6, *ar3(#2)
         000413 0002 
    1738 000415 AE31                          mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
         000417 0000 
         000419 00!  
    1738              ;;                      mov ar6, *ar7(#1)
    1738 00041a CE6D                          mov ar6, *ar3(#1)
         00041c 0001 
    1738                                      .endif
    1738              
    1738              ;                       mov #0, ssp     
    1738              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1738              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1738                                      ; 32-bit mode - will act on SP and SSP:
    1738              ;                       'fix-up' current SP and SSP - is this dangerous????
    1738              ;                       aadd #-3, sp
    1738              ;;                      mov *ar7, *sp
    1738              ;                       mov dbl (*ar7), ar6
    1738              ;                       mov ar6, *sp                            ; xsp contains our TCB now
    1738              ;                       mov *ar7(#2), *ssp                      
    1738              ;                       POP mmap(ST3_55)
    1738              ;                       pshboth xar7                            ; should increment both
    1738                                      .if 0
    1738                                      mov mmap(ST1_55), ar7
    1738                                      and #0xf7ff, ar7                        ; <here>#0800h
    1738                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1738                                      mov mmap(ST2_55), ar7
    1738                                      mov ar7, *sp(#2)
    1738              
    1738                                      mov ssp, ar7
    1738                                      mov mmap(ST0_55), ar6
    1738                                      mov ar6, *ar7(#2)
    1738              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
    1738              ;;                      mov ar6, *ar7(#1)
    1738                                      .endif
    1738              ; +++===+++
    1738                                      .if 0
    1738                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1738                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1738                                      mov dbl (*ar7(#2)), xssp        
    1738                                      .endif
    1738              ; +++===+++
    1738                                      .if 0
    1738                                      mov dbl (*(_xCompareTCB)), xar6
    1738              ; need to restore our return address
    1738                                      mov xar7, ac0
    1738                                          mov xar6, ac1
    1738                                          CMPU AC1 != AC0, TC1 ; |1393|
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   55

    1738                                          BCC $6,TC1 ; |1393|
    1738                                          amov #0x000000, xar7
    1738                                          amov #0x000000, xar6
    1738                                          mov  *(#_save_new_pxcode), ar7
    1738                                          mov ar7, *sp(#0)
    1738                                          mov *(#_save_new_pxlcode) , ar7
    1738                                          mov ssp, ar6
    1738                                          mov ar7, *ar6(#0)
    1738              
    1738                                          mov dbl (*(#_save_xar6)), xar6
    1738                                                              .endif
    1738              ; +++===+++
    1738 00041e       $6_$3$:
    1738              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
    1738              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1738                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
    1738                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1738                                      mov xar6, dbl (*(#_save_xar6))
    1738              
    1738              ;; this is for debug
    1738                                      mov dbl(*ar7), xar6
    1738                                      mov dbl(*ar6), xar7
    1738                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
    1738                                      mov xssp, xar7
    1738                                      mov dbl(*ar7), xar6
    1738                                      mov dbl(*ar6), xar7
    1738                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
    1738                                      mov xssp, xar7
    1738                                      add #-2, ar7
    1738                                      mov dbl(*ar7), xar6
    1738                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
    1738                                      mov dbl (*(#_save_xar6)), xar6
    1738                                      
    1738                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1738                                      .endif
    1738              ; +++===+++
    1738              ;                       mov mmap(ST0_55), *ssp(#1)
    1738              ;                       mov mmap(STO_55), *ssp(#2)
    1738              ;                       mov mmap(ST1_55), *sp(#1)
    1738              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
    1738              ;                       mov *ar7, t0
    1738              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
    1738              ;                       mov *ar7(#2), t0
    1738              ;                       mov t0, *ssp(#0)                        
    1738              
    1738              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
    1738              ; what about xssp?
    1738              ;                       mov xar6, xsp
    1738              ;                       mov xssp, xar7
    1738              ;                       add #1, ar7
    1738              ;                       mov xar7, xsp
    1738              ;                       mov sp, t0
    1738              ;                       mov ssp, t1
    1738              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
    1738              ;                       ar0 = *ar6
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   56

    1738              ;                       xssp = xar0
    1738              ;                       mov *xar6, xar0
    1738              ;                       mov xar0, xssp  ; stack now points to our TCB
    1738              ;;                      mov sp, *ar6
    1738              ;;                      mov sp, ar0
    1738              ;;                      mov sp, *_pxCurrentTCB
    1738              ;;                      clr ar0
    1738              ;;                      mov ar0, @xar6
    1738              ;;                      mov sp, AR0
    1738              ;;                      add sp, xar6
    1738              
    1738              ;;                      pshboth xar7
    1738              ;;                      pshboth xar6
    1738              ;;                      pshboth xar5
    1738              
    1738              ;;                      popboth xar5
    1738              ;;                      popboth xar6
    1738              ;;                      popboth xar7
    1738              
    1738              ;;;                     mov *sp(#1), ar7 
    1738              ;                       mov dbl(*sp(#1)), ar7
    1738              ;;;                     mov  ar7, mmap(ST1_55)
    1738              ; +++===+++
    1738              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1738              ;                       add #0x0064, ar7
    1738              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1738              ;                       mov *ar7(#2)
    1738              ;                       mov dbl (*ar7(#2)), xssp
    1738              ; ===+++===
    1738                 .if 1
    1738 00041e EC31                  amov #0x000000, xar7
         000420 FE00 
         000422 0000 
    1738 000424 EC31                          amov #0x000000, xar6
         000426 EE00 
         000428 0000 
    1738 00042a ED31                      mov dbl (*(#_pxCurrentTCB)), xar7
         00042c FF00 
         00042e 0000!
    1738 000430 EDE1                          mov dbl (*ar7), xar6                            ; xsp normal position
         000432 EF   
    1738 000433 7BFF                          add #-3, ar6
         000435 FDEE 
    1738 000437 90E4                          mov xar6, xsp                                           ; actual xsp
    1738 000439 EDED                          mov dbl (*ar7(#2)), xar6                        ; xssp
         00043b EF00 
         00043d 02   
    1738 00043e 7BFF                          add #-3, ar6
         000440 FDEE 
    1738 000442 90E5                          mov xar6, xssp
    1738                 .endif
    1738              ; ===+++===
    1738              ;                       add #0x0064, xssp
    1738              ; +++===+++
    1738                                      .if 0
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   57

    1738                                      mov *sp(#2), ar7
    1738                                      mov ar7, mmap(ST2_55)
    1738                                      mov ssp, ar7
    1738                                      mov *ar7(#2), ar6
    1738                                      mov ar6, mmap(ST0_55)
    1738                                      .endif
    1738              ;                       mov *ar7(#2), ar6
    1738              ;                       mov ar6, *ssp(#2)
    1738              ;                       mov *ssp(#2), ar7
    1738              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
    1738              ;
    1738              ; restore context
    1738              
    1738 000444 EC31                          amov #0x000000, xar2
         000446 AE00 
         000448 0000 
    1738 00044a EC31                          amov #0x000000, xar1
         00044c 9E00 
         00044e 0000 
    1738              
    1738                                      .if 0
    1738                                      mov mmap(ST1_55), ar7
    1738                                      and #0xf7ff, ar7                        ; <here>#0800h
    1738                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1738                                      mov ar7, mmap(ST1_55)
    1738              ;                       mov ar7, *ar4(#1)                       ; save in TCB
    1738                                      mov mmap(ST2_55), ar7
    1738                                      mov ar7, *sp(#2)
    1738              ;                       mov ar7, *ar4(#2)
    1738              
    1738                                      mov ssp, ar7
    1738                                      mov mmap(ST0_55), ar6
    1738                                      mov ar6, *ar7(#2)
    1738              ;                       mov ar6, *ar3(#2)
    1738                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
    1738                                      mov ar6, *ar7(#1)
    1738              ;                       mov ar6, *ar3(#2)
    1738                                      .endif
    1738              ;;                      mov *(#_LOOP_BITS), ar6         ; have to restore this
    1738              ;;                      and #0xFF00, ar6
    1738              ;;                      mov ar6, *ar7(#1)
    1738              
    1738 000450 4EE6                          aadd #-26, sp
    1738              
    1738 000452 EC31                          amov #0x000000, xar7
         000454 FE00 
         000456 0000 
    1738 000458 ED32                          mov dbl(*sp(#25)), xar7
         00045a FF   
    1738              ;                       mov *sp(#1), ar7
    1738 00045b EB31                          mov xar7, dbl(*(#_usCriticalNesting))
         00045d F500 
         00045f 0000!
    1738 000461 EC31              amov #0x000000, xar6
         000463 EE00 
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   58

         000465 0000 
    1738 000467 ED2E                          mov dbl(*sp(#23)), xar6
         000469 EF   
    1738              ;                       mov *sp(#3), ar6
    1738              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
    1738 00046a EB31                          mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))
         00046c E500 
         00046e 0000!
    1738              
    1738              
    1738 000470 A400                          mov *sp(#0), t0
    1738 000472 A502                          mov *sp(#1), t1
    1738 000474 A604                          mov *sp(#2), t2
    1738 000476 A706                          mov *sp(#3), t3
    1738 000478 ED08                          mov dbl(*sp(#4)), ac0
         00047a 08   
    1738 00047b A00A              mov *sp(#5), ac0
    1738 00047d ED0C                      mov dbl(*sp(#6)), xar0
         00047f 8F   
    1738 000480 A80E                          mov *sp(#7), ar0
    1738 000482 ED10                          mov dbl(*sp(#8)), xar1
         000484 9F   
    1738 000485 A912                          mov *sp(#9), ar1
    1738 000487 ED14                          mov dbl(*sp(#10)), xar2
         000489 AF   
    1738 00048a AA16                          mov *sp(#11), ar2
    1738 00048c ED18                          mov dbl(*sp(#12)), xar3
         00048e BF   
    1738 00048f AB1A                          mov *sp(#13), ar3
    1738              ;; pvPararmeters currently here - needs to be verified --- jcw
    1738 000491 ED1C                          mov dbl(*sp(#14)), xar4
         000493 CF   
    1738 000494 AC1E                          mov *sp(#15), ar4
    1738 000496 ED20                          mov dbl(*sp(#16)), xar5
         000498 DF   
    1738 000499 AD22                          mov *sp(#17), ar5
    1738 00049b ED24                          mov dbl(*sp(#18)), xar6
         00049d EF   
    1738 00049e AE26                          mov *sp(#19), ar6
    1738              
    1738              ;                       POP XT
    1738                              ;-- Comment these to save cycles ---
    1738 0004a0 ED28                          mov dbl(*sp(#20)), xar7
         0004a2 FF   
    1738 0004a3 AF2A                          mov *sp(#21), ar7
    1738              
    1738                                      .if 0
    1738              
    1738                                      mov dbl(*sp(#4)), xar7
    1738              ;                       mov *sp(#1), ar7
    1738                                      mov xar7, dbl(*(#_usCriticalNesting))   
    1738              
    1738                                      mov dbl(*sp(#6)), xar6
    1738              ;                       mov *sp(#3), ar6
    1738              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   59

    1738                                      mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))       
    1738              ;                       POP XT
    1738                              ;-- Comment these to save cycles ---
    1738                                      mov dbl(*sp(#8)), xar7
    1738                                      mov *sp(#7), ar7
    1738              ;                       mov *sp(#5), ar7
    1738              ;                       mov dbl(*sp(#0)), hi(ar7)
    1738              ;                       mov (*sp(#0)), lo(ar7)
    1738                                      mov dbl(*sp(#10)), xar6
    1738                                      mov *sp(#9), ar6
    1738                                      mov dbl(*sp(#12)), xar5
    1738                                      mov *sp(#11), ar5
    1738              ;; pvPararmeters currently here - needs to be verified --- jcw
    1738                                      mov dbl(*sp(#14)), xar4
    1738                                      mov *sp(#13), ar4
    1738                                      mov dbl(*sp(#16)), xar3
    1738                                      mov *sp(#15), ar3
    1738                                      mov dbl(*sp(#18)), xar2
    1738                                      mov *sp(#17), ar2
    1738                                      mov dbl(*sp(#20)), xar1
    1738                                      mov *sp(#19), ar1
    1738                                      mov dbl(*sp(#22)), xar0
    1738                                      mov *sp(#21), ar0
    1738                                  mov dbl(*sp(#24)), ac0
    1738                          mov *sp(#23), ac0
    1738              
    1738                                      mov *sp(#25), t3
    1738                                      mov *sp(#26), t2
    1738                                      mov *sp(#27), t1
    1738                                      mov *sp(#28), t0
    1738                                      .endif
    1738              
    1738              ;                       mov dbl(*sp(#21)), *xssp(#0)
    1738              ;                       mov *sp(#21), *ssp
    1738              ;                       mov *sp(#21), RETA
    1738              ; need to move 23-16 to XSSP contents
    1738              ;                       mov xar0, dbl (*(#_save_xar7))
    1738              ;                       mov ssp, ar0
    1738              ;                       mov #0, ssp 
    1738              ;                       mov xssp, xar0
    1738              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
    1738              ;                       aadd #20, sp            ; this is ok - ssp also incremented
    1738                      ;               add #1, xssp            ; 32-bit return address pointer
    1738                      ;               amar *xssp+
    1738              ;                       mov sp, t0
    1738              ;                       add #1, t0
    1738              ;                       mov t0, ssp
    1738              ;                       incr ssp
    1738              ;                       asub #20, ar0
    1738              ;                       mov xar0, xssp
    1738              ;                       mov ar0, ssp
    1738              ;                       mov ar0, 
    1738              ;;                      mov *sp(#1), t0
    1738              ;;                      mov *sp(#3), t3         ; ST0
    1738              ;;                      mov *sp(#4), t2         ; DBSTAT
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   60

    1738              ;;                      mov t3, *ar0(#2)
    1738                      ;;              mov t2, *ar0(#1)
    1738              ;;                      mov t0, *ar0(#0)
    1738              
    1738              ;;                      mov *sp(#5), t0
    1738              ;;                      mov *sp(#6), t1
    1738              ;;                      mov *sp(#7), t2
    1738                      ;;              mov *sp(#8), t3
    1738              
    1738              ; restore ar0
    1738              ;                       mov dbl(*sp(#-2)), xar0
    1738              ;                       mov #-1, ar0
    1738              ;;                      mov dbl (*(#_save_xar7)), xar0
    1738              ;;
    1738              ;;                      mov sp, t0
    1738              ;;                      add #1, t0
    1738              ;;                      mov t0, ssp
    1738              
    1738              ;                       mov *sp(#3), *(#00004ch+#1)
    1738              
    1738              ;                       mov t3, *ssp(#1) 
    1738              ;                       mov t2, *ssp(#2)
    1738              
    1738              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
    1738              ;;                      mov t3, *(ssp(#0))
    1738              ;                       mov t3, *ssp
    1738              ;                       mov *sp(#3), t3 ; 
    1738              ;                       mov t3, *ssp(#1)
    1738              ;;                      mov *sp(#21), PC        
    1738              
    1738              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1738              ;                       mov dbl(xsp), dbl(lcrpc)
    1738              ;                       popboth XAR7
    1738              ;                       add #1, sp
    1738              ;                       add #1, ssp
    1738              ;                       add #2, t0
    1738              ;                       add #2, t1
    1738              ;                       mov t0, sp
    1738              ;                       mov t1, ssp
    1738              ;                       popboth XAR6
    1738              ;                       add #2, t0
    1738              ;                       add #2, t1
    1738              ;                       mov t0, sp
    1738              ;                       mov t1, ssp
    1738              ;                       popboth XAR5
    1738              ;                       add #2, t0
    1738              ;                       add #2, t1
    1738              ;                       mov t0, sp
    1738              ;                       mov t1, ssp
    1738                              ;-----------------------------------
    1738              ;                       popboth XAR4
    1738              ;                       add #2, t0
    1738              ;                       add #2, t1
    1738              ;                       mov t0, sp
    1738              ;                       mov t1, ssp
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   61

    1738              ;                       popboth XAR3
    1738              ;                       add #2, t0
    1738              ;                       add #2, t1
    1738              ;                       mov t0, sp
    1738              ;                       mov t1, ssp
    1738              ;                       popboth XAR2
    1738              ;                       add #2, t0
    1738              ;                       add #2, t1
    1738              ;                       mov t0, sp
    1738              ;                       mov t1, ssp
    1738              ;                       popboth XAR1
    1738              ;                       add #2, t0
    1738              ;                       add #2, t1
    1738              ;                       mov t0, sp
    1738              ;                       mov t1, ssp
    1738              ;                       popboth XAR0
    1738              ;                       add #2, t0
    1738              ;                       add #2, t1
    1738              ;                       mov t0, sp
    1738              ;                       mov t1, ssp
    1738              ;                       EDIS
    1738              ;                       NASP    ; Un-align stack pointer
    1738              ;;                      pop mmap(ST3_55)
    1738              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1738              ;            BCC $2,TC1 ; |216|
    1738                                      .if 0
    1738                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1738              
    1738                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1738                                      mov dbl (*ar7(#2)), xssp                
    1738                                      .endif
    1738              
    1738              ;;;              mov dbl(*(#_restore_xsp)), xsp
    1738              ;;;=-=             mov dbl(*(#_restore_xssp)), xssp
    1738              ;;;=-=             mov dbl(*(#_restore_xsp)), xsp
    1738              ;;;;                    mov dbl(*(#_root_xssp)), xssp
    1738              ;;;                     aadd #3, sp
    1738              ;;;;;;                  mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1738              ;;;;;;                  mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1738              
    1738              
    1738                                      .if 0
    1738                                      mov dbl (*(_xCompareTCB)), xar6
    1738              ; need to restore our return address
    1738                                      mov xar7, ac0
    1738                          mov xar6, ac1
    1738                              CMPU AC1 != AC0, TC1 ; |1393|
    1738                          BCC $6,TC1 ; |1393|
    1738                          amov #0x000000, xar7
    1738                                      amov #0x000000, xar6
    1738                          mov  *(#_save_new_pxcode), ar7
    1738                                      mov ar7, *sp(#0)
    1738                          mov *(#_save_new_pxlcode) , ar7
    1738                          mov ssp, ar6
    1738                          mov ar7, *ar6(#0)
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   62

    1738              
    1738                          mov dbl (*(#_save_xar6)), xar6
    1738                                      .endif
    1738              
    1738              ;;                      mov dbl (*(#_save_xar7)), xar7
    1738              
    1738              ;               .if configSTACK_PTR_DEBUG == 1
    1738              ;;                      mov dbl(*(#_restore_xsp)), xsp
    1738              ;;            mov dbl(*(#_restore_xssp)), xssp
    1738              ;;            .endif
    1738              
    1738              ;                       B $3
    1738              ;$2
    1738              ;           MOV #0, *(#_first_flag) ; |217|
    1738              ;               mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1738              ;                       mov dbl (*(#_first_save_xssp)), xssp
    1738              ;$3
    1738                                      .if 0
    1738                              amov #0x000000, xar7
    1738                                      amov #0x000000, xar6
    1738                                  mov dbl (*(#_pxCurrentTCB)), xar7
    1738                                      mov dbl (*ar7), xar6                            ; xsp normal position
    1738                                      add #0x0064, ar6
    1738                                      mov xar6, xsp                                           ; actual xsp
    1738                                      mov dbl (*ar7(#2)), xar6                        ; xssp
    1738                                      add #0x0002, ar6
    1738                                      mov xar6, xssp
    1738                                      .endif
    1738              
    1738              ;;;;                    aadd #-1, sp                    ; on yield, need to do this
    1738 0004a5 4E1A                          aadd #26, sp
    1738 0004a7 46B2                          bclr INTM               ; enable interrupts
    1738 0004a9 20                            nop
    1738 0004aa 20                            nop
    1738 0004ab 20                            nop
    1738 0004ac 20                            nop
    1738 0004ad 20                            nop
    1738 0004ae 20                            nop
    1738              
    1738              ;                       aadd #1, sp
    1738 0004af 4805                          RETI
    1738              ;                       mov #1860h, ssp
    1738 0004b1 20                            nop
    1738 0004b2 20                            nop
    1738              ;                       nop
    1739              
    1740              ; /*-----------------------------------------------------------*/
    1741              
    1742              
    1743              ;/*
    1744              ; * Manual context switch called by the portYIELD() macro.
    1745              ; */
    1746              
    1747              ; We are using the slow return model:
    1748              
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   63

    1749              ; System Stack (SSP)                    Data Stack (SP)
    1750              ; SSP = x - 3:  (Loop Bits):PC(23-16)   SP = y - 3: PC(15-0)  <<= Last pushed - first to POP
    1751              ; SSP = x - 2:  DBSTAT                  SP = y - 2: ST1_55
    1752              ; SSP = x - 1:  ST0_55                  SP = y - 1: ST2_55
    1753              ; SSP = x:      Previously saved data   SP = y:     Previously saved data
    1754              
    1755              
    1756 0004b3       _vPortYield:                                    ;; note - most testing done with preemptive kernel - so this 
    1757              
    1758 0004b3 4EFF                  aadd #-1, sp
    1759 0004b5 E651                  MOV #0, *port(#6166) ; |119|
         0004b7 0018 
         0004b9 16   
    1760 0004ba F402              AND #0x0010, mmap(@IFR0)
         0004bc 0010 
         0004be 98   
    1761 0004bf 46B3                  bset INTM
    1762              ;                /* Mimic an interrupt by pushing the SR. */
    1763              
    1764              ;               /* SR is 16-bits in 430X architecture */
    1765              
    1766              ;;                pushx.w    SR
    1767              
    1768              ;                /* Now the SR is stacked we can disable interrupts. */
    1769              
    1770              ;                dint
    1771              
    1772              ;                 bset INTM             ; disable interrupts
    1773              
    1774              ;;                bicx.w #0xF000,0(r1)
    1775              ;;                swpbx.w +4(r1)
    1776              ;;                rlax.w +4(r1)
    1777              ;;                rlax.w +4(r1)
    1778              ;;                rlax.w +4(r1)
    1779              ;;                rlax.w +4(r1)
    1780              ;;                addx.w +4(r1),0(r1)
    1781              ;;                movx.w +2(r1),+4(r1)
    1782              ;;                movx.w 0(r1),+2(r1)
    1783              ;;                incdx.a r1
    1784              
    1785              ;                /* Save the context of the current task. */
    1786              ;;        psh mmap(ST3_55)
    1787                  .if 1
    1788 0004c1 EB31                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
         0004c3 F500 
         0004c5 0000!
    1789 0004c7 EB31                          mov xar6, dbl (*(#_save_xar6))                  ; save x
         0004c9 E500 
         0004cb 0000!
    1790 0004cd EC31                                                  amov #0x000000, xar7
         0004cf FE00 
         0004d1 0000 
    1791 0004d3 EC31                                                  amov #0x000000, xar6
         0004d5 EE00 
         0004d7 0000 
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   64

    1792              
    1793 0004d9 AF02                          mov *sp(#1), ar7                                            ;; sp+3
    1794 0004db CF31                          mov ar7, *(#_save_new_pxcode)
         0004dd 0000 
         0004df 00!  
    1795 0004e0 449E                          mov ssp, ar6
    1796 0004e2 AFCD                          mov *ar6(#1), ar7                                                       ;; ssp+3
         0004e4 0001 
    1797 0004e6 CF31                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and i
         0004e8 0000 
         0004ea 00!  
    1798 0004eb EC31                          amov #0x000000, xar7
         0004ed FE00 
         0004ef 0000 
    1799 0004f1 AFCD                          mov *ar6(#2), ar7                               ; this is two away now
         0004f3 0002 
    1800 0004f5 CF31                                                  mov ar7, *(#_DBSTAT_SAVE)               ;; this is just for r
         0004f7 0000 
         0004f9 00!  
    1801                                   ;   nop
    1802 0004fa ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         0004fc FF00 
         0004fe 0000!
    1803 000500 EB31                          mov xar7, dbl(*(#_xCompareTCB))
         000502 F500 
         000504 0000!
    1804                                      .endif
    1805              
    1806              
    1807 ****** MACRO         portSAVE_CONTEXT
    1807              ;                       ;CONTEXT_SAVE
    1807              ;                       ASP  ; Align Stack Pointer
    1807              ;                       CLRC       OVM,PAGE0
    1807              ;                       CLRC       AMODE
    1807              ;                       EALLOW
    1807 000506 4652                  bclr C54CM      ; temp - until we figure out what is setting this
    1807              ;;;             bset INTM               ; disable interrupts - already done
    1807              ;                       aadd #1, sp
    1807 000508 20                            nop
    1807 000509 20                            nop
    1807 00050a 20                            nop
    1807              
    1807 00050b EB31                          mov xsp,  dbl (*(#_Ssave_xsp))                  ; save xsp
         00050d 4500 
         00050f 0000!
    1807 000511 EB31                          mov xssp, dbl (*(#_Ssave_xssp))                 ; save xssp
         000513 5500 
         000515 0000!
    1807              ;;;                     mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1807              ;;;                     mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1807              
    1807              ;                       pshboth xar7
    1807              ;                       pshboth xar6
    1807              ;                       pshboth xar5
    1807              
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   65

    1807              ;;;;                    mov xar7, dbl (*(#_save_xar7))                  ; save xar7 (already saved)
    1807              ;                       .if configUSE_CONTEXT_DEBUG == 1
    1807              ;;;;                    mov xar6, dbl (*(#_save_xar6))                  ; saved in vTick ISR already
    1807              ;                       .endif
    1807 000517 4E01                          aadd #1, sp
    1807              ; +++===+++
    1807              
    1807                                      .if 1                                                           ; need to figure out 
    1807 000519 EB31                          mov xar1, dbl (*(#_save_xar1))
         00051b 9500 
         00051d 0000!
    1807 00051f EB31                          mov xar2, dbl (*(#_save_xar2))
         000521 A500 
         000523 0000!
    1807 000525 EB31                          mov xar3, dbl (*(#_save_xar3))
         000527 B500 
         000529 0000!
    1807 00052b EB31                          mov xar4, dbl (*(#_save_xar4))
         00052d C500 
         00052f 0000!
    1807 000531 EC31                          amov #0x000000, xar5
         000533 DE00 
         000535 0000 
    1807 000537 EC31                          amov #0x000000, xar6
         000539 EE00 
         00053b 0000 
    1807 00053d 904D                          mov xsp, xar5
    1807 00053f 905E                          mov xssp, xar6
    1807 000541 EC31                          amov #0x000000, xar2
         000543 AE00 
         000545 0000 
    1807 000547 EC31                          amov #0x000000, xar1
         000549 9E00 
         00054b 0000 
    1807 00054d EC31                          amov #0x000000, xar3
         00054f BE00 
         000551 0000 
    1807 000553 EC31                          amov #0x000000, xar4
         000555 CE00 
         000557 0000 
    1807 000559 ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         00055b FF00 
         00055d 0000!
    1807              
    1807 00055f EDE1                          mov dbl (*ar7), xar4                            ; xsp contains our TCB now
         000561 CF   
    1807 000562 EDED                          mov dbl (*ar7(#2)), xar3
         000564 BF00 
         000566 02   
    1807 000567 7BFF                          add #-3, ar4
         000569 FDCC 
    1807 00056b 7BFF                          add #-3, ar3
         00056d FDBB 
    1807              
    1807 00056f AAAD                          mov *ar5(#0), ar2                               ; current xsp contents
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   66

         000571 0000 
    1807 000573 A9CD                          mov *ar6(#0), ar1                               ; current xssp contents
         000575 0000 
    1807              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1807 000577 CA81                          mov ar2, *ar4                           ; saves our new PC - but, does this work in e
    1807 000579 C961                          mov ar1, *ar3
    1807                                      .endif
    1807              ;;                      aadd #1, sp
    1807                                      .if 0
    1807                          amov #0x000000, xar7
    1807                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1807                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1807                                      mov dbl (*ar7(#2)), xssp
    1807                          amov #0x000000, xar7
    1807                                      amov #0x000000, xar6
    1807                          mov *(#_save_new_pxcode), ar7
    1807                          mov ar7, *sp(#0)
    1807                          amov #0x000000, xar7
    1807                          mov ssp, ar6
    1807                          mov *(#_save_new_pxlcode), ar7
    1807              ;            mov ar7, *ssp(#0)
    1807                          mov ar7, *ar6(#0)
    1807                              .endif
    1807              
    1807              ;                       mov ssp, ar7
    1807              ;                       mov *ar7(#1), ar6                               ; this is (one)two away now
    1807              ;                       mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
    1807              ;                       .endif
    1807              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1807              ;            mov xar6, dbl (*(#_save_xar6))                  ; save x
    1807                                      .if 0
    1807                                      amov #0x000000, xar7
    1807                                      amov #0x000000, xar6
    1807                          mov *sp(#0), ar7                                            ;; sp+3
    1807                          mov ar7, *(#_save_new_pxcode)
    1807                          mov ssp, ar6
    1807                          mov *ar6(#1), ar7                                                       ;; ssp+3
    1807                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and if a task, it
    1807                                   ;   nop
    1807                          mov dbl (*(#_pxCurrentTCB)), xar7
    1807                          mov xar7, dbl(*(#_xCompareTCB))
    1807                          .endif
    1807              ; +++===+++
    1807              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1807              ;
    1807              
    1807              
    1807              ; +++===+++
    1807                                      .if 0
    1807              ;                       mov dbl (*(_xCompareTCB)), xar6                 ; need to save our return address
    1807              ;                       mov xar7, ac0
    1807              ;               mov xar6, ac1
    1807              ;                       CMPU AC1 != AC0, TC1
    1807              ;                               BCC $5,TC1
    1807                                      amov #0x000000, xar7
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   67

    1807                                          amov #0x000000, xar6
    1807                                          mov  *(#_save_new_pxcode), ar7
    1807                                          mov ar7, *sp(#0)
    1807                              mov *(#_save_new_pxlcode) , ar7
    1807                              mov ssp, ar6
    1807                              mov ar7, *ar6(#0)
    1807                              mov dbl (*(#_save_xar6)), xar6
    1807                                         .endif
    1807              ; +++===+++
    1807 00057b       $5_$4$:
    1807                                              
    1807              ; +++===+++
    1807              ;; what about xssp here?
    1807              ;;                              mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1807              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1807                                 .if configUSE_CONTEXT_DEBUG == 1
    1807              ;; save current PC (and possible loop bits values)
    1807              ;; for debug - to see if this is being corrupted
    1807                                      mov dbl(*ar7), xar6
    1807                                      mov dbl(*ar6), xar7
    1807                                      mov xar7, dbl (*(#_PC_REG_LOW_SAVE))            ; save off the PC
    1807                                      mov xssp, xar7
    1807                                      mov dbl(*ar7), xar6
    1807                                      mov dbl(*ar6), xar7
    1807                                      mov xar7, dbl (*(#_PC_REG_HIGH_SAVE))           ; save off the PC
    1807                                      mov xssp, xar7
    1807                                      add #-2, ar7
    1807                                      mov dbl(*ar7), xar6
    1807                                      mov xar6,  dbl (*(_DBSTAT_SAVE))
    1807                          mov dbl (*(#_save_xar6)), xar6
    1807              
    1807              ;            mov (*ar7), (*(#_PC_REG_LOW_SAVE))
    1807              ;            mov dbl(*xssp),(*(#_PC_REG_HIGH_SAVE))
    1807              ;                       mov (*ssp(#-2)), (*(#_DBSTAT_SAVE))
    1807                                      .endif
    1807              ; +++===+++
    1807                                      ; save context in our stack(s) frame
    1807              
    1807              ;;;;                    mov dbl (*(#_pxCurrentTCB)), xar7
    1807              ;;;                     mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1807              ;;;                     mov dbl (*ar7(#2)), xssp
    1807              ; +++===+++
    1807              ;                   mov dbl (*(#_pxCurrentTCB)), xar7
    1807                                  ; add #0x0064, ar7
    1807              ;                       mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
    1807              ;                       mov dbl (*ar7(#2)), xssp
    1807              ;           add #0x0064, ar4
    1807              ;                       add #0x0064, ar3
    1807              ;                       mov dbl (*ar5), xar4                            ; xsp contains our TCB now
    1807              ;                       mov dbl (*ar5(#2)), xar3                        ; xssp
    1807              ;                       add #0x0064, ar4
    1807              ;                       add #0x0064, ar3
    1807 00057b EC31                  amov #0x000000, xar7
         00057d FE00 
         00057f 0000 
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   68

    1807 000581 EC31                          amov #0x000000, xar6
         000583 EE00 
         000585 0000 
    1807 000587 ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         000589 FF00 
         00058b 0000!
    1807 00058d EDE1                          mov dbl (*ar7), xar6                            ; xsp normal position
         00058f EF   
    1807 000590 7BFF                          add #-3, ar6
         000592 FDEE 
    1807 000594 90E4                          mov xar6, xsp                                           ; actual xsp
    1807 000596 EDED                          mov dbl (*ar7(#2)), xar6                        ; xssp
         000598 EF00 
         00059a 02   
    1807 00059b 7BFF                          add #-3, ar6
         00059d FDEE 
    1807 00059f 90E5                          mov xar6, xssp
    1807              
    1807 0005a1 ED31              mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         0005a3 FF00 
         0005a5 0000!
    1807 0005a7 ED31              mov dbl (*(#_save_xar6)), xar6
         0005a9 EF00 
         0005ab 0000!
    1807              ;            mov dbl (*(#_save_xar1)), xar1                  ; restore xar7
    1807              ;            mov dbl (*(#_save_xar2)), xar2
    1807              ;            mov dbl (*(#_save_xar3)), xar3                  ; restore xar7
    1807              ;            mov dbl (*(#_save_xar4)), xar4
    1807                                        ; restore xar6
    1807              ;;; begin context save:
    1807 0005ad 4EE6                          aadd #-26, sp
    1807              
    1807 0005af EB28                          mov xar7, dbl(*sp(#20))                         ; save xar7
         0005b1 F5   
    1807 0005b2 CF2A                          mov ar7, *sp(#21)
    1807              
    1807 0005b4 EB24                          mov xar6, dbl(*sp(#18))
         0005b6 E5   
    1807 0005b7 CE26                          mov ar6, *sp(#19)
    1807              
    1807 0005b9 EB20                          mov xar5, dbl(*sp(#16))
         0005bb D5   
    1807 0005bc CD22                          mov ar5, *sp(#17)
    1807              
    1807 0005be EB1C                          mov xar4, dbl(*sp(#14))
         0005c0 C5   
    1807 0005c1 CC1E                          mov ar4, *sp(#15)
    1807              
    1807 0005c3 EB18                          mov xar3, dbl(*sp(#12))
         0005c5 B5   
    1807 0005c6 CB1A                          mov ar3, *sp(#13)
    1807              
    1807 0005c8 EB14                          mov xar2, dbl(*sp(#10))
         0005ca A5   
    1807 0005cb CA16                          mov ar2, *sp(#11)
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   69

    1807              
    1807 0005cd EB10                          mov xar1, dbl(*sp(#8))
         0005cf 95   
    1807 0005d0 C912                          mov ar1, *sp(#9)
    1807              
    1807 0005d2 EB0C                          mov xar0, dbl(*sp(#6))
         0005d4 85   
    1807 0005d5 C80E                          mov ar0, *sp(#7)
    1807              
    1807 0005d7 EB08                          mov  ac0, dbl(*sp(#4))
         0005d9 08   
    1807 0005da C00A                          mov ac0, *sp(#5)
    1807              
    1807 0005dc C706                          mov t3, *sp(#3)
    1807 0005de C604                          mov t2, *sp(#2)
    1807 0005e0 C502                          mov t1, *sp(#1)
    1807 0005e2 C400                          mov t0, *sp(#0)
    1807              ; +++===+++
    1807              ;;                      mov mmap(ST0_55), t0
    1807              ; - this is ok - we are not pushing - it's a relative stack frame
    1807              ;                       mov t0, *sp(#25)
    1807              ;;                      mov t0, *sp(#23)
    1807              ;;                      mov mmap(ST1_55), t1
    1807              ;                       mov t1, *sp(#26)                ; stomping on own mem
    1807              ;;                      mov t1, *sp(#21)                ; stomping on own mem
    1807              ;;                      mov mmap(ST2_55), t2
    1807              ;;                      mov t2, *sp(#22)
    1807              ;                       mov t2, *sp(#27)
    1807              ;;                      mov mmap(ST2_55), t3
    1807              ;                       mov t3, *sp(#28)
    1807              ;;                      mov t3, *sp(#24)
    1807              
    1807              ;                       PSH dbl(AR0) ; 32-bit
    1807              ;                       PSH dbl(AR1) 
    1807              ;                       PSH dbl(AR2) ; 32-bit
    1807              ;                       PUSH XAR3 ; 32-bit
    1807              ;                       PUSH XAR4 ; 32-bit
    1807                              ;-- Comment these to save cycles --------
    1807              ;                       PUSH XAR5 ; 32-bit
    1807              ;                       PUSH XAR6 ; 32-bit
    1807              ;                       PUSH XAR7 ; 32-bit
    1807                              ;----------------------------------------
    1807              
    1807              ;                       PUSH XT   ; 32-bit
    1807              
    1807              ;                       movl xar6, @_portFLAGS_INT_ENABLED
    1807              ;                       push xar6 ; portFLAGS_INT_ENABLED
    1807              ; +++===+++
    1807              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1807              ;                       mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
    1807              ;                       mov dbl (*ar7(#2)), xssp
    1807              
    1807 0005e4 ED31                          mov dbl (*(#_portFLAGS_INT_ENABLED)), xar6
         0005e6 EF00 
         0005e8 0000!
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   70

    1807 0005ea EB32                          mov xar6, dbl(*sp(#25))
         0005ec E5   
    1807              
    1807              ;                       movl xar7, @_usCriticalNesting
    1807              ;                       push xar7
    1807 0005ed ED31                          mov dbl (*(#_usCriticalNesting)), xar7
         0005ef FF00 
         0005f1 0000!
    1807 0005f3 EB2E                          mov xar7, dbl(*sp(#23))
         0005f5 F5   
    1807              
    1807 0005f6 EC31                          amov #0x000000, xar7
         0005f8 FE00 
         0005fa 0000 
    1807 0005fc EC31                          amov #0x000000, xar6
         0005fe EE00 
         000600 0000 
    1807              
    1807 000602 AF06                          mov mmap(ST1_55), ar7
         000604 98   
    1807 000605 CF02                          mov ar7, *sp(#1)
    1807 000607 AF96                          mov  mmap(ST2_55), ar7
         000609 98   
    1807 00060a CF04                          mov ar7, *sp(#2)
    1807              
    1807 00060c 449F                          mov ssp, ar7
    1807              ;                       mov *(#_LOOP_BITS), ar6                 ; save LOOP_BITS (CFCT)
    1807              ;                       and #0xFF00, ar6
    1807              ;                       mov ar6, *ar7(#1)
    1807              
    1807 00060e AE04                          mov mmap(ST0_55), ar6
         000610 98   
    1807 000611 CEED                          mov ar6, *ar7(#2)
         000613 0002 
    1807                                      
    1807 000615 AE31                          mov *(#_DBSTAT_SAVE), ar6               ; save DBSTAT
         000617 0000 
         000619 00!  
    1807 00061a CEED                          mov ar6, *ar7(#1)
         00061c 0001 
    1807              ; +++===+++
    1807              ;                       mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
    1807              ;                       mov dbl (*(#_save_xssp)), xssp          
    1807              ;;;                     mov  dbl (*(_DBSTAT_SAVE)), *xar7(#2)   ; needs to be DBSTAT - don't overwrite DBSTAT
    1807              ;;;                     mov ar6, *ar7(#2)
    1807              ;                       mov ar7, mmap(ST0_55)
    1807              ;                       mov *ssp(#2), ar7
    1807              ; fix up
    1807              ;                       aadd #20, sp
    1807              ;                       mov sp, t0
    1807              ;                       sub #1, t0
    1807              ;                       mov t0, ssp
    1807              
    1807                                      ; move contents of SP into address of current TCB
    1807              ;                       mov xsp, dbl (*(#_pxCurrentTCB))                ; xsp contains our TCB now
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   71

    1807              
    1807              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1807              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1807              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1807              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1807              ;                       mov dbl (*ar7+), xssp
    1807              
    1807              ;                       mov sp, t0              ; we've already saved t0
    1807              ;                       add #1, t0
    1807              ;                       mov t0, ssp
    1807              ; ??
    1807              ;                       mov xsp, dbl (*(#_pxCurrentTCB))
    1807              
    1807              ;                       movl xar6, @_pxCurrentTCB ; XAR6 contains current TCB addr
    1807              ;                       mov al, @sp
    1807              ;                       movl  *xar6, acc        
    1807              ;;                      mov  ar0, @sp
    1807              ;;                      mov  @ar6, alxd
    1807              ;;                      mov  ar0, @sp
    1807              ;;                      movl 0(xar6), sp
    1807              ;                       EDIS
    1807              ;                       NASP
    1807              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1807              ;                       NOP
    1807              ;                       .if configSTACK_PTR_DEBUG == 1
    1807              ;                       mov xsp, dbl(*(#_Ssave_xsp))
    1807              ;            mov xssp, dbl(*(#_Ssave_xssp))
    1807              ;            .endif
    1807                              .if 0
    1807                                      mov  xar7, dbl (*(#_save_xar7))                 ; restore xar7
    1807                          mov  xar6, dbl (*(#_save_xar6))
    1807              
    1807                              amov #0x000000, xar7
    1807                                      amov #0x000000, xar6
    1807                                  mov dbl (*(#_pxCurrentTCB)), xar7
    1807                                      mov dbl (*ar7), xar6                            ; xsp normal position
    1807                                      add #0x0064, ar6
    1807                                      mov xar6, xsp                                           ; actual xsp
    1807                                      mov dbl (*ar7(#2)), xar6                        ; xssp
    1807                                      add #0x0002, ar6
    1807                                      mov xar6, xssp
    1807              
    1807                          mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1807                          mov dbl (*(#_save_xar6)), xar6
    1807                        .endif
    1807              
    1807              ;;;;                    mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
    1807              ;;;;                    mov dbl (*(#_save_xssp)), xssp
    1807              
    1807 00061e ED31                          mov dbl (*(#_Ssave_xsp)), xsp                   ; restore xsp*
         000620 4F00 
         000622 0000!
    1807 000624 ED31                          mov dbl (*(#_Ssave_xssp)), xssp                 ; restore xssp
         000626 5F00 
         000628 0000!
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   72

    1807              
    1807 00062a 20                            nop
    1807              ;                       aadd #-1, sp
    1807 00062b 20                            nop
    1807              
    1807 00062c 20                            nop
    1807                                                                                      ; ?
    1808              
    1809              ;        /* Switch to the highest priority task that is ready to run. */
    1810 00062d 6C00          call    #_vTaskSwitchContext
         00062f 0000!
    1811                                      .if 1
    1812 000631 EB31                          mov xar7, dbl (*(#_save_xar7))                  ; save xar7
         000633 F500 
         000635 0000!
    1813 000637 EB31              mov xar6, dbl (*(#_save_xar6))
         000639 E500 
         00063b 0000!
    1814 00063d EB31              mov ac0, dbl (*(#_save_ac0))                  ; save xar7
         00063f 0800 
         000641 0000!
    1815 000643 EB31              mov ac1, dbl (*(#_save_ac1))
         000645 1800 
         000647 0000!
    1816 000649 EB31              mov xar1, dbl(*(#_save_xar1))
         00064b 9500 
         00064d 0000!
    1817 00064f EC31              amov #0x000000, xar7
         000651 FE00 
         000653 0000 
    1818 000655 EC31                          amov #0x000000, xar6
         000657 EE00 
         000659 0000 
    1819 00065b ED31                          mov dbl (*(_xCompareTCB)), xar6
         00065d EF00 
         00065f 0000!
    1820 000661 ED31                      mov dbl (*(#_pxCurrentTCB)), xar7
         000663 FF00 
         000665 0000!
    1821                          ; need to restore our return address
    1822 000667 3C00              mov #0x000000, ac0
    1823 000669 3C01                          mov #0x000000, ac1
    1824 00066b 90F0                          mov xar7, ac0
    1825 00066d 90E1              mov xar6, ac1
    1826 00066f 1210                  CMPU AC1 == AC0, TC1 ; |1393|
         000671 04   
    1827 000672 6464              BCC $B,TC1 ; |1393|
    1828 000674 20                nop                 ; breakpoint here - context switch has occurred
    1829                          .if configUSE_TICK_CTR == 1
    1830 000675 F731                      add #1, *(#_context_switch_counter)
         000677 0001 
         000679 0000 
         00067b 00!  
    1831                                  .endif
    1832                                  .if 0
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   73

    1833                                  amov #0x000000, xar7
    1834                                  amov #0x000000, xar1
    1835                                  mov *(#_save_new_pxcode), ar7
    1836                                  mov *ar6(#0), ar1
    1837                                  add #0x0064, ar1
    1838                                  mov ar7, *ar1
    1839                                  mov *(#_save_new_pxlcode), ar7
    1840                                  amov #0x000000, xar1
    1841                                  mov *ar6(#2), ar1
    1842                                  add #0x0002, ar1
    1843                                  mov ar7, *ar1
    1844                                  .endif
    1845                                  ; amov #0x000000, xar7
    1846                                      ;    amov #0x000000, xar6
    1847                          ;  mov  *(#_save_new_pxcode), ar7
    1848                                      ;    mov ar7, *sp(#0)
    1849                          ;                mov *(#_save_new_pxlcode) , ar7
    1850                          ;                mov ssp, ar6
    1851                          ;                mov ar7, *ar6(#0)
    1852              
    1853                          ;                mov dbl (*(#_save_xar6)), xar6
    1854                                      ;                       .endif
    1855              ; +++===+++
    1856 00067c       $B:
    1857 00067c ED31              mov dbl (*(#_save_ac0)), ac0                  ; save xar7
         00067e 0800 
         000680 0000!
    1858 000682 ED31              mov dbl (*(#_save_ac1)), ac1
         000684 1800 
         000686 0000!
    1859 000688 ED31              mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         00068a FF00 
         00068c 0000!
    1860 00068e ED31              mov dbl (*(#_save_xar6)), xar6
         000690 EF00 
         000692 0000!
    1861 000694 ED31              mov dbl (*(#_save_xar1)), xar1
         000696 9F00 
         000698 0000!
    1862                       .endif
    1863              ;        .endif
    1864              
    1865 00069a E651          mov #1, *port(#6166) ; |127|
         00069c 0118 
         00069e 16   
    1866 00069f F551                  or #0x0001, *port(#7188) ; |130|
         0006a1 0001 
         0006a3 1C14 
    1867 0006a5 4E01                  aadd #1, sp
    1868 ****** MACRO         portRESTORE_CONTEXT
    1868                                      .C54CM_off
    1868              ;                       .CPL_off
    1868                                      .ARMS_off
    1868                                      .align 4
    1868              
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   74

    1868              ; Restore context & return - here we need to know what context we're in
    1868                                      ;CONTEXT_RESTORE
    1868              ;                       ASP
    1868              ;                       EALLOW
    1868              ;                       nop
    1868              ;                       nop
    1868              ;                       nop
    1868              ;                       nop
    1868 0006a8 4652                  bclr C54CM
    1868 0006aa 20                    nop
    1868 0006ab 20                    nop
    1868 0006ac 20                    nop
    1868 0006ad 20                    nop
    1868 0006ae 20                    nop
    1868 0006af 20                    nop
    1868              ;               xssp = dbl(*(#_pxCurrentTCB))
    1868              ;               xsp  = dbl(*(#_pxCurrentTCB))
    1868 0006b0 EB31                          mov xar7, dbl (*(#_save_xar7))  
         0006b2 F500 
         0006b4 0000!
    1868 0006b6 EB31                          mov xar6, dbl (*(#_save_xar6))
         0006b8 E500 
         0006ba 0000!
    1868              
    1868              ;;;;                     aadd #-3, sp                           ;;;;
    1868              ;            aadd #-3, xsp
    1868              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1868              ;            BCC $1,TC1 ; |216|
    1868              ;;                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1868              ;;                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1868              ;            B $4
    1868              ;;              aadd #-2, sp
    1868 0006bc EB31                          mov xsp, dbl (*(#_restore_xsp))                 ; save xsp
         0006be 4500 
         0006c0 0000!
    1868 0006c2 EB31                          mov xssp, dbl (*(#_restore_xssp))                       ; save xssp
         0006c4 5500 
         0006c6 0000!
    1868               ;                      aadd #3, xsp
    1868              ;;;             aadd #-3, sp
    1868              
    1868              ;;;;            mov dbl(*(#_root_xsp)), xsp
    1868              ;;;;                    mov dbl(*(#_root_xssp)), xssp
    1868              ;;;                     aadd #3, sp
    1868              
    1868              ;$1
    1868              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1868              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
    1868              ;$4
    1868                                      .if 1
    1868              ;;                      mov xsp, xar7
    1868              ;;                      mov xssp, xar6
    1868 0006c8 EC31                          amov #0x000000, xar2
         0006ca AE00 
         0006cc 0000 
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   75

    1868 0006ce EC31                          amov #0x000000, xar1
         0006d0 9E00 
         0006d2 0000 
    1868              
    1868 0006d4 ED31                          mov dbl (*(#_pxCurrentTCB)), xar5
         0006d6 DF00 
         0006d8 0000!
    1868                                                                                               ;; points to our variables n
    1868 0006da EDA1                          mov dbl (*ar5), xar4                            ; xsp contains our TCB now
         0006dc CF   
    1868 0006dd EDAD                          mov dbl (*ar5(#2)), xar3
         0006df BF00 
         0006e1 02   
    1868 0006e2 7BFF                          add #-3, ar4
         0006e4 FDCC 
    1868 0006e6 7BFF                          add #-3, ar3
         0006e8 FDBB 
    1868                                      
    1868 0006ea 90C4                          mov xar4, xsp
    1868 0006ec 90B5                          mov xar3, xssp
    1868              
    1868              ;;;                     mov *ar4, ar2
    1868              ;;;                     mov *ar3, ar1                           ; maybe not on a yield here
    1868              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1868              ;;;                     mov ar2, *ar7
    1868              ;;;                     mov ar1, *ar6
    1868              
    1868 0006ee AF06                          mov mmap(ST1_55), ar7
         0006f0 98   
    1868 0006f1 7DF7                          and #0xf7ff, ar7                        ; <here>#0800h
         0006f3 FFFF 
    1868 0006f5 CF02                          mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1868 0006f7 CF8D                          mov ar7, *ar4(#1)                       ; save in TCB
         0006f9 0001 
    1868 0006fb AF96                          mov mmap(ST2_55), ar7
         0006fd 98   
    1868 0006fe CF04                          mov ar7, *sp(#2)
    1868 000700 CF8D                          mov ar7, *ar4(#2)
         000702 0002 
    1868              
    1868 000704 449F                          mov ssp, ar7
    1868 000706 AE04                          mov mmap(ST0_55), ar6
         000708 98   
    1868 000709 CEED                          mov ar6, *ar7(#2)
         00070b 0002 
    1868 00070d CE6D                          mov ar6, *ar3(#2)
         00070f 0002 
    1868 000711 AE31                          mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
         000713 0000 
         000715 00!  
    1868              ;;                      mov ar6, *ar7(#1)
    1868 000716 CE6D                          mov ar6, *ar3(#1)
         000718 0001 
    1868                                      .endif
    1868              
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   76

    1868              ;                       mov #0, ssp     
    1868              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1868              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1868                                      ; 32-bit mode - will act on SP and SSP:
    1868              ;                       'fix-up' current SP and SSP - is this dangerous????
    1868              ;                       aadd #-3, sp
    1868              ;;                      mov *ar7, *sp
    1868              ;                       mov dbl (*ar7), ar6
    1868              ;                       mov ar6, *sp                            ; xsp contains our TCB now
    1868              ;                       mov *ar7(#2), *ssp                      
    1868              ;                       POP mmap(ST3_55)
    1868              ;                       pshboth xar7                            ; should increment both
    1868                                      .if 0
    1868                                      mov mmap(ST1_55), ar7
    1868                                      and #0xf7ff, ar7                        ; <here>#0800h
    1868                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1868                                      mov mmap(ST2_55), ar7
    1868                                      mov ar7, *sp(#2)
    1868              
    1868                                      mov ssp, ar7
    1868                                      mov mmap(ST0_55), ar6
    1868                                      mov ar6, *ar7(#2)
    1868              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
    1868              ;;                      mov ar6, *ar7(#1)
    1868                                      .endif
    1868              ; +++===+++
    1868                                      .if 0
    1868                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1868                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1868                                      mov dbl (*ar7(#2)), xssp        
    1868                                      .endif
    1868              ; +++===+++
    1868                                      .if 0
    1868                                      mov dbl (*(_xCompareTCB)), xar6
    1868              ; need to restore our return address
    1868                                      mov xar7, ac0
    1868                                          mov xar6, ac1
    1868                                          CMPU AC1 != AC0, TC1 ; |1393|
    1868                                          BCC $6,TC1 ; |1393|
    1868                                          amov #0x000000, xar7
    1868                                          amov #0x000000, xar6
    1868                                          mov  *(#_save_new_pxcode), ar7
    1868                                          mov ar7, *sp(#0)
    1868                                          mov *(#_save_new_pxlcode) , ar7
    1868                                          mov ssp, ar6
    1868                                          mov ar7, *ar6(#0)
    1868              
    1868                                          mov dbl (*(#_save_xar6)), xar6
    1868                                                              .endif
    1868              ; +++===+++
    1868 00071a       $6_$5$:
    1868              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
    1868              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1868                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
    1868                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   77

    1868                                      mov xar6, dbl (*(#_save_xar6))
    1868              
    1868              ;; this is for debug
    1868                                      mov dbl(*ar7), xar6
    1868                                      mov dbl(*ar6), xar7
    1868                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
    1868                                      mov xssp, xar7
    1868                                      mov dbl(*ar7), xar6
    1868                                      mov dbl(*ar6), xar7
    1868                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
    1868                                      mov xssp, xar7
    1868                                      add #-2, ar7
    1868                                      mov dbl(*ar7), xar6
    1868                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
    1868                                      mov dbl (*(#_save_xar6)), xar6
    1868                                      
    1868                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1868                                      .endif
    1868              ; +++===+++
    1868              ;                       mov mmap(ST0_55), *ssp(#1)
    1868              ;                       mov mmap(STO_55), *ssp(#2)
    1868              ;                       mov mmap(ST1_55), *sp(#1)
    1868              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
    1868              ;                       mov *ar7, t0
    1868              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
    1868              ;                       mov *ar7(#2), t0
    1868              ;                       mov t0, *ssp(#0)                        
    1868              
    1868              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
    1868              ; what about xssp?
    1868              ;                       mov xar6, xsp
    1868              ;                       mov xssp, xar7
    1868              ;                       add #1, ar7
    1868              ;                       mov xar7, xsp
    1868              ;                       mov sp, t0
    1868              ;                       mov ssp, t1
    1868              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
    1868              ;                       ar0 = *ar6
    1868              ;                       xssp = xar0
    1868              ;                       mov *xar6, xar0
    1868              ;                       mov xar0, xssp  ; stack now points to our TCB
    1868              ;;                      mov sp, *ar6
    1868              ;;                      mov sp, ar0
    1868              ;;                      mov sp, *_pxCurrentTCB
    1868              ;;                      clr ar0
    1868              ;;                      mov ar0, @xar6
    1868              ;;                      mov sp, AR0
    1868              ;;                      add sp, xar6
    1868              
    1868              ;;                      pshboth xar7
    1868              ;;                      pshboth xar6
    1868              ;;                      pshboth xar5
    1868              
    1868              ;;                      popboth xar5
    1868              ;;                      popboth xar6
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   78

    1868              ;;                      popboth xar7
    1868              
    1868              ;;;                     mov *sp(#1), ar7 
    1868              ;                       mov dbl(*sp(#1)), ar7
    1868              ;;;                     mov  ar7, mmap(ST1_55)
    1868              ; +++===+++
    1868              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1868              ;                       add #0x0064, ar7
    1868              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1868              ;                       mov *ar7(#2)
    1868              ;                       mov dbl (*ar7(#2)), xssp
    1868              ; ===+++===
    1868                 .if 1
    1868 00071a EC31                  amov #0x000000, xar7
         00071c FE00 
         00071e 0000 
    1868 000720 EC31                          amov #0x000000, xar6
         000722 EE00 
         000724 0000 
    1868 000726 ED31                      mov dbl (*(#_pxCurrentTCB)), xar7
         000728 FF00 
         00072a 0000!
    1868 00072c EDE1                          mov dbl (*ar7), xar6                            ; xsp normal position
         00072e EF   
    1868 00072f 7BFF                          add #-3, ar6
         000731 FDEE 
    1868 000733 90E4                          mov xar6, xsp                                           ; actual xsp
    1868 000735 EDED                          mov dbl (*ar7(#2)), xar6                        ; xssp
         000737 EF00 
         000739 02   
    1868 00073a 7BFF                          add #-3, ar6
         00073c FDEE 
    1868 00073e 90E5                          mov xar6, xssp
    1868                 .endif
    1868              ; ===+++===
    1868              ;                       add #0x0064, xssp
    1868              ; +++===+++
    1868                                      .if 0
    1868                                      mov *sp(#2), ar7
    1868                                      mov ar7, mmap(ST2_55)
    1868                                      mov ssp, ar7
    1868                                      mov *ar7(#2), ar6
    1868                                      mov ar6, mmap(ST0_55)
    1868                                      .endif
    1868              ;                       mov *ar7(#2), ar6
    1868              ;                       mov ar6, *ssp(#2)
    1868              ;                       mov *ssp(#2), ar7
    1868              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
    1868              ;
    1868              ; restore context
    1868              
    1868 000740 EC31                          amov #0x000000, xar2
         000742 AE00 
         000744 0000 
    1868 000746 EC31                          amov #0x000000, xar1
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   79

         000748 9E00 
         00074a 0000 
    1868              
    1868                                      .if 0
    1868                                      mov mmap(ST1_55), ar7
    1868                                      and #0xf7ff, ar7                        ; <here>#0800h
    1868                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1868                                      mov ar7, mmap(ST1_55)
    1868              ;                       mov ar7, *ar4(#1)                       ; save in TCB
    1868                                      mov mmap(ST2_55), ar7
    1868                                      mov ar7, *sp(#2)
    1868              ;                       mov ar7, *ar4(#2)
    1868              
    1868                                      mov ssp, ar7
    1868                                      mov mmap(ST0_55), ar6
    1868                                      mov ar6, *ar7(#2)
    1868              ;                       mov ar6, *ar3(#2)
    1868                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
    1868                                      mov ar6, *ar7(#1)
    1868              ;                       mov ar6, *ar3(#2)
    1868                                      .endif
    1868              ;;                      mov *(#_LOOP_BITS), ar6         ; have to restore this
    1868              ;;                      and #0xFF00, ar6
    1868              ;;                      mov ar6, *ar7(#1)
    1868              
    1868 00074c 4EE6                          aadd #-26, sp
    1868              
    1868 00074e EC31                          amov #0x000000, xar7
         000750 FE00 
         000752 0000 
    1868 000754 ED32                          mov dbl(*sp(#25)), xar7
         000756 FF   
    1868              ;                       mov *sp(#1), ar7
    1868 000757 EB31                          mov xar7, dbl(*(#_usCriticalNesting))
         000759 F500 
         00075b 0000!
    1868 00075d EC31              amov #0x000000, xar6
         00075f EE00 
         000761 0000 
    1868 000763 ED2E                          mov dbl(*sp(#23)), xar6
         000765 EF   
    1868              ;                       mov *sp(#3), ar6
    1868              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
    1868 000766 EB31                          mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))
         000768 E500 
         00076a 0000!
    1868              
    1868              
    1868 00076c A400                          mov *sp(#0), t0
    1868 00076e A502                          mov *sp(#1), t1
    1868 000770 A604                          mov *sp(#2), t2
    1868 000772 A706                          mov *sp(#3), t3
    1868 000774 ED08                          mov dbl(*sp(#4)), ac0
         000776 08   
    1868 000777 A00A              mov *sp(#5), ac0
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   80

    1868 000779 ED0C                      mov dbl(*sp(#6)), xar0
         00077b 8F   
    1868 00077c A80E                          mov *sp(#7), ar0
    1868 00077e ED10                          mov dbl(*sp(#8)), xar1
         000780 9F   
    1868 000781 A912                          mov *sp(#9), ar1
    1868 000783 ED14                          mov dbl(*sp(#10)), xar2
         000785 AF   
    1868 000786 AA16                          mov *sp(#11), ar2
    1868 000788 ED18                          mov dbl(*sp(#12)), xar3
         00078a BF   
    1868 00078b AB1A                          mov *sp(#13), ar3
    1868              ;; pvPararmeters currently here - needs to be verified --- jcw
    1868 00078d ED1C                          mov dbl(*sp(#14)), xar4
         00078f CF   
    1868 000790 AC1E                          mov *sp(#15), ar4
    1868 000792 ED20                          mov dbl(*sp(#16)), xar5
         000794 DF   
    1868 000795 AD22                          mov *sp(#17), ar5
    1868 000797 ED24                          mov dbl(*sp(#18)), xar6
         000799 EF   
    1868 00079a AE26                          mov *sp(#19), ar6
    1868              
    1868              ;                       POP XT
    1868                              ;-- Comment these to save cycles ---
    1868 00079c ED28                          mov dbl(*sp(#20)), xar7
         00079e FF   
    1868 00079f AF2A                          mov *sp(#21), ar7
    1868              
    1868                                      .if 0
    1868              
    1868                                      mov dbl(*sp(#4)), xar7
    1868              ;                       mov *sp(#1), ar7
    1868                                      mov xar7, dbl(*(#_usCriticalNesting))   
    1868              
    1868                                      mov dbl(*sp(#6)), xar6
    1868              ;                       mov *sp(#3), ar6
    1868              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
    1868                                      mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))       
    1868              ;                       POP XT
    1868                              ;-- Comment these to save cycles ---
    1868                                      mov dbl(*sp(#8)), xar7
    1868                                      mov *sp(#7), ar7
    1868              ;                       mov *sp(#5), ar7
    1868              ;                       mov dbl(*sp(#0)), hi(ar7)
    1868              ;                       mov (*sp(#0)), lo(ar7)
    1868                                      mov dbl(*sp(#10)), xar6
    1868                                      mov *sp(#9), ar6
    1868                                      mov dbl(*sp(#12)), xar5
    1868                                      mov *sp(#11), ar5
    1868              ;; pvPararmeters currently here - needs to be verified --- jcw
    1868                                      mov dbl(*sp(#14)), xar4
    1868                                      mov *sp(#13), ar4
    1868                                      mov dbl(*sp(#16)), xar3
    1868                                      mov *sp(#15), ar3
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   81

    1868                                      mov dbl(*sp(#18)), xar2
    1868                                      mov *sp(#17), ar2
    1868                                      mov dbl(*sp(#20)), xar1
    1868                                      mov *sp(#19), ar1
    1868                                      mov dbl(*sp(#22)), xar0
    1868                                      mov *sp(#21), ar0
    1868                                  mov dbl(*sp(#24)), ac0
    1868                          mov *sp(#23), ac0
    1868              
    1868                                      mov *sp(#25), t3
    1868                                      mov *sp(#26), t2
    1868                                      mov *sp(#27), t1
    1868                                      mov *sp(#28), t0
    1868                                      .endif
    1868              
    1868              ;                       mov dbl(*sp(#21)), *xssp(#0)
    1868              ;                       mov *sp(#21), *ssp
    1868              ;                       mov *sp(#21), RETA
    1868              ; need to move 23-16 to XSSP contents
    1868              ;                       mov xar0, dbl (*(#_save_xar7))
    1868              ;                       mov ssp, ar0
    1868              ;                       mov #0, ssp 
    1868              ;                       mov xssp, xar0
    1868              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
    1868              ;                       aadd #20, sp            ; this is ok - ssp also incremented
    1868                      ;               add #1, xssp            ; 32-bit return address pointer
    1868                      ;               amar *xssp+
    1868              ;                       mov sp, t0
    1868              ;                       add #1, t0
    1868              ;                       mov t0, ssp
    1868              ;                       incr ssp
    1868              ;                       asub #20, ar0
    1868              ;                       mov xar0, xssp
    1868              ;                       mov ar0, ssp
    1868              ;                       mov ar0, 
    1868              ;;                      mov *sp(#1), t0
    1868              ;;                      mov *sp(#3), t3         ; ST0
    1868              ;;                      mov *sp(#4), t2         ; DBSTAT
    1868              ;;                      mov t3, *ar0(#2)
    1868                      ;;              mov t2, *ar0(#1)
    1868              ;;                      mov t0, *ar0(#0)
    1868              
    1868              ;;                      mov *sp(#5), t0
    1868              ;;                      mov *sp(#6), t1
    1868              ;;                      mov *sp(#7), t2
    1868                      ;;              mov *sp(#8), t3
    1868              
    1868              ; restore ar0
    1868              ;                       mov dbl(*sp(#-2)), xar0
    1868              ;                       mov #-1, ar0
    1868              ;;                      mov dbl (*(#_save_xar7)), xar0
    1868              ;;
    1868              ;;                      mov sp, t0
    1868              ;;                      add #1, t0
    1868              ;;                      mov t0, ssp
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   82

    1868              
    1868              ;                       mov *sp(#3), *(#00004ch+#1)
    1868              
    1868              ;                       mov t3, *ssp(#1) 
    1868              ;                       mov t2, *ssp(#2)
    1868              
    1868              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
    1868              ;;                      mov t3, *(ssp(#0))
    1868              ;                       mov t3, *ssp
    1868              ;                       mov *sp(#3), t3 ; 
    1868              ;                       mov t3, *ssp(#1)
    1868              ;;                      mov *sp(#21), PC        
    1868              
    1868              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1868              ;                       mov dbl(xsp), dbl(lcrpc)
    1868              ;                       popboth XAR7
    1868              ;                       add #1, sp
    1868              ;                       add #1, ssp
    1868              ;                       add #2, t0
    1868              ;                       add #2, t1
    1868              ;                       mov t0, sp
    1868              ;                       mov t1, ssp
    1868              ;                       popboth XAR6
    1868              ;                       add #2, t0
    1868              ;                       add #2, t1
    1868              ;                       mov t0, sp
    1868              ;                       mov t1, ssp
    1868              ;                       popboth XAR5
    1868              ;                       add #2, t0
    1868              ;                       add #2, t1
    1868              ;                       mov t0, sp
    1868              ;                       mov t1, ssp
    1868                              ;-----------------------------------
    1868              ;                       popboth XAR4
    1868              ;                       add #2, t0
    1868              ;                       add #2, t1
    1868              ;                       mov t0, sp
    1868              ;                       mov t1, ssp
    1868              ;                       popboth XAR3
    1868              ;                       add #2, t0
    1868              ;                       add #2, t1
    1868              ;                       mov t0, sp
    1868              ;                       mov t1, ssp
    1868              ;                       popboth XAR2
    1868              ;                       add #2, t0
    1868              ;                       add #2, t1
    1868              ;                       mov t0, sp
    1868              ;                       mov t1, ssp
    1868              ;                       popboth XAR1
    1868              ;                       add #2, t0
    1868              ;                       add #2, t1
    1868              ;                       mov t0, sp
    1868              ;                       mov t1, ssp
    1868              ;                       popboth XAR0
    1868              ;                       add #2, t0
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   83

    1868              ;                       add #2, t1
    1868              ;                       mov t0, sp
    1868              ;                       mov t1, ssp
    1868              ;                       EDIS
    1868              ;                       NASP    ; Un-align stack pointer
    1868              ;;                      pop mmap(ST3_55)
    1868              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1868              ;            BCC $2,TC1 ; |216|
    1868                                      .if 0
    1868                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1868              
    1868                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1868                                      mov dbl (*ar7(#2)), xssp                
    1868                                      .endif
    1868              
    1868              ;;;              mov dbl(*(#_restore_xsp)), xsp
    1868              ;;;=-=             mov dbl(*(#_restore_xssp)), xssp
    1868              ;;;=-=             mov dbl(*(#_restore_xsp)), xsp
    1868              ;;;;                    mov dbl(*(#_root_xssp)), xssp
    1868              ;;;                     aadd #3, sp
    1868              ;;;;;;                  mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1868              ;;;;;;                  mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1868              
    1868              
    1868                                      .if 0
    1868                                      mov dbl (*(_xCompareTCB)), xar6
    1868              ; need to restore our return address
    1868                                      mov xar7, ac0
    1868                          mov xar6, ac1
    1868                              CMPU AC1 != AC0, TC1 ; |1393|
    1868                          BCC $6,TC1 ; |1393|
    1868                          amov #0x000000, xar7
    1868                                      amov #0x000000, xar6
    1868                          mov  *(#_save_new_pxcode), ar7
    1868                                      mov ar7, *sp(#0)
    1868                          mov *(#_save_new_pxlcode) , ar7
    1868                          mov ssp, ar6
    1868                          mov ar7, *ar6(#0)
    1868              
    1868                          mov dbl (*(#_save_xar6)), xar6
    1868                                      .endif
    1868              
    1868              ;;                      mov dbl (*(#_save_xar7)), xar7
    1868              
    1868              ;               .if configSTACK_PTR_DEBUG == 1
    1868              ;;                      mov dbl(*(#_restore_xsp)), xsp
    1868              ;;            mov dbl(*(#_restore_xssp)), xssp
    1868              ;;            .endif
    1868              
    1868              ;                       B $3
    1868              ;$2
    1868              ;           MOV #0, *(#_first_flag) ; |217|
    1868              ;               mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1868              ;                       mov dbl (*(#_first_save_xssp)), xssp
    1868              ;$3
TMS320C55x Assembler PC v4.4.1 Fri Oct 05 00:26:39 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   84

    1868                                      .if 0
    1868                              amov #0x000000, xar7
    1868                                      amov #0x000000, xar6
    1868                                  mov dbl (*(#_pxCurrentTCB)), xar7
    1868                                      mov dbl (*ar7), xar6                            ; xsp normal position
    1868                                      add #0x0064, ar6
    1868                                      mov xar6, xsp                                           ; actual xsp
    1868                                      mov dbl (*ar7(#2)), xar6                        ; xssp
    1868                                      add #0x0002, ar6
    1868                                      mov xar6, xssp
    1868                                      .endif
    1868              
    1868              ;;;;                    aadd #-1, sp                    ; on yield, need to do this
    1868 0007a1 4E1A                          aadd #26, sp
    1868 0007a3 46B2                          bclr INTM               ; enable interrupts
    1868 0007a5 20                            nop
    1868 0007a6 20                            nop
    1868 0007a7 20                            nop
    1868 0007a8 20                            nop
    1868 0007a9 20                            nop
    1868 0007aa 20                            nop
    1868              
    1868              ;                       aadd #1, sp
    1868 0007ab 4805                          RETI
    1868              ;                       mov #1860h, ssp
    1868 0007ad 20                            nop
    1868 0007ae 20                            nop
    1868              ;                       nop
    1869              
    1870              ;;;
    1871              
    1872              ;                /* Place the tick ISR in the correct vector. */
    1873              
    1874              ;;;                .sect ".int49"                       ; TIMER1_A0_VECTOR
    1875              ;;                .sect ".int14"                        ; CPUTIMER2
    1876              ;                 .sect ".text"                 ; CPUTIMER2
    1877              ;;;;             .sect ".INT14_ISR"
    1878              ;               .global _INT14_ISR
    1879              ;;;; _INT14_ISR:
    1880              ;;;;                .short   _vTickISR
    1881              ;;;;            LCR #_vTickISR
    1882                                      .end

No Assembly Errors, No Assembly Warnings
