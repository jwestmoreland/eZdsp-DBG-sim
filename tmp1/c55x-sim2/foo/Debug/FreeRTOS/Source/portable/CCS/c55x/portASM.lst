TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    1

    1808              ; Temporary Registers Used: None
       1              ; .cdecls C, LIST, "FreeRTOSConfig.h"
       2              ;  .include "FreeRTOSConfig.h"
       3              ; 32-bit stack slow mode
       4                      .mmregs
       5                       .C54CM_off
       6              ;     .CPL_off
       7                    .ARMS_off
       8                       .align 4
       9              ;       .c28_amode
      10              
      11                           .global _usCriticalNesting
      12                           .global _save_xsp
      13                           .global _Ssave_xssp
      14                           .global _Ssave_xsp
      15                           .global _save_xssp
      16                           .global _restore_xsp
      17                           .global _restore_xssp
      18                           .global _first_save_xsp
      19                           .global _first_save_xssp
      20                           .global _first_flag
      21                           .global _save_xar7
      22                           .global _tZero
      23                           .global _save_xar6
      24                                .global _save_xar1
      25                        .global _save_xar2
      26                        .global _save_xar3
      27                        .global _save_xar4
      28              
      29                           .global _pxCurrentTCB                              ;; our currently exectuting TCB
      30                           .global _xTaskIncrementTick
      31                           .ref    _xTaskIncrementTick
      32                           .global _vTaskSwitchContext
      33                           .global _prvSetupTimerInterrupt
      34                           .global _tickIRQctr                                ;; debug - to be disabled during normal run/r
      35                           .global _save_new_pxcode                           ;; updated program counter that task suspende
      36                           .global _save_new_pxlcode                          ;; sysstack contents plus loop counter conten
      37                           .global _xCompareTCB                               ;; task Control Block for comparison
      38                                        .global _save_ac0
      39                                        .global _save_ac1
      40              ;                         .ref configUSE_TICK_CTR
      41              ;                         .ref configUSE_PREEMPTION
      42                                    .global _context_switch_counter
      43                           .def _vPortYield
      44                           .def _xPortStartScheduler
      45                           .def _vTickISR
      46              ;            .def _portSAVE_CONTEXT_CALL
      47              ;            .global _portSAVE_CONTEXT_CALL
      48                           .global _vPortYield
      49                           .global _xPortStartScheduler
      50                           .global _vTickISR
      51                           .global _INT14_ISR
      52                           .global _portFLAGS_INT_ENABLED
      53                           .global _portFLAGS_INT_ENABLED_POPPED
      54                           .global _DBSTAT_SAVE
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    2

      55                           .global _DBSTAT_RESTORE
      56                           .global _LOOP_BITS
      57                           .global _STATUS0_LOW
      58                           .global _STATUS0_HIGH
      59                           .global _STATUS1_LOW
      60                           .global _STATUS1_HIGH
      61                           .global _STATUS2_LOW
      62                           .global _STATUS2_HIGH
      63                           .global _PC_REG_HIGH_SAVE
      64                           .global _PC_REG_LOW_SAVE
      65                           .global _PC_REG_HIGH_RESTORE
      66                           .global _PC_REG_LOW_RESTORE
      67              ;            .cdecls C,NOLIST,"portmacro.h"
      68              ;            .cdecls C,LIST,"FreeRTOSConfig.h"
      69              ;                       CLRC AMODE
      70              ;       System Stack
      71 000000               .text
      72              ;_portSAVE_CONTEXT_CALL:
      73              portSAVE_CONTEXT .macro 
      74              ;                       ;CONTEXT_SAVE
      75              ;                       ASP  ; Align Stack Pointer
      76              ;                       CLRC       OVM,PAGE0
      77              ;                       CLRC       AMODE
      78              ;                       EALLOW
      79                              bclr C54CM      ; temp - until we figure out what is setting this
      80              ;;;             bset INTM               ; disable interrupts - already done
      81              ;                       aadd #1, sp
      82                                      nop
      83                                      nop
      84                                      nop
      85              
      86                                      mov xsp,  dbl (*(#_Ssave_xsp))                  ; save xsp
      87                                      mov xssp, dbl (*(#_Ssave_xssp))                 ; save xssp
      88              ;;;                     mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
      89              ;;;                     mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
      90              
      91              ;                       pshboth xar7
      92              ;                       pshboth xar6
      93              ;                       pshboth xar5
      94              
      95              ;;;;                    mov xar7, dbl (*(#_save_xar7))                  ; save xar7 (already saved)
      96              ;                       .if configUSE_CONTEXT_DEBUG == 1
      97              ;;;;                    mov xar6, dbl (*(#_save_xar6))                  ; saved in vTick ISR already
      98              ;                       .endif
      99                                      aadd #1, sp
     100              ; +++===+++
     101              
     102                                      .if 1                                                           ; need to figure out 
     103                                      mov xar1, dbl (*(#_save_xar1))
     104                                      mov xar2, dbl (*(#_save_xar2))
     105                                      mov xar3, dbl (*(#_save_xar3))
     106                                      mov xar4, dbl (*(#_save_xar4))
     107                                      amov #0x000000, xar5
     108                                      amov #0x000000, xar6
     109                                      mov xsp, xar5
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    3

     110                                      mov xssp, xar6
     111                                      amov #0x000000, xar2
     112                                      amov #0x000000, xar1
     113                                      amov #0x000000, xar3
     114                                      amov #0x000000, xar4
     115              ;                       mov dbl (*(#_pxCurrentTCB)), xar5
     116              
     117                                      mov dbl (*ar7), xar4                            ; xsp contains our TCB now
     118                                      mov dbl (*ar7(#2)), xar3
     119                                      add #0x0064, ar4
     120                                      add #0x0002, ar3
     121              
     122                                      mov *ar5(#0), ar2                               ; current xsp contents
     123                                      mov *ar6(#0), ar1                               ; current xssp contents
     124              ;                       mov ar4, *ar6                           ; stack pointers fixed up
     125                                      mov ar2, *ar4                           ; saves our new PC - but, does this work in e
     126                                      mov ar1, *ar3
     127                                      .endif
     128              ;;                      aadd #1, sp
     129                                      .if 0
     130                          amov #0x000000, xar7
     131                                      mov dbl (*(#_pxCurrentTCB)), xar7
     132                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     133                                      mov dbl (*ar7(#2)), xssp
     134                          amov #0x000000, xar7
     135                                      amov #0x000000, xar6
     136                          mov *(#_save_new_pxcode), ar7
     137                          mov ar7, *sp(#0)
     138                          amov #0x000000, xar7
     139                          mov ssp, ar6
     140                          mov *(#_save_new_pxlcode), ar7
     141              ;            mov ar7, *ssp(#0)
     142                          mov ar7, *ar6(#0)
     143                              .endif
     144              
     145              ;                       mov ssp, ar7
     146              ;                       mov *ar7(#1), ar6                               ; this is (one)two away now
     147              ;                       mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
     148              ;                       .endif
     149              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7
     150              ;            mov xar6, dbl (*(#_save_xar6))                  ; save x
     151                                      .if 0
     152                                      amov #0x000000, xar7
     153                                      amov #0x000000, xar6
     154                          mov *sp(#0), ar7                                            ;; sp+3
     155                          mov ar7, *(#_save_new_pxcode)
     156                          mov ssp, ar6
     157                          mov *ar6(#1), ar7                                                       ;; ssp+3
     158                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and if a task, it
     159                                   ;   nop
     160                          mov dbl (*(#_pxCurrentTCB)), xar7
     161                          mov xar7, dbl(*(#_xCompareTCB))
     162                          .endif
     163              ; +++===+++
     164              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    4

     165              ;
     166              
     167              
     168              ; +++===+++
     169                                      .if 0
     170              ;                       mov dbl (*(_xCompareTCB)), xar6                 ; need to save our return address
     171              ;                       mov xar7, ac0
     172              ;               mov xar6, ac1
     173              ;                       CMPU AC1 != AC0, TC1
     174              ;                               BCC $5,TC1
     175                                      amov #0x000000, xar7
     176                                          amov #0x000000, xar6
     177                                          mov  *(#_save_new_pxcode), ar7
     178                                          mov ar7, *sp(#0)
     179                              mov *(#_save_new_pxlcode) , ar7
     180                              mov ssp, ar6
     181                              mov ar7, *ar6(#0)
     182                              mov dbl (*(#_save_xar6)), xar6
     183                                         .endif
     184              ; +++===+++
     185              $5:
     186                                              
     187              ; +++===+++
     188              ;; what about xssp here?
     189              ;;                              mov xsp, dbl (*(#_save_xsp))                    ; save xsp
     190              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
     191                                 .if configUSE_CONTEXT_DEBUG == 1
     192              ;; save current PC (and possible loop bits values)
     193              ;; for debug - to see if this is being corrupted
     194                                      mov dbl(*ar7), xar6
     195                                      mov dbl(*ar6), xar7
     196                                      mov xar7, dbl (*(#_PC_REG_LOW_SAVE))            ; save off the PC
     197                                      mov xssp, xar7
     198                                      mov dbl(*ar7), xar6
     199                                      mov dbl(*ar6), xar7
     200                                      mov xar7, dbl (*(#_PC_REG_HIGH_SAVE))           ; save off the PC
     201                                      mov xssp, xar7
     202                                      add #-2, ar7
     203                                      mov dbl(*ar7), xar6
     204                                      mov xar6,  dbl (*(_DBSTAT_SAVE))
     205                          mov dbl (*(#_save_xar6)), xar6
     206              
     207              ;            mov (*ar7), (*(#_PC_REG_LOW_SAVE))
     208              ;            mov dbl(*xssp),(*(#_PC_REG_HIGH_SAVE))
     209              ;                       mov (*ssp(#-2)), (*(#_DBSTAT_SAVE))
     210                                      .endif
     211              ; +++===+++
     212                                      ; save context in our stack(s) frame
     213              
     214              ;;;;                    mov dbl (*(#_pxCurrentTCB)), xar7
     215              ;;;                     mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     216              ;;;                     mov dbl (*ar7(#2)), xssp
     217              ; +++===+++
     218              ;                   mov dbl (*(#_pxCurrentTCB)), xar7
     219                                  ; add #0x0064, ar7
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    5

     220              ;                       mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
     221              ;                       mov dbl (*ar7(#2)), xssp
     222              ;           add #0x0064, ar4
     223              ;                       add #0x0064, ar3
     224              ;                       mov dbl (*ar5), xar4                            ; xsp contains our TCB now
     225              ;                       mov dbl (*ar5(#2)), xar3                        ; xssp
     226              ;                       add #0x0064, ar4
     227              ;                       add #0x0064, ar3
     228                              amov #0x000000, xar7
     229                                      amov #0x000000, xar6
     230                                  mov dbl (*(#_pxCurrentTCB)), xar7
     231                                      mov dbl (*ar7), xar6                            ; xsp normal position
     232                                      add #0x0064, ar6
     233                                      mov xar6, xsp                                           ; actual xsp
     234                                      mov dbl (*ar7(#2)), xar6                        ; xssp
     235                                      add #0x0002, ar6
     236                                      mov xar6, xssp
     237              
     238                          mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
     239                          mov dbl (*(#_save_xar6)), xar6
     240              ;            mov dbl (*(#_save_xar1)), xar1                  ; restore xar7
     241              ;            mov dbl (*(#_save_xar2)), xar2
     242              ;            mov dbl (*(#_save_xar3)), xar3                  ; restore xar7
     243              ;            mov dbl (*(#_save_xar4)), xar4
     244                                        ; restore xar6
     245              ;;; begin context save:
     246              
     247                                      mov xar7, dbl(*sp(#8))                          ; save xar7
     248                                      mov ar7, *sp(#7)
     249              
     250                                      mov xar6, dbl(*sp(#10))
     251                                      mov ar6, *sp(#9)
     252              
     253                                      mov xar5, dbl(*sp(#12))
     254                                      mov ar5, *sp(#11)
     255              
     256                                      mov xar4, dbl(*sp(#14))
     257                                      mov ar4, *sp(#13)
     258              
     259                                      mov xar3, dbl(*sp(#16))
     260                                      mov ar3, *sp(#15)
     261              
     262                                      mov xar2, dbl(*sp(#18))
     263                                      mov ar2, *sp(#17)
     264              
     265                                      mov xar1, dbl(*sp(#20))
     266                                      mov ar1, *sp(#19)
     267              
     268                                      mov xar0, dbl(*sp(#22))
     269                                      mov ar0, *sp(#21)
     270              
     271                          mov  ac0, dbl(*sp(#24))
     272                          mov ac0, *sp(#23)
     273              
     274                                      mov t3, *sp(#25)
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    6

     275                                      mov t2, *sp(#26)
     276                                      mov t1, *sp(#27)
     277                                      mov t0, *sp(#28)
     278              ; +++===+++
     279              ;;                      mov mmap(ST0_55), t0
     280              ; - this is ok - we are not pushing - it's a relative stack frame
     281              ;                       mov t0, *sp(#25)
     282              ;;                      mov t0, *sp(#23)
     283              ;;                      mov mmap(ST1_55), t1
     284              ;                       mov t1, *sp(#26)                ; stomping on own mem
     285              ;;                      mov t1, *sp(#21)                ; stomping on own mem
     286              ;;                      mov mmap(ST2_55), t2
     287              ;;                      mov t2, *sp(#22)
     288              ;                       mov t2, *sp(#27)
     289              ;;                      mov mmap(ST2_55), t3
     290              ;                       mov t3, *sp(#28)
     291              ;;                      mov t3, *sp(#24)
     292              
     293              ;                       PSH dbl(AR0) ; 32-bit
     294              ;                       PSH dbl(AR1) 
     295              ;                       PSH dbl(AR2) ; 32-bit
     296              ;                       PUSH XAR3 ; 32-bit
     297              ;                       PUSH XAR4 ; 32-bit
     298                              ;-- Comment these to save cycles --------
     299              ;                       PUSH XAR5 ; 32-bit
     300              ;                       PUSH XAR6 ; 32-bit
     301              ;                       PUSH XAR7 ; 32-bit
     302                              ;----------------------------------------
     303              
     304              ;                       PUSH XT   ; 32-bit
     305              
     306              ;                       movl xar6, @_portFLAGS_INT_ENABLED
     307              ;                       push xar6 ; portFLAGS_INT_ENABLED
     308              ; +++===+++
     309              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     310              ;                       mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
     311              ;                       mov dbl (*ar7(#2)), xssp
     312              
     313                                      mov dbl (*(#_portFLAGS_INT_ENABLED)), xar6
     314                                      mov xar6, dbl(*sp(#6))
     315              
     316              ;                       movl xar7, @_usCriticalNesting
     317              ;                       push xar7
     318                                      mov dbl (*(#_usCriticalNesting)), xar7
     319                                      mov xar7, dbl(*sp(#4))
     320              
     321                                      amov #0x000000, xar7
     322                                      amov #0x000000, xar6
     323              
     324                                      mov mmap(ST1_55), ar7
     325                                      mov ar7, *sp(#1)
     326                                      mov  mmap(ST2_55), ar7
     327                                      mov ar7, *sp(#2)
     328              
     329                                      mov ssp, ar7
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    7

     330              ;                       mov *(#_LOOP_BITS), ar6                 ; save LOOP_BITS (CFCT)
     331              ;                       and #0xFF00, ar6
     332              ;                       mov ar6, *ar7(#1)
     333              
     334                                      mov mmap(ST0_55), ar6
     335                                      mov ar6, *ar7(#2)
     336                                      
     337                                      mov *(#_DBSTAT_SAVE), ar6               ; save DBSTAT
     338                                      mov ar6, *ar7(#1)
     339              ; +++===+++
     340              ;                       mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
     341              ;                       mov dbl (*(#_save_xssp)), xssp          
     342              ;;;                     mov  dbl (*(_DBSTAT_SAVE)), *xar7(#2)   ; needs to be DBSTAT - don't overwrite DBSTAT
     343              ;;;                     mov ar6, *ar7(#2)
     344              ;                       mov ar7, mmap(ST0_55)
     345              ;                       mov *ssp(#2), ar7
     346              ; fix up
     347              ;                       aadd #20, sp
     348              ;                       mov sp, t0
     349              ;                       sub #1, t0
     350              ;                       mov t0, ssp
     351              
     352                                      ; move contents of SP into address of current TCB
     353              ;                       mov xsp, dbl (*(#_pxCurrentTCB))                ; xsp contains our TCB now
     354              
     355              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
     356              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     357              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     358              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     359              ;                       mov dbl (*ar7+), xssp
     360              
     361              ;                       mov sp, t0              ; we've already saved t0
     362              ;                       add #1, t0
     363              ;                       mov t0, ssp
     364              ; ??
     365              ;                       mov xsp, dbl (*(#_pxCurrentTCB))
     366              
     367              ;                       movl xar6, @_pxCurrentTCB ; XAR6 contains current TCB addr
     368              ;                       mov al, @sp
     369              ;                       movl  *xar6, acc        
     370              ;;                      mov  ar0, @sp
     371              ;;                      mov  @ar6, alxd
     372              ;;                      mov  ar0, @sp
     373              ;;                      movl 0(xar6), sp
     374              ;                       EDIS
     375              ;                       NASP
     376              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
     377              ;                       NOP
     378              ;                       .if configSTACK_PTR_DEBUG == 1
     379              ;                       mov xsp, dbl(*(#_Ssave_xsp))
     380              ;            mov xssp, dbl(*(#_Ssave_xssp))
     381              ;            .endif
     382                              .if 0
     383                                      mov  xar7, dbl (*(#_save_xar7))                 ; restore xar7
     384                          mov  xar6, dbl (*(#_save_xar6))
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    8

     385              
     386                              amov #0x000000, xar7
     387                                      amov #0x000000, xar6
     388                                  mov dbl (*(#_pxCurrentTCB)), xar7
     389                                      mov dbl (*ar7), xar6                            ; xsp normal position
     390                                      add #0x0064, ar6
     391                                      mov xar6, xsp                                           ; actual xsp
     392                                      mov dbl (*ar7(#2)), xar6                        ; xssp
     393                                      add #0x0002, ar6
     394                                      mov xar6, xssp
     395              
     396                          mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
     397                          mov dbl (*(#_save_xar6)), xar6
     398                        .endif
     399              
     400              ;;;;                    mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
     401              ;;;;                    mov dbl (*(#_save_xssp)), xssp
     402              
     403                                      mov dbl (*(#_Ssave_xsp)), xsp                   ; restore xsp*
     404                                      mov dbl (*(#_Ssave_xssp)), xssp                 ; restore xssp
     405              
     406                                      nop
     407              ;                       aadd #-1, sp
     408                                      nop
     409              
     410                                      nop
     411                                                                                      ; ?
     412                                      .endm
     413              
     414              portRESTORE_CONTEXT .macro
     415                                      .C54CM_off
     416              ;                       .CPL_off
     417                                      .ARMS_off
     418                                      .align 4
     419              
     420              ; Restore context & return
     421                                      ;CONTEXT_RESTORE
     422              ;                       ASP
     423              ;                       EALLOW
     424              ;                       nop
     425              ;                       nop
     426              ;                       nop
     427              ;                       nop
     428                              bclr C54CM
     429                              nop
     430                              nop
     431                              nop
     432                              nop
     433                              nop
     434                              nop
     435              ;               xssp = dbl(*(#_pxCurrentTCB))
     436              ;               xsp  = dbl(*(#_pxCurrentTCB))
     437                                      mov xar7, dbl (*(#_save_xar7))  
     438                                      mov xar6, dbl (*(#_save_xar6))
     439              
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    9

     440              ;                        aadd #-3, sp                           ;;;;
     441              ;            aadd #-3, xsp
     442              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
     443              ;            BCC $1,TC1 ; |216|
     444              ;;                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
     445              ;;                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
     446              ;            B $4
     447                                      mov xsp, dbl (*(#_restore_xsp))                 ; save xsp
     448                                      mov xssp, dbl (*(#_restore_xssp))                       ; save xssp
     449               ;                      aadd #3, xsp
     450                              aadd #-1, sp
     451              ;$1
     452              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
     453              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
     454              ;$4
     455                                      .if 1
     456                                      mov xsp, xar7
     457                                      mov xssp, xar6
     458                                      amov #0x000000, xar2
     459                                      amov #0x000000, xar1
     460              
     461                                      mov dbl (*(#_pxCurrentTCB)), xar5
     462                                                                                               ;; points to our variables n
     463                                      mov dbl (*ar5), xar4                            ; xsp contains our TCB now
     464                                      mov dbl (*ar5(#2)), xar3
     465                                      add #0x0064, ar4
     466                                      add #0x0002, ar3
     467                                      
     468              ;;                      mov xar4, xsp
     469              ;;                      mov xar3, xssp
     470              
     471                                      mov *ar4, ar2
     472                                      mov *ar3, ar1                           ; maybe not on a yield here
     473              ;                       mov ar4, *ar6                           ; stack pointers fixed up
     474                                      mov ar2, *ar7
     475                                      mov ar1, *ar6
     476              
     477                                      mov mmap(ST1_55), ar7
     478                                      and #0xf7ff, ar7                        ; <here>#0800h
     479                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
     480                                      mov ar7, *ar4(#1)                       ; save in TCB
     481                                      mov mmap(ST2_55), ar7
     482                                      mov ar7, *sp(#2)
     483                                      mov ar7, *ar4(#2)
     484              
     485                                      mov ssp, ar7
     486                                      mov mmap(ST0_55), ar6
     487                                      mov ar6, *ar7(#2)
     488                                      mov ar6, *ar3(#2)
     489                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
     490              ;;                      mov ar6, *ar7(#1)
     491                                      mov ar6, *ar3(#1)
     492                                      .endif
     493              
     494              ;                       mov #0, ssp     
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   10

     495              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
     496              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     497                                      ; 32-bit mode - will act on SP and SSP:
     498              ;                       'fix-up' current SP and SSP - is this dangerous????
     499              ;                       aadd #-3, sp
     500              ;;                      mov *ar7, *sp
     501              ;                       mov dbl (*ar7), ar6
     502              ;                       mov ar6, *sp                            ; xsp contains our TCB now
     503              ;                       mov *ar7(#2), *ssp                      
     504              ;                       POP mmap(ST3_55)
     505              ;                       pshboth xar7                            ; should increment both
     506                                      .if 0
     507                                      mov mmap(ST1_55), ar7
     508                                      and #0xf7ff, ar7                        ; <here>#0800h
     509                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
     510                                      mov mmap(ST2_55), ar7
     511                                      mov ar7, *sp(#2)
     512              
     513                                      mov ssp, ar7
     514                                      mov mmap(ST0_55), ar6
     515                                      mov ar6, *ar7(#2)
     516              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
     517              ;;                      mov ar6, *ar7(#1)
     518                                      .endif
     519              ; +++===+++
     520                                      .if 0
     521                                      mov dbl (*(#_pxCurrentTCB)), xar7
     522                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     523                                      mov dbl (*ar7(#2)), xssp        
     524                                      .endif
     525              ; +++===+++
     526                                      .if 0
     527                                      mov dbl (*(_xCompareTCB)), xar6
     528              ; need to restore our return address
     529                                      mov xar7, ac0
     530                                          mov xar6, ac1
     531                                          CMPU AC1 != AC0, TC1 ; |1393|
     532                                          BCC $6,TC1 ; |1393|
     533                                          amov #0x000000, xar7
     534                                          amov #0x000000, xar6
     535                                          mov  *(#_save_new_pxcode), ar7
     536                                          mov ar7, *sp(#0)
     537                                          mov *(#_save_new_pxlcode) , ar7
     538                                          mov ssp, ar6
     539                                          mov ar7, *ar6(#0)
     540              
     541                                          mov dbl (*(#_save_xar6)), xar6
     542                                                              .endif
     543              ; +++===+++
     544              $6:
     545              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
     546              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
     547                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
     548                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
     549                                      mov xar6, dbl (*(#_save_xar6))
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   11

     550              
     551              ;; this is for debug
     552                                      mov dbl(*ar7), xar6
     553                                      mov dbl(*ar6), xar7
     554                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
     555                                      mov xssp, xar7
     556                                      mov dbl(*ar7), xar6
     557                                      mov dbl(*ar6), xar7
     558                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
     559                                      mov xssp, xar7
     560                                      add #-2, ar7
     561                                      mov dbl(*ar7), xar6
     562                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
     563                                      mov dbl (*(#_save_xar6)), xar6
     564                                      
     565                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
     566                                      .endif
     567              ; +++===+++
     568              ;                       mov mmap(ST0_55), *ssp(#1)
     569              ;                       mov mmap(STO_55), *ssp(#2)
     570              ;                       mov mmap(ST1_55), *sp(#1)
     571              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
     572              ;                       mov *ar7, t0
     573              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
     574              ;                       mov *ar7(#2), t0
     575              ;                       mov t0, *ssp(#0)                        
     576              
     577              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
     578              ; what about xssp?
     579              ;                       mov xar6, xsp
     580              ;                       mov xssp, xar7
     581              ;                       add #1, ar7
     582              ;                       mov xar7, xsp
     583              ;                       mov sp, t0
     584              ;                       mov ssp, t1
     585              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
     586              ;                       ar0 = *ar6
     587              ;                       xssp = xar0
     588              ;                       mov *xar6, xar0
     589              ;                       mov xar0, xssp  ; stack now points to our TCB
     590              ;;                      mov sp, *ar6
     591              ;;                      mov sp, ar0
     592              ;;                      mov sp, *_pxCurrentTCB
     593              ;;                      clr ar0
     594              ;;                      mov ar0, @xar6
     595              ;;                      mov sp, AR0
     596              ;;                      add sp, xar6
     597              
     598              ;;                      pshboth xar7
     599              ;;                      pshboth xar6
     600              ;;                      pshboth xar5
     601              
     602              ;;                      popboth xar5
     603              ;;                      popboth xar6
     604              ;;                      popboth xar7
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   12

     605              
     606              ;;;                     mov *sp(#1), ar7 
     607              ;                       mov dbl(*sp(#1)), ar7
     608              ;;;                     mov  ar7, mmap(ST1_55)
     609              ; +++===+++
     610              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     611              ;                       add #0x0064, ar7
     612              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     613              ;                       mov *ar7(#2)
     614              ;                       mov dbl (*ar7(#2)), xssp
     615              ; ===+++===
     616                 .if 0
     617                              amov #0x000000, xar7
     618                                      amov #0x000000, xar6
     619                                  mov dbl (*(#_pxCurrentTCB)), xar7
     620                                      mov dbl (*ar7), xar6                            ; xsp normal position
     621                                      add #0x0064, ar6
     622                                      mov xar6, xsp                                           ; actual xsp
     623                                      mov dbl (*ar7(#2)), xar6                        ; xssp
     624                                      add #0x0002, ar6
     625                                      mov xar6, xssp
     626                 .endif
     627              ; ===+++===
     628              ;                       add #0x0064, xssp
     629              ; +++===+++
     630                                      .if 0
     631                                      mov *sp(#2), ar7
     632                                      mov ar7, mmap(ST2_55)
     633                                      mov ssp, ar7
     634                                      mov *ar7(#2), ar6
     635                                      mov ar6, mmap(ST0_55)
     636                                      .endif
     637              ;                       mov *ar7(#2), ar6
     638              ;                       mov ar6, *ssp(#2)
     639              ;                       mov *ssp(#2), ar7
     640              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
     641              ;
     642              ; restore context
     643              
     644                                      amov #0x000000, xar2
     645                                      amov #0x000000, xar1
     646              
     647                                      .if 0
     648                                      mov mmap(ST1_55), ar7
     649                                      and #0xf7ff, ar7                        ; <here>#0800h
     650                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
     651                                      mov ar7, mmap(ST1_55)
     652              ;                       mov ar7, *ar4(#1)                       ; save in TCB
     653                                      mov mmap(ST2_55), ar7
     654                                      mov ar7, *sp(#2)
     655              ;                       mov ar7, *ar4(#2)
     656              
     657                                      mov ssp, ar7
     658                                      mov mmap(ST0_55), ar6
     659                                      mov ar6, *ar7(#2)
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   13

     660              ;                       mov ar6, *ar3(#2)
     661                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
     662                                      mov ar6, *ar7(#1)
     663              ;                       mov ar6, *ar3(#2)
     664                                      .endif
     665              ;;                      mov *(#_LOOP_BITS), ar6         ; have to restore this
     666              ;;                      and #0xFF00, ar6
     667              ;;                      mov ar6, *ar7(#1)
     668              
     669                                      mov dbl(*sp(#4)), xar7
     670              ;                       mov *sp(#1), ar7
     671                                      mov xar7, dbl(*(#_usCriticalNesting))   
     672              
     673                                      mov dbl(*sp(#6)), xar6
     674              ;                       mov *sp(#3), ar6
     675              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
     676                                      mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))       
     677              ;                       POP XT
     678                              ;-- Comment these to save cycles ---
     679                                      mov dbl(*sp(#8)), xar7
     680                                      mov *sp(#7), ar7
     681              ;                       mov *sp(#5), ar7
     682              ;                       mov dbl(*sp(#0)), hi(ar7)
     683              ;                       mov (*sp(#0)), lo(ar7)
     684                                      mov dbl(*sp(#10)), xar6
     685                                      mov *sp(#9), ar6
     686                                      mov dbl(*sp(#12)), xar5
     687                                      mov *sp(#11), ar5
     688              ;; pvPararmeters currently here - needs to be verified --- jcw
     689                                      mov dbl(*sp(#14)), xar4
     690                                      mov *sp(#13), ar4
     691                                      mov dbl(*sp(#16)), xar3
     692                                      mov *sp(#15), ar3
     693                                      mov dbl(*sp(#18)), xar2
     694                                      mov *sp(#17), ar2
     695                                      mov dbl(*sp(#20)), xar1
     696                                      mov *sp(#19), ar1
     697                                      mov dbl(*sp(#22)), xar0
     698                                      mov *sp(#21), ar0
     699                                  mov dbl(*sp(#24)), ac0
     700                          mov *sp(#23), ac0
     701              
     702                                      mov *sp(#25), t3
     703                                      mov *sp(#26), t2
     704                                      mov *sp(#27), t1
     705                                      mov *sp(#28), t0
     706              
     707              ;                       mov dbl(*sp(#21)), *xssp(#0)
     708              ;                       mov *sp(#21), *ssp
     709              ;                       mov *sp(#21), RETA
     710              ; need to move 23-16 to XSSP contents
     711              ;                       mov xar0, dbl (*(#_save_xar7))
     712              ;                       mov ssp, ar0
     713              ;                       mov #0, ssp 
     714              ;                       mov xssp, xar0
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   14

     715              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
     716              ;                       aadd #20, sp            ; this is ok - ssp also incremented
     717                      ;               add #1, xssp            ; 32-bit return address pointer
     718                      ;               amar *xssp+
     719              ;                       mov sp, t0
     720              ;                       add #1, t0
     721              ;                       mov t0, ssp
     722              ;                       incr ssp
     723              ;                       asub #20, ar0
     724              ;                       mov xar0, xssp
     725              ;                       mov ar0, ssp
     726              ;                       mov ar0, 
     727              ;;                      mov *sp(#1), t0
     728              ;;                      mov *sp(#3), t3         ; ST0
     729              ;;                      mov *sp(#4), t2         ; DBSTAT
     730              ;;                      mov t3, *ar0(#2)
     731                      ;;              mov t2, *ar0(#1)
     732              ;;                      mov t0, *ar0(#0)
     733              
     734              ;;                      mov *sp(#5), t0
     735              ;;                      mov *sp(#6), t1
     736              ;;                      mov *sp(#7), t2
     737                      ;;              mov *sp(#8), t3
     738              
     739              ; restore ar0
     740              ;                       mov dbl(*sp(#-2)), xar0
     741              ;                       mov #-1, ar0
     742              ;;                      mov dbl (*(#_save_xar7)), xar0
     743              ;;
     744              ;;                      mov sp, t0
     745              ;;                      add #1, t0
     746              ;;                      mov t0, ssp
     747              
     748              ;                       mov *sp(#3), *(#00004ch+#1)
     749              
     750              ;                       mov t3, *ssp(#1) 
     751              ;                       mov t2, *ssp(#2)
     752              
     753              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
     754              ;;                      mov t3, *(ssp(#0))
     755              ;                       mov t3, *ssp
     756              ;                       mov *sp(#3), t3 ; 
     757              ;                       mov t3, *ssp(#1)
     758              ;;                      mov *sp(#21), PC        
     759              
     760              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
     761              ;                       mov dbl(xsp), dbl(lcrpc)
     762              ;                       popboth XAR7
     763              ;                       add #1, sp
     764              ;                       add #1, ssp
     765              ;                       add #2, t0
     766              ;                       add #2, t1
     767              ;                       mov t0, sp
     768              ;                       mov t1, ssp
     769              ;                       popboth XAR6
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   15

     770              ;                       add #2, t0
     771              ;                       add #2, t1
     772              ;                       mov t0, sp
     773              ;                       mov t1, ssp
     774              ;                       popboth XAR5
     775              ;                       add #2, t0
     776              ;                       add #2, t1
     777              ;                       mov t0, sp
     778              ;                       mov t1, ssp
     779                              ;-----------------------------------
     780              ;                       popboth XAR4
     781              ;                       add #2, t0
     782              ;                       add #2, t1
     783              ;                       mov t0, sp
     784              ;                       mov t1, ssp
     785              ;                       popboth XAR3
     786              ;                       add #2, t0
     787              ;                       add #2, t1
     788              ;                       mov t0, sp
     789              ;                       mov t1, ssp
     790              ;                       popboth XAR2
     791              ;                       add #2, t0
     792              ;                       add #2, t1
     793              ;                       mov t0, sp
     794              ;                       mov t1, ssp
     795              ;                       popboth XAR1
     796              ;                       add #2, t0
     797              ;                       add #2, t1
     798              ;                       mov t0, sp
     799              ;                       mov t1, ssp
     800              ;                       popboth XAR0
     801              ;                       add #2, t0
     802              ;                       add #2, t1
     803              ;                       mov t0, sp
     804              ;                       mov t1, ssp
     805              ;                       EDIS
     806              ;                       NASP    ; Un-align stack pointer
     807              ;;                      pop mmap(ST3_55)
     808              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
     809              ;            BCC $2,TC1 ; |216|
     810                                      .if 0
     811                                      mov dbl (*(#_pxCurrentTCB)), xar7
     812              
     813                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     814                                      mov dbl (*ar7(#2)), xssp                
     815                                      .endif
     816              
     817                               mov dbl(*(#_restore_xsp)), xsp
     818                           mov dbl(*(#_restore_xssp)), xssp
     819              
     820              ;;;;;;                  mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
     821              ;;;;;;                  mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
     822              
     823              
     824                                      .if 0
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   16

     825                                      mov dbl (*(_xCompareTCB)), xar6
     826              ; need to restore our return address
     827                                      mov xar7, ac0
     828                          mov xar6, ac1
     829                              CMPU AC1 != AC0, TC1 ; |1393|
     830                          BCC $6,TC1 ; |1393|
     831                          amov #0x000000, xar7
     832                                      amov #0x000000, xar6
     833                          mov  *(#_save_new_pxcode), ar7
     834                                      mov ar7, *sp(#0)
     835                          mov *(#_save_new_pxlcode) , ar7
     836                          mov ssp, ar6
     837                          mov ar7, *ar6(#0)
     838              
     839                          mov dbl (*(#_save_xar6)), xar6
     840                                      .endif
     841              
     842              ;;                      mov dbl (*(#_save_xar7)), xar7
     843              
     844              ;               .if configSTACK_PTR_DEBUG == 1
     845              ;;                      mov dbl(*(#_restore_xsp)), xsp
     846              ;;            mov dbl(*(#_restore_xssp)), xssp
     847              ;;            .endif
     848              
     849              ;                       B $3
     850              ;$2
     851              ;           MOV #0, *(#_first_flag) ; |217|
     852              ;               mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
     853              ;                       mov dbl (*(#_first_save_xssp)), xssp
     854              ;$3
     855                                      .if 0
     856                              amov #0x000000, xar7
     857                                      amov #0x000000, xar6
     858                                  mov dbl (*(#_pxCurrentTCB)), xar7
     859                                      mov dbl (*ar7), xar6                            ; xsp normal position
     860                                      add #0x0064, ar6
     861                                      mov xar6, xsp                                           ; actual xsp
     862                                      mov dbl (*ar7(#2)), xar6                        ; xssp
     863                                      add #0x0002, ar6
     864                                      mov xar6, xssp
     865                                      .endif
     866              
     867                                      aadd #-1, sp                    ; on yield, need to do this
     868                                      bclr INTM               ; enable interrupts
     869                                      nop
     870                                      nop
     871                                      nop
     872                                      nop
     873                                      nop
     874                                      nop
     875              
     876              ;                       aadd #1, sp
     877                                      RETI
     878              ;                       mov #1860h, ssp
     879                                      nop
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   17

     880                                      nop
     881              ;                       nop
     882                                      .endm
     883              
     884              
     885              portRESTORE_FIRST_CONTEXT .macro
     886                                      .C54CM_off
     887              ;                       .CPL_off
     888                                      .ARMS_off
     889                                      .align 4
     890              
     891              ; Restore context & return
     892                                      ;CONTEXT_RESTORE
     893              ;                       ASP
     894              ;                       EALLOW
     895              ;                       nop
     896              ;                       nop
     897              ;                       nop
     898              ;                       nop
     899                              bclr C54CM
     900                              nop
     901                              nop
     902                              nop
     903              
     904              ;               xssp = dbl(*(#_pxCurrentTCB))
     905              ;               xsp  = dbl(*(#_pxCurrentTCB))
     906                                      mov xar7, dbl (*(#_save_xar7))  
     907              
     908              ; ****************************************************************************
     909              ; * Init Stack Pointer. Remember stack grows from high to low address *
     910              ; ****************************************************************************
     911              ;                       stm #_stack, sp ; set to begging of stack memory
     912              ;                       addm #(_STACK_SIZE  1), *(SP) ; add size to get to the top
     913              ;                       andm #0FFFEh, *(SP) ; make sure it is an even address
     914              
     915                                      aadd #-1, sp
     916              ;            aadd #-3, xsp
     917              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
     918              ;            BCC $1,TC1 ; |216|
     919              ;                       mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
     920              ;                       mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
     921              ;            B $4
     922              
     923              ;;                      mov xsp, dbl (*(#_save_xsp))                    ; save xsp
     924              ;;                      mov xssp, dbl (*(#_save_xssp))                  ; save xssp
     925              
     926              ;                       aadd #-3, sp
     927              ;$1
     928              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
     929              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
     930              ;$4
     931                                      .if 1
     932                                      mov xsp, xar7
     933                                      mov xssp, xar6
     934                                      mov  xsp, dbl (*(#_first_save_xsp))                     ; restore xsp
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   18

     935                                      mov  xssp, dbl (*(#_first_save_xssp))
     936                                      amov #0x000000, xar2
     937                                      amov #0x000000, xar1
     938                                      amov #0x000000, xar3
     939                                      amov #0x000000, xar4
     940              
     941                                      mov dbl (*(#_pxCurrentTCB)), xar5                               
     942                                                                                              ;; everything from here is re
     943                                      mov dbl (*ar5), xar4                            ; xsp contains our TCB now
     944                                      mov dbl (*ar5(#2)), xar3                        ; xssp          
     945                                      add #0x0064, ar4
     946                                      add #0x0002, ar3
     947                                      
     948              
     949                                      mov *ar4, ar2
     950                                      mov *ar3, ar1
     951              ;                       mov ar4, *ar6                           ; stack pointers fixed up
     952                                      mov ar2, *ar7
     953                                      mov ar1, *ar6   
     954                                      .endif
     955              
     956              ;
     957              ;                       amov #0x000000, xar7
     958              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     959              
     960              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     961              ;                       mov dbl (*ar7(#2)), xssp
     962                                      .if 0
     963                          amov #0x000000, xar7
     964                                  mov mmap(ST1_55), ar7
     965                                      and #0xf7ff, ar7                        ; <here>#0800h
     966                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
     967                                      mov ar7, *ar4(#1)                       ; save in TCB
     968                                      mov mmap(ST2_55), ar7
     969                                      mov ar7, *sp(#2)
     970                                      mov ar7, *ar4(#2)
     971                          amov #0x000000, xar6
     972                                      amov #0x000000, xar7
     973              
     974                                      mov ssp, ar7
     975                                      mov mmap(ST0_55), ar6
     976                                      mov ar6, *ar7(#2)
     977                                      mov ar6, *ar3(#2)
     978                                      
     979                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
     980              ;                       mov ar6, *ar7(#1)
     981                                      mov ar6, *ar3(#1)
     982              
     983                                      .endif
     984              
     985              ;                       mov #0, ssp     
     986              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
     987              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     988                                      ; 32-bit mode - will act on SP and SSP:
     989              ;                       'fix-up' current SP and SSP - is this dangerous????
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   19

     990              ;                       aadd #-3, sp
     991              ;;                      mov *ar7, *sp
     992              ;                       mov dbl (*ar7), ar6
     993              ;                       mov ar6, *sp                            ; xsp contains our TCB now
     994              ;                       mov *ar7(#2), *ssp                      
     995              ;                       POP mmap(ST3_55)
     996              ;                       pshboth xar7                            ; should increment both
     997                                      .if 0
     998                                      mov mmap(ST1_55), ar7
     999                                      and #0xf7ff, ar7                        ; <here>#0800h
    1000                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1001                                      mov mmap(ST2_55), ar7
    1002                                      mov ar7, *sp(#2)
    1003              
    1004                                      mov ssp, ar7
    1005                                      mov mmap(ST0_55), ar6
    1006                                      mov ar6, *ar7(#2)
    1007                                      .endif
    1008              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
    1009              ;;                      mov ar6, *ar7(#1)
    1010              
    1011                                      .if 0
    1012                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1013              
    1014                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1015                                      mov dbl (*ar7(#2)), xssp        
    1016                                      .endif
    1017              
    1018                                      .if 0                                           ; first task - no pxcode update
    1019                                          mov dbl (*(_xCompareTCB)), xar6
    1020              ; need to restore our return address
    1021                                          mov xar7, ac0
    1022                                          mov xar6, ac1
    1023                                          CMPU AC1 != AC0, TC1 ; |1393|
    1024                                          BCC $7,TC1 ; |1393|
    1025                                          amov #0x000000, xar7
    1026                                          amov #0x000000, xar6
    1027                                          mov  *(#_save_new_pxcode), ar7
    1028                                          mov ar7, *sp(#0)
    1029                                          mov *(#_save_new_pxlcode) , ar7
    1030                                          mov ssp, ar6
    1031                                          mov ar7, *ar6(#0)
    1032              
    1033                                          mov dbl (*(#_save_xar6)), xar6
    1034                                          .endif
    1035              $7:
    1036              
    1037              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
    1038              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1039                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
    1040                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1041                                      mov xar6, dbl (*(#_save_xar6))
    1042              
    1043              ;; this is for debug
    1044                                      mov dbl(*ar7), xar6
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   20

    1045                                      mov dbl(*ar6), xar7
    1046                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
    1047                                      mov xssp, xar7
    1048                                      mov dbl(*ar7), xar6
    1049                                      mov dbl(*ar6), xar7
    1050                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
    1051                                      mov xssp, xar7
    1052                                      add #-2, ar7
    1053                                      mov dbl(*ar7), xar6
    1054                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
    1055                                      mov dbl (*(#_save_xar6)), xar6
    1056                                      
    1057                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1058                                      .endif
    1059              
    1060              ;                       mov mmap(ST0_55), *ssp(#1)
    1061              ;                       mov mmap(STO_55), *ssp(#2)
    1062              ;                       mov mmap(ST1_55), *sp(#1)
    1063              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
    1064              ;                       mov *ar7, t0
    1065              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
    1066              ;                       mov *ar7(#2), t0
    1067              ;                       mov t0, *ssp(#0)                        
    1068              
    1069              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
    1070              ; what about xssp?
    1071              ;                       mov xar6, xsp
    1072              ;                       mov xssp, xar7
    1073              ;                       add #1, ar7
    1074              ;                       mov xar7, xsp
    1075              ;                       mov sp, t0
    1076              ;                       mov ssp, t1
    1077              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
    1078              ;                       ar0 = *ar6
    1079              ;                       xssp = xar0
    1080              ;                       mov *xar6, xar0
    1081              ;                       mov xar0, xssp  ; stack now points to our TCB
    1082              ;;                      mov sp, *ar6
    1083              ;;                      mov sp, ar0
    1084              ;;                      mov sp, *_pxCurrentTCB
    1085              ;;                      clr ar0
    1086              ;;                      mov ar0, @xar6
    1087              ;;                      mov sp, AR0
    1088              ;;                      add sp, xar6
    1089              
    1090              ;;                      pshboth xar7
    1091              ;;                      pshboth xar6
    1092              ;;                      pshboth xar5
    1093              
    1094              ;;                      popboth xar5
    1095              ;;                      popboth xar6
    1096              ;;                      popboth xar7
    1097              
    1098              ;;;                     mov *sp(#1), ar7 
    1099              ;                       mov dbl(*sp(#1)), ar7
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   21

    1100              ;;;                     mov  ar7, mmap(ST1_55)
    1101                      .if 1
    1102                                      amov #0x000000, xar7
    1103                                      amov #0x000000, xar6
    1104                                  mov dbl (*(#_pxCurrentTCB)), xar7
    1105                                      mov dbl (*ar7), xar6                            ; xsp normal position
    1106                                      add #0x0064, ar6
    1107                                      mov xar6, xsp                                           ; actual xsp
    1108                                      mov dbl (*ar7(#2)), xar6                        ; xssp
    1109                                      add #0x0002, ar6
    1110                                      mov xar6, xssp
    1111                  .endif
    1112                                      .if 0
    1113                                      mov *sp(#2), ar7
    1114                                      mov ar7, mmap(ST2_55)
    1115                                      mov ssp, ar7
    1116                                      mov *ar7(#2), ar6
    1117                                      mov ar6, mmap(ST0_55)
    1118                                      .endif
    1119              ;                       mov *ar7(#2), ar6
    1120              ;                       mov ar6, *ssp(#2)
    1121              ;                       mov *ssp(#2), ar7
    1122              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
    1123              
    1124                          amov #0x000000, xar7
    1125                                      amov #0x000000, xar6
    1126                                      .if 0
    1127                                      mov mmap(ST1_55), ar7
    1128                                      and #0xf7ff, ar7                        ; <here>#0800h
    1129                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1130                                      mov ar7, *ar4(#1)                       ; save in TCB
    1131                          amov #0x000000, xar7
    1132                                      mov mmap(ST2_55), ar7
    1133                                      mov ar7, *sp(#2)
    1134                                      mov ar7, *ar4(#2)
    1135                          amov #0x000000, xar7
    1136                          amov #0x000000, xar6
    1137                                      mov ssp, ar7
    1138                                      mov mmap(ST0_55), ar6
    1139                                      mov ar6, *ar7(#2)
    1140                                      mov ar6, *ar3(#2)
    1141                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
    1142                                      mov ar6, *ar7(#1)
    1143              ;                       mov ar6, *ar3(#2)
    1144                                      .endif
    1145              ;                       mov *(#_LOOP_BITS), ar6         ; have to restore this
    1146              ;                       and #0xFF00, ar6
    1147              ;                       mov ar6, *ar7(#2)
    1148              
    1149                          amov #0x000000, xar7
    1150                                      mov dbl(*sp(#4)), xar7
    1151              ;                       mov *sp(#1), ar7
    1152                                      mov xar7, dbl(*(#_usCriticalNesting))   
    1153                          amov #0x000000, xar6
    1154                                      mov dbl(*sp(#6)), xar6
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   22

    1155              ;                       mov *sp(#3), ar6
    1156              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
    1157                                      mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))       
    1158              
    1159              ;                       POP XT
    1160                              ;-- Comment these to save cycles ---
    1161                                      mov dbl(*sp(#8)), xar7
    1162                                      mov *sp(#7), ar7
    1163              ;                       mov *sp(#5), ar7
    1164              ;                       mov dbl(*sp(#0)), hi(ar7)
    1165              ;                       mov (*sp(#0)), lo(ar7)
    1166                                      mov dbl(*sp(#10)), xar6
    1167                                      mov *sp(#9), ar6
    1168                                      mov dbl(*sp(#12)), xar5
    1169                                      mov *sp(#11), ar5
    1170              ;; pvPararmeters currently here - needs to be verified --- jcw
    1171                                      mov dbl(*sp(#14)), xar4
    1172                                      mov *sp(#13), ar4
    1173                                      mov dbl(*sp(#16)), xar3
    1174                                      mov *sp(#15), ar3
    1175                                      mov dbl(*sp(#18)), xar2
    1176                                      mov *sp(#17), ar2
    1177                                      mov dbl(*sp(#20)), xar1
    1178                                      mov *sp(#19), ar1
    1179                                      mov dbl(*sp(#22)), xar0
    1180                                      mov *sp(#21), ar0
    1181                          mov dbl(*sp(#24)), ac0
    1182                          mov *sp(#23), ac0
    1183              
    1184                                      mov *sp(#25), t3
    1185                                      mov *sp(#26), t2
    1186                                      mov *sp(#27), t1
    1187                                      mov *sp(#28), t0
    1188              
    1189              ;                       mov dbl(*sp(#21)), *xssp(#0)
    1190              ;                       mov *sp(#21), *ssp
    1191              ;                       mov *sp(#21), RETA
    1192              ; need to move 23-16 to XSSP contents
    1193              ;                       mov xar0, dbl (*(#_save_xar7))
    1194              ;                       mov ssp, ar0
    1195              ;                       mov #0, ssp 
    1196              ;                       mov xssp, xar0
    1197              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
    1198              ;                       aadd #20, sp            ; this is ok - ssp also incremented
    1199                      ;               add #1, xssp            ; 32-bit return address pointer
    1200                      ;               amar *xssp+
    1201              ;                       mov sp, t0
    1202              ;                       add #1, t0
    1203              ;                       mov t0, ssp
    1204              ;                       incr ssp
    1205              ;                       asub #20, ar0
    1206              ;                       mov xar0, xssp
    1207              ;                       mov ar0, ssp
    1208              ;                       mov ar0, 
    1209              ;;                      mov *sp(#1), t0
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   23

    1210              ;;                      mov *sp(#3), t3         ; ST0
    1211              ;;                      mov *sp(#4), t2         ; DBSTAT
    1212              ;;                      mov t3, *ar0(#2)
    1213                      ;;              mov t2, *ar0(#1)
    1214              ;;                      mov t0, *ar0(#0)
    1215              
    1216              ;;                      mov *sp(#5), t0
    1217              ;;                      mov *sp(#6), t1
    1218              ;;                      mov *sp(#7), t2
    1219                      ;;              mov *sp(#8), t3
    1220              
    1221              ; restore ar0
    1222              ;                       mov dbl(*sp(#-2)), xar0
    1223              ;                       mov #-1, ar0
    1224              ;;                      mov dbl (*(#_save_xar7)), xar0
    1225              ;;
    1226              ;;                      mov sp, t0
    1227              ;;                      add #1, t0
    1228              ;;                      mov t0, ssp
    1229              
    1230              ;                       mov *sp(#3), *(#00004ch+#1)
    1231              
    1232              ;                       mov t3, *ssp(#1) 
    1233              ;                       mov t2, *ssp(#2)
    1234              
    1235              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
    1236              ;;                      mov t3, *(ssp(#0))
    1237              ;                       mov t3, *ssp
    1238              ;                       mov *sp(#3), t3 ; 
    1239              ;                       mov t3, *ssp(#1)
    1240              ;;                      mov *sp(#21), PC        
    1241              
    1242              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1243              ;                       mov dbl(xsp), dbl(lcrpc)
    1244              ;                       popboth XAR7
    1245              ;                       add #1, sp
    1246              ;                       add #1, ssp
    1247              ;                       add #2, t0
    1248              ;                       add #2, t1
    1249              ;                       mov t0, sp
    1250              ;                       mov t1, ssp
    1251              ;                       popboth XAR6
    1252              ;                       add #2, t0
    1253              ;                       add #2, t1
    1254              ;                       mov t0, sp
    1255              ;                       mov t1, ssp
    1256              ;                       popboth XAR5
    1257              ;                       add #2, t0
    1258              ;                       add #2, t1
    1259              ;                       mov t0, sp
    1260              ;                       mov t1, ssp
    1261                              ;-----------------------------------
    1262              ;                       popboth XAR4
    1263              ;                       add #2, t0
    1264              ;                       add #2, t1
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   24

    1265              ;                       mov t0, sp
    1266              ;                       mov t1, ssp
    1267              ;                       popboth XAR3
    1268              ;                       add #2, t0
    1269              ;                       add #2, t1
    1270              ;                       mov t0, sp
    1271              ;                       mov t1, ssp
    1272              ;                       popboth XAR2
    1273              ;                       add #2, t0
    1274              ;                       add #2, t1
    1275              ;                       mov t0, sp
    1276              ;                       mov t1, ssp
    1277              ;                       popboth XAR1
    1278              ;                       add #2, t0
    1279              ;                       add #2, t1
    1280              ;                       mov t0, sp
    1281              ;                       mov t1, ssp
    1282              ;                       popboth XAR0
    1283              ;                       add #2, t0
    1284              ;                       add #2, t1
    1285              ;                       mov t0, sp
    1286              ;                       mov t1, ssp
    1287              ;                       EDIS
    1288              ;                       NASP    ; Un-align stack pointer
    1289              ;;                      pop mmap(ST3_55)
    1290              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1291              ;            BCC $2,TC1 ; |216|
    1292                                      .if 0
    1293                                      amov #0x000000, xar7
    1294                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1295              
    1296                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1297                                      mov dbl (*ar7(#2)), xssp                
    1298                                      .endif
    1299              
    1300              ;;                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1301              ;;                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1302              
    1303                                      .if 0
    1304                                      mov dbl (*(_xCompareTCB)), xar6
    1305              ; need to restore our return address
    1306                                      mov xar7, ac0
    1307                          mov xar6, ac1
    1308                              CMPU AC1 != AC0, TC1 ; |1393|
    1309                          BCC $6,TC1 ; |1393|
    1310                          amov #0x000000, xar7
    1311                                      amov #0x000000, xar6
    1312                          mov  *(#_save_new_pxcode), ar7
    1313                                      mov ar7, *sp(#0)
    1314                          mov *(#_save_new_pxlcode) , ar7
    1315                          mov ssp, ar6
    1316                          mov ar7, *ar6(#0)
    1317              
    1318                          mov dbl (*(#_save_xar6)), xar6
    1319                                      .endif
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   25

    1320              
    1321              ;;                      mov dbl (*(#_save_xar7)), xar7
    1322               ;           .if configSTACK_PTR_DEBUG == 1
    1323              ;                       mov xsp, dbl(*(#_restore_xsp))
    1324              ;            mov xssp, dbl(*(#_restore_xssp))
    1325              ;            .endif
    1326              ;                       B $3
    1327              ;$2
    1328              ;            MOV #0, *(#_first_flag) ; |217|
    1329              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1330              ;                       mov dbl (*(#_first_save_xssp)), xssp
    1331              ;$3
    1332              ;;                      mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1333              ;;                      mov xssp, dbl (*(#_save_xssp))                  ; save xssp
    1334              
    1335              ;;                      aadd #-3, sp
    1336                                      mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1337                                      mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
    1338              ;$4
    1339              
    1340              ;                       aadd #-3, sp
    1341              ;                       aadd #1, sp
    1342                                      bclr INTM               ; enable interrupts
    1343                                      nop
    1344                                      nop
    1345                                      nop
    1346                                      nop
    1347                                      nop
    1348                                      nop
    1349              ;                       aadd #1, sp
    1350                                      RETI
    1351              ;                       mov #1860h, ssp
    1352                                      nop
    1353                                      nop
    1354              ;                       nop
    1355                                      .endm
    1356              ; /*-----------------------------------------------------------*/
    1357              
    1358              
    1359              
    1360              ; /*-----------------------------------------------------------*/
    1361              
    1362              ; /*
    1363              ; * The RTOS tick ISR.
    1364              ; *
    1365              ; * If the cooperative scheduler is in use this simply increments the tick
    1366              ; * count.
    1367              ; *
    1368              ; * If the preemptive scheduler is in use a context switch can also occur.
    1369              ; */
    1370              
    1371              
    1372 000000       _xPortStartScheduler:
    1373              
    1374              ;                /* Setup the hardware to generate the tick.  Interrupts are disabled
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   26

    1375              ;                when this function is called. */
    1376 000000 4EFF                 aadd #-1, sp
    1377 000002 6C00             call    #_prvSetupTimerInterrupt
         000004 0000!
    1378              
    1379              ;                /* Restore the context of the first task that is going to run. */
    1380              
    1381              ;;              INTR INT14      ; force interrupt - just for debug purposes.
    1382              
    1383              ;;            psh mmap(ST3_55)
    1384 000006 EB31                          mov xar7, dbl (*(#_save_xar7))                  ; save xar7
         000008 F500 
         00000a 0000!
    1385 00000c EB31                          mov xar6, dbl (*(#_save_xar6))                  ; save xar6
         00000e E500 
         000010 0000!
    1386              
    1387 000012 EC31                          amov #0x000000, xar7
         000014 FE00 
         000016 0000 
    1388 000018 EC31                          amov #0x000000, xar6
         00001a EE00 
         00001c 0000 
    1389              
    1390 00001e ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         000020 FF00 
         000022 0000!
    1391              ;                       add #0x0064, ar7
    1392              ; does this *always* work?
    1393 000024 EDED                          mov dbl (*ar7(#0)), xar6
         000026 EF00 
         000028 00   
    1394 000029 7B00                          add #0x0064, ar6
         00002b 64EE 
    1395              
    1396              ;                       mov xsp, dbl (*(#_save_xsp))
    1397 00002d 90E4                          mov xar6, xsp
    1398 00002f EB31                          mov xar6, dbl (*(#_save_xsp))
         000031 E500 
         000033 0000!
    1399 000035 EB31                          mov xar6, dbl (*(#_first_save_xsp))     ; (init) xsp contains our TCB now
         000037 E500 
         000039 0000!
    1400                                                                              ; (init) xsp contains our TCB now
    1401 00003b EDED                          mov dbl (*ar7(#2)), xar6
         00003d EF00 
         00003f 02   
    1402 000040 402E                          add #0x0002, ar6
    1403 000042 90E5                          mov xar6, xssp
    1404              ;                       mov xar6, dbl (*(#_save_xsp))
    1405 000044 EB31                          mov xar6, dbl (*(#_save_xssp))
         000046 E500 
         000048 0000!
    1406 00004a EB31                          mov xar6, dbl (*(#_first_save_xssp))
         00004c E500 
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   27

         00004e 0000!
    1407              
    1408              ;                       mov #1, *(#_first_flag)
    1409                                      .if 0
    1410                                      amov #0x000000, xar7
    1411                                      amov #0x000000, xar6
    1412                                      mov ssp, ar7
    1413                                      mov *ar7(#2), ar6                               ; this is two away now
    1414                                      mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
    1415                                      .endif
    1416              ; what about xssp here?
    1417 000050 ED31                          mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         000052 FF00 
         000054 0000!
    1418 000056 ED31                          mov dbl (*(#_save_xar6)), xar6                  ; restore xar6
         000058 EF00 
         00005a 0000!
    1419 00005c 4E01                          aadd #1, sp
    1420              
    1421                          .if configSTACK_PTR_DEBUG == 1
    1422                                      mov xsp, dbl(*(#_restore_xsp))
    1423                          mov xssp, dbl(*(#_restore_xssp))
    1424                          .endif
    1425              
    1426 ****** MACRO                         portRESTORE_FIRST_CONTEXT
    1426                                      .C54CM_off
    1426              ;                       .CPL_off
    1426                                      .ARMS_off
    1426                                      .align 4
    1426              
    1426              ; Restore context & return
    1426                                      ;CONTEXT_RESTORE
    1426              ;                       ASP
    1426              ;                       EALLOW
    1426              ;                       nop
    1426              ;                       nop
    1426              ;                       nop
    1426              ;                       nop
    1426 000060 4652                  bclr C54CM
    1426 000062 20                    nop
    1426 000063 20                    nop
    1426 000064 20                    nop
    1426              
    1426              ;               xssp = dbl(*(#_pxCurrentTCB))
    1426              ;               xsp  = dbl(*(#_pxCurrentTCB))
    1426 000065 EB31                          mov xar7, dbl (*(#_save_xar7))  
         000067 F500 
         000069 0000!
    1426              
    1426              ; ****************************************************************************
    1426              ; * Init Stack Pointer. Remember stack grows from high to low address *
    1426              ; ****************************************************************************
    1426              ;                       stm #_stack, sp ; set to begging of stack memory
    1426              ;                       addm #(_STACK_SIZE  1), *(SP) ; add size to get to the top
    1426              ;                       andm #0FFFEh, *(SP) ; make sure it is an even address
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   28

    1426              
    1426 00006b 4EFF                          aadd #-1, sp
    1426              ;            aadd #-3, xsp
    1426              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1426              ;            BCC $1,TC1 ; |216|
    1426              ;                       mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1426              ;                       mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1426              ;            B $4
    1426              
    1426              ;;                      mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1426              ;;                      mov xssp, dbl (*(#_save_xssp))                  ; save xssp
    1426              
    1426              ;                       aadd #-3, sp
    1426              ;$1
    1426              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1426              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
    1426              ;$4
    1426                                      .if 1
    1426 00006d 904F                          mov xsp, xar7
    1426 00006f 905E                          mov xssp, xar6
    1426 000071 EB31                          mov  xsp, dbl (*(#_first_save_xsp))                     ; restore xsp
         000073 4500 
         000075 0000!
    1426 000077 EB31                          mov  xssp, dbl (*(#_first_save_xssp))
         000079 5500 
         00007b 0000!
    1426 00007d EC31                          amov #0x000000, xar2
         00007f AE00 
         000081 0000 
    1426 000083 EC31                          amov #0x000000, xar1
         000085 9E00 
         000087 0000 
    1426 000089 EC31                          amov #0x000000, xar3
         00008b BE00 
         00008d 0000 
    1426 00008f EC31                          amov #0x000000, xar4
         000091 CE00 
         000093 0000 
    1426              
    1426 000095 ED31                          mov dbl (*(#_pxCurrentTCB)), xar5                               
         000097 DF00 
         000099 0000!
    1426                                                                                              ;; everything from here is re
    1426 00009b EDA1                          mov dbl (*ar5), xar4                            ; xsp contains our TCB now
         00009d CF   
    1426 00009e EDAD                          mov dbl (*ar5(#2)), xar3                        ; xssp          
         0000a0 BF00 
         0000a2 02   
    1426 0000a3 7B00                          add #0x0064, ar4
         0000a5 64CC 
    1426 0000a7 402B                          add #0x0002, ar3
    1426                                      
    1426              
    1426 0000a9 AA81                          mov *ar4, ar2
    1426 0000ab A961                          mov *ar3, ar1
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   29

    1426              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1426 0000ad CAE1                          mov ar2, *ar7
    1426 0000af C9C1                          mov ar1, *ar6   
    1426                                      .endif
    1426              
    1426              ;
    1426              ;                       amov #0x000000, xar7
    1426              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1426              
    1426              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1426              ;                       mov dbl (*ar7(#2)), xssp
    1426                                      .if 0
    1426                          amov #0x000000, xar7
    1426                                  mov mmap(ST1_55), ar7
    1426                                      and #0xf7ff, ar7                        ; <here>#0800h
    1426                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1426                                      mov ar7, *ar4(#1)                       ; save in TCB
    1426                                      mov mmap(ST2_55), ar7
    1426                                      mov ar7, *sp(#2)
    1426                                      mov ar7, *ar4(#2)
    1426                          amov #0x000000, xar6
    1426                                      amov #0x000000, xar7
    1426              
    1426                                      mov ssp, ar7
    1426                                      mov mmap(ST0_55), ar6
    1426                                      mov ar6, *ar7(#2)
    1426                                      mov ar6, *ar3(#2)
    1426                                      
    1426                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
    1426              ;                       mov ar6, *ar7(#1)
    1426                                      mov ar6, *ar3(#1)
    1426              
    1426                                      .endif
    1426              
    1426              ;                       mov #0, ssp     
    1426              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1426              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1426                                      ; 32-bit mode - will act on SP and SSP:
    1426              ;                       'fix-up' current SP and SSP - is this dangerous????
    1426              ;                       aadd #-3, sp
    1426              ;;                      mov *ar7, *sp
    1426              ;                       mov dbl (*ar7), ar6
    1426              ;                       mov ar6, *sp                            ; xsp contains our TCB now
    1426              ;                       mov *ar7(#2), *ssp                      
    1426              ;                       POP mmap(ST3_55)
    1426              ;                       pshboth xar7                            ; should increment both
    1426                                      .if 0
    1426                                      mov mmap(ST1_55), ar7
    1426                                      and #0xf7ff, ar7                        ; <here>#0800h
    1426                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1426                                      mov mmap(ST2_55), ar7
    1426                                      mov ar7, *sp(#2)
    1426              
    1426                                      mov ssp, ar7
    1426                                      mov mmap(ST0_55), ar6
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   30

    1426                                      mov ar6, *ar7(#2)
    1426                                      .endif
    1426              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
    1426              ;;                      mov ar6, *ar7(#1)
    1426              
    1426                                      .if 0
    1426                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1426              
    1426                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1426                                      mov dbl (*ar7(#2)), xssp        
    1426                                      .endif
    1426              
    1426                                      .if 0                                           ; first task - no pxcode update
    1426                                          mov dbl (*(_xCompareTCB)), xar6
    1426              ; need to restore our return address
    1426                                          mov xar7, ac0
    1426                                          mov xar6, ac1
    1426                                          CMPU AC1 != AC0, TC1 ; |1393|
    1426                                          BCC $7,TC1 ; |1393|
    1426                                          amov #0x000000, xar7
    1426                                          amov #0x000000, xar6
    1426                                          mov  *(#_save_new_pxcode), ar7
    1426                                          mov ar7, *sp(#0)
    1426                                          mov *(#_save_new_pxlcode) , ar7
    1426                                          mov ssp, ar6
    1426                                          mov ar7, *ar6(#0)
    1426              
    1426                                          mov dbl (*(#_save_xar6)), xar6
    1426                                          .endif
    1426 0000b1       $7_$1$:
    1426              
    1426              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
    1426              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1426                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
    1426                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1426                                      mov xar6, dbl (*(#_save_xar6))
    1426              
    1426              ;; this is for debug
    1426                                      mov dbl(*ar7), xar6
    1426                                      mov dbl(*ar6), xar7
    1426                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
    1426                                      mov xssp, xar7
    1426                                      mov dbl(*ar7), xar6
    1426                                      mov dbl(*ar6), xar7
    1426                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
    1426                                      mov xssp, xar7
    1426                                      add #-2, ar7
    1426                                      mov dbl(*ar7), xar6
    1426                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
    1426                                      mov dbl (*(#_save_xar6)), xar6
    1426                                      
    1426                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1426                                      .endif
    1426              
    1426              ;                       mov mmap(ST0_55), *ssp(#1)
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   31

    1426              ;                       mov mmap(STO_55), *ssp(#2)
    1426              ;                       mov mmap(ST1_55), *sp(#1)
    1426              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
    1426              ;                       mov *ar7, t0
    1426              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
    1426              ;                       mov *ar7(#2), t0
    1426              ;                       mov t0, *ssp(#0)                        
    1426              
    1426              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
    1426              ; what about xssp?
    1426              ;                       mov xar6, xsp
    1426              ;                       mov xssp, xar7
    1426              ;                       add #1, ar7
    1426              ;                       mov xar7, xsp
    1426              ;                       mov sp, t0
    1426              ;                       mov ssp, t1
    1426              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
    1426              ;                       ar0 = *ar6
    1426              ;                       xssp = xar0
    1426              ;                       mov *xar6, xar0
    1426              ;                       mov xar0, xssp  ; stack now points to our TCB
    1426              ;;                      mov sp, *ar6
    1426              ;;                      mov sp, ar0
    1426              ;;                      mov sp, *_pxCurrentTCB
    1426              ;;                      clr ar0
    1426              ;;                      mov ar0, @xar6
    1426              ;;                      mov sp, AR0
    1426              ;;                      add sp, xar6
    1426              
    1426              ;;                      pshboth xar7
    1426              ;;                      pshboth xar6
    1426              ;;                      pshboth xar5
    1426              
    1426              ;;                      popboth xar5
    1426              ;;                      popboth xar6
    1426              ;;                      popboth xar7
    1426              
    1426              ;;;                     mov *sp(#1), ar7 
    1426              ;                       mov dbl(*sp(#1)), ar7
    1426              ;;;                     mov  ar7, mmap(ST1_55)
    1426                      .if 1
    1426 0000b1 EC31                          amov #0x000000, xar7
         0000b3 FE00 
         0000b5 0000 
    1426 0000b7 EC31                          amov #0x000000, xar6
         0000b9 EE00 
         0000bb 0000 
    1426 0000bd ED31                      mov dbl (*(#_pxCurrentTCB)), xar7
         0000bf FF00 
         0000c1 0000!
    1426 0000c3 EDE1                          mov dbl (*ar7), xar6                            ; xsp normal position
         0000c5 EF   
    1426 0000c6 7B00                          add #0x0064, ar6
         0000c8 64EE 
    1426 0000ca 90E4                          mov xar6, xsp                                           ; actual xsp
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   32

    1426 0000cc EDED                          mov dbl (*ar7(#2)), xar6                        ; xssp
         0000ce EF00 
         0000d0 02   
    1426 0000d1 402E                          add #0x0002, ar6
    1426 0000d3 90E5                          mov xar6, xssp
    1426                  .endif
    1426                                      .if 0
    1426                                      mov *sp(#2), ar7
    1426                                      mov ar7, mmap(ST2_55)
    1426                                      mov ssp, ar7
    1426                                      mov *ar7(#2), ar6
    1426                                      mov ar6, mmap(ST0_55)
    1426                                      .endif
    1426              ;                       mov *ar7(#2), ar6
    1426              ;                       mov ar6, *ssp(#2)
    1426              ;                       mov *ssp(#2), ar7
    1426              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
    1426              
    1426 0000d5 EC31              amov #0x000000, xar7
         0000d7 FE00 
         0000d9 0000 
    1426 0000db EC31                          amov #0x000000, xar6
         0000dd EE00 
         0000df 0000 
    1426                                      .if 0
    1426                                      mov mmap(ST1_55), ar7
    1426                                      and #0xf7ff, ar7                        ; <here>#0800h
    1426                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1426                                      mov ar7, *ar4(#1)                       ; save in TCB
    1426                          amov #0x000000, xar7
    1426                                      mov mmap(ST2_55), ar7
    1426                                      mov ar7, *sp(#2)
    1426                                      mov ar7, *ar4(#2)
    1426                          amov #0x000000, xar7
    1426                          amov #0x000000, xar6
    1426                                      mov ssp, ar7
    1426                                      mov mmap(ST0_55), ar6
    1426                                      mov ar6, *ar7(#2)
    1426                                      mov ar6, *ar3(#2)
    1426                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
    1426                                      mov ar6, *ar7(#1)
    1426              ;                       mov ar6, *ar3(#2)
    1426                                      .endif
    1426              ;                       mov *(#_LOOP_BITS), ar6         ; have to restore this
    1426              ;                       and #0xFF00, ar6
    1426              ;                       mov ar6, *ar7(#2)
    1426              
    1426 0000e1 EC31              amov #0x000000, xar7
         0000e3 FE00 
         0000e5 0000 
    1426 0000e7 ED08                          mov dbl(*sp(#4)), xar7
         0000e9 FF   
    1426              ;                       mov *sp(#1), ar7
    1426 0000ea EB31                          mov xar7, dbl(*(#_usCriticalNesting))   
         0000ec F500 
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   33

         0000ee 0000!
    1426 0000f0 EC31              amov #0x000000, xar6
         0000f2 EE00 
         0000f4 0000 
    1426 0000f6 ED0C                          mov dbl(*sp(#6)), xar6
         0000f8 EF   
    1426              ;                       mov *sp(#3), ar6
    1426              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
    1426 0000f9 EB31                          mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))       
         0000fb E500 
         0000fd 0000!
    1426              
    1426              ;                       POP XT
    1426                              ;-- Comment these to save cycles ---
    1426 0000ff ED10                          mov dbl(*sp(#8)), xar7
         000101 FF   
    1426 000102 AF0E                          mov *sp(#7), ar7
    1426              ;                       mov *sp(#5), ar7
    1426              ;                       mov dbl(*sp(#0)), hi(ar7)
    1426              ;                       mov (*sp(#0)), lo(ar7)
    1426 000104 ED14                          mov dbl(*sp(#10)), xar6
         000106 EF   
    1426 000107 AE12                          mov *sp(#9), ar6
    1426 000109 ED18                          mov dbl(*sp(#12)), xar5
         00010b DF   
    1426 00010c AD16                          mov *sp(#11), ar5
    1426              ;; pvPararmeters currently here - needs to be verified --- jcw
    1426 00010e ED1C                          mov dbl(*sp(#14)), xar4
         000110 CF   
    1426 000111 AC1A                          mov *sp(#13), ar4
    1426 000113 ED20                          mov dbl(*sp(#16)), xar3
         000115 BF   
    1426 000116 AB1E                          mov *sp(#15), ar3
    1426 000118 ED24                          mov dbl(*sp(#18)), xar2
         00011a AF   
    1426 00011b AA22                          mov *sp(#17), ar2
    1426 00011d ED28                          mov dbl(*sp(#20)), xar1
         00011f 9F   
    1426 000120 A926                          mov *sp(#19), ar1
    1426 000122 ED2C                          mov dbl(*sp(#22)), xar0
         000124 8F   
    1426 000125 A82A                          mov *sp(#21), ar0
    1426 000127 ED30              mov dbl(*sp(#24)), ac0
         000129 08   
    1426 00012a A02E              mov *sp(#23), ac0
    1426              
    1426 00012c A732                          mov *sp(#25), t3
    1426 00012e A634                          mov *sp(#26), t2
    1426 000130 A536                          mov *sp(#27), t1
    1426 000132 A438                          mov *sp(#28), t0
    1426              
    1426              ;                       mov dbl(*sp(#21)), *xssp(#0)
    1426              ;                       mov *sp(#21), *ssp
    1426              ;                       mov *sp(#21), RETA
    1426              ; need to move 23-16 to XSSP contents
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   34

    1426              ;                       mov xar0, dbl (*(#_save_xar7))
    1426              ;                       mov ssp, ar0
    1426              ;                       mov #0, ssp 
    1426              ;                       mov xssp, xar0
    1426              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
    1426              ;                       aadd #20, sp            ; this is ok - ssp also incremented
    1426                      ;               add #1, xssp            ; 32-bit return address pointer
    1426                      ;               amar *xssp+
    1426              ;                       mov sp, t0
    1426              ;                       add #1, t0
    1426              ;                       mov t0, ssp
    1426              ;                       incr ssp
    1426              ;                       asub #20, ar0
    1426              ;                       mov xar0, xssp
    1426              ;                       mov ar0, ssp
    1426              ;                       mov ar0, 
    1426              ;;                      mov *sp(#1), t0
    1426              ;;                      mov *sp(#3), t3         ; ST0
    1426              ;;                      mov *sp(#4), t2         ; DBSTAT
    1426              ;;                      mov t3, *ar0(#2)
    1426                      ;;              mov t2, *ar0(#1)
    1426              ;;                      mov t0, *ar0(#0)
    1426              
    1426              ;;                      mov *sp(#5), t0
    1426              ;;                      mov *sp(#6), t1
    1426              ;;                      mov *sp(#7), t2
    1426                      ;;              mov *sp(#8), t3
    1426              
    1426              ; restore ar0
    1426              ;                       mov dbl(*sp(#-2)), xar0
    1426              ;                       mov #-1, ar0
    1426              ;;                      mov dbl (*(#_save_xar7)), xar0
    1426              ;;
    1426              ;;                      mov sp, t0
    1426              ;;                      add #1, t0
    1426              ;;                      mov t0, ssp
    1426              
    1426              ;                       mov *sp(#3), *(#00004ch+#1)
    1426              
    1426              ;                       mov t3, *ssp(#1) 
    1426              ;                       mov t2, *ssp(#2)
    1426              
    1426              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
    1426              ;;                      mov t3, *(ssp(#0))
    1426              ;                       mov t3, *ssp
    1426              ;                       mov *sp(#3), t3 ; 
    1426              ;                       mov t3, *ssp(#1)
    1426              ;;                      mov *sp(#21), PC        
    1426              
    1426              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1426              ;                       mov dbl(xsp), dbl(lcrpc)
    1426              ;                       popboth XAR7
    1426              ;                       add #1, sp
    1426              ;                       add #1, ssp
    1426              ;                       add #2, t0
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   35

    1426              ;                       add #2, t1
    1426              ;                       mov t0, sp
    1426              ;                       mov t1, ssp
    1426              ;                       popboth XAR6
    1426              ;                       add #2, t0
    1426              ;                       add #2, t1
    1426              ;                       mov t0, sp
    1426              ;                       mov t1, ssp
    1426              ;                       popboth XAR5
    1426              ;                       add #2, t0
    1426              ;                       add #2, t1
    1426              ;                       mov t0, sp
    1426              ;                       mov t1, ssp
    1426                              ;-----------------------------------
    1426              ;                       popboth XAR4
    1426              ;                       add #2, t0
    1426              ;                       add #2, t1
    1426              ;                       mov t0, sp
    1426              ;                       mov t1, ssp
    1426              ;                       popboth XAR3
    1426              ;                       add #2, t0
    1426              ;                       add #2, t1
    1426              ;                       mov t0, sp
    1426              ;                       mov t1, ssp
    1426              ;                       popboth XAR2
    1426              ;                       add #2, t0
    1426              ;                       add #2, t1
    1426              ;                       mov t0, sp
    1426              ;                       mov t1, ssp
    1426              ;                       popboth XAR1
    1426              ;                       add #2, t0
    1426              ;                       add #2, t1
    1426              ;                       mov t0, sp
    1426              ;                       mov t1, ssp
    1426              ;                       popboth XAR0
    1426              ;                       add #2, t0
    1426              ;                       add #2, t1
    1426              ;                       mov t0, sp
    1426              ;                       mov t1, ssp
    1426              ;                       EDIS
    1426              ;                       NASP    ; Un-align stack pointer
    1426              ;;                      pop mmap(ST3_55)
    1426              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1426              ;            BCC $2,TC1 ; |216|
    1426                                      .if 0
    1426                                      amov #0x000000, xar7
    1426                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1426              
    1426                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1426                                      mov dbl (*ar7(#2)), xssp                
    1426                                      .endif
    1426              
    1426              ;;                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1426              ;;                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1426              
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   36

    1426                                      .if 0
    1426                                      mov dbl (*(_xCompareTCB)), xar6
    1426              ; need to restore our return address
    1426                                      mov xar7, ac0
    1426                          mov xar6, ac1
    1426                              CMPU AC1 != AC0, TC1 ; |1393|
    1426                          BCC $6,TC1 ; |1393|
    1426                          amov #0x000000, xar7
    1426                                      amov #0x000000, xar6
    1426                          mov  *(#_save_new_pxcode), ar7
    1426                                      mov ar7, *sp(#0)
    1426                          mov *(#_save_new_pxlcode) , ar7
    1426                          mov ssp, ar6
    1426                          mov ar7, *ar6(#0)
    1426              
    1426                          mov dbl (*(#_save_xar6)), xar6
    1426                                      .endif
    1426              
    1426              ;;                      mov dbl (*(#_save_xar7)), xar7
    1426               ;           .if configSTACK_PTR_DEBUG == 1
    1426              ;                       mov xsp, dbl(*(#_restore_xsp))
    1426              ;            mov xssp, dbl(*(#_restore_xssp))
    1426              ;            .endif
    1426              ;                       B $3
    1426              ;$2
    1426              ;            MOV #0, *(#_first_flag) ; |217|
    1426              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1426              ;                       mov dbl (*(#_first_save_xssp)), xssp
    1426              ;$3
    1426              ;;                      mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1426              ;;                      mov xssp, dbl (*(#_save_xssp))                  ; save xssp
    1426              
    1426              ;;                      aadd #-3, sp
    1426 000134 ED31                          mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
         000136 4F00 
         000138 0000!
    1426 00013a ED31                          mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
         00013c 5F00 
         00013e 0000!
    1426              ;$4
    1426              
    1426              ;                       aadd #-3, sp
    1426              ;                       aadd #1, sp
    1426 000140 46B2                          bclr INTM               ; enable interrupts
    1426 000142 20                            nop
    1426 000143 20                            nop
    1426 000144 20                            nop
    1426 000145 20                            nop
    1426 000146 20                            nop
    1426 000147 20                            nop
    1426              ;                       aadd #1, sp
    1426 000148 4805                          RETI
    1426              ;                       mov #1860h, ssp
    1426 00014a 20                            nop
    1426 00014b 20                            nop
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   37

    1426              ;                       nop
    1427              
    1428              
    1429 00014c       _vTickISR:              ; the timer ISR is aggregated for this processor architecture
    1430               ;               bclr IFR0.IF4          ; enable interrupts
    1431 00014c F406          AND #0xf91f, mmap(ST1_55)
         00014e F91F 
         000150 98   
    1432 000151 F506          OR #0x4100, mmap(ST1_55)
         000153 4100 
         000155 98   
    1433 000156 F496          AND #0xfa00, mmap(ST2_55)
         000158 FA00 
         00015a 98   
    1434 00015b F596          OR #0x8000, mmap(ST2_55)
         00015d 8000 
         00015f 98   
    1435 000160 4EFF          aadd #-1, sp
    1436              
    1437                          .if 0
    1438                                                  mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1439                                      mov xar6, dbl (*(#_save_xar6))                  ; save x
    1440              
    1441                                                              amov #0x000000, xar7
    1442                                                              amov #0x000000, xar6
    1443              
    1444              
    1445                                      mov *sp(#0), ar7                                            ;; sp+3
    1446                                      mov ar7, *(#_save_new_pxcode)
    1447                                      mov ssp, ar6
    1448                                      mov *ar6(#0), ar7                                                       ;; ssp+3
    1449                                      mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and i
    1450                                      amov #0x000000, xar7
    1451                                      mov *ar6(#1), ar7                               ; this is two away now
    1452                                                              mov ar7, *(#_DBSTAT_SAVE)
    1453                                   ;   nop
    1454                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1455                                      mov xar7, dbl(*(#_xCompareTCB))
    1456                                      .endif
    1457              
    1458                                                      .if 0
    1459              
    1460                                   PSH mmap(@ST3_55)
    1461                                   AND #30976,mmap(@ST1_55)
    1462                                   BSET ST2_ARMS
    1463                                   BSET ST1_CPL
    1464                                   BSET ST3_SMUL
    1465                                   BSET ST1_SXMD
    1466                                               BCLR ST3_SATA
    1467                                               BCLR ST3_SST
    1468                                   AND #64000,mmap(@ST2_55)
    1469                                   PSHBOTH XAR0
    1470                                   PSHBOTH XAR1
    1471                                   PSHBOTH XAR2
    1472                                   PSHBOTH XAR3
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   38

    1473                                   PSHBOTH XAR4
    1474                                   PSH T0,T1
    1475                                   PSH mmap(@AC0G)
    1476                                   PSHBOTH AC0
    1477                                   PSH mmap(@AC1G)
    1478                                   PSHBOTH AC1
    1479                                   PSH mmap(@AC2G)
    1480                                   PSHBOTH AC2
    1481                                   PSH mmap(@AC3G)
    1482                                   PSHBOTH AC3
    1483                                   PSH mmap(@BRS1)
    1484                                   PSH mmap(@BRC1)
    1485                                   PSH mmap(@TRN0)
    1486                                   PSH mmap(@RPTC)
    1487                                   PSH mmap(@BK03)
    1488                                   PSH mmap(@BRC0)
    1489                                   PSH mmap(@CDP)
    1490                                   PSH mmap(@DPH)
    1491                                   AMAR *(#0002eh),XAR1               ; cpu st3_55
    1492                                   RPT #10            ;       repeats next 10 times
    1493                                   PSH dbl(*AR1+)
    1494                                   PSH mmap(@CDPH)
    1495                                   PSHBOTH XAR5
    1496                                   MOV XSP,XAR5                       ; xsp
    1497                                   AND #65534,mmap(@SP)               ; SP alignment (?)
    1498                                                      .endif
    1499                                                                      ;;
    1500 000162 E651                  MOV #0, *port(#6166) ; |119|
         000164 0018 
         000166 16   
    1501 000167 F402                  AND #0x0010, mmap(@IFR0)
         000169 0010 
         00016b 98   
    1502 00016c 46B3                  bset INTM
    1503 00016e 20                    nop
    1504 00016f 20                    nop
    1505 000170 20                    nop
    1506 000171 20                    nop
    1507 000172 20                    nop
    1508 000173 20                    nop
    1509              
    1510              ;           MOV *port(#7188), AR1 ; |68|                ;; TIMER0 is only timer that is active
    1511              ;        BSET @#0, AR1 ; |68|
    1512              ;        BCC $1,AR1 == #0 ; |68|
    1513              ;        AND #0x0010, *(#1)
    1514              ;               bset INTM               ; disable interrupts
    1515                              .if configUSE_TICK_CTR == 1
    1516 000174 F731                  add #1, *(#_tickIRQctr)
         000176 0001 
         000178 0000 
         00017a 00!  
    1517                              .endif
    1518              ;;              psh mmap(ST3_55)
    1519                  .if 1
    1520 00017b EB31                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   39

         00017d F500 
         00017f 0000!
    1521 000181 EB31                          mov xar6, dbl (*(#_save_xar6))                  ; save x
         000183 E500 
         000185 0000!
    1522 000187 EC31                                                  amov #0x000000, xar7
         000189 FE00 
         00018b 0000 
    1523 00018d EC31                                                  amov #0x000000, xar6
         00018f EE00 
         000191 0000 
    1524              
    1525 000193 AF02                          mov *sp(#1), ar7                                            ;; sp+3
    1526 000195 CF31                          mov ar7, *(#_save_new_pxcode)
         000197 0000 
         000199 00!  
    1527 00019a 449E                          mov ssp, ar6
    1528 00019c AFCD                          mov *ar6(#1), ar7                                                       ;; ssp+3
         00019e 0001 
    1529 0001a0 CF31                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and i
         0001a2 0000 
         0001a4 00!  
    1530 0001a5 EC31                          amov #0x000000, xar7
         0001a7 FE00 
         0001a9 0000 
    1531 0001ab AFCD                          mov *ar6(#2), ar7                               ; this is two away now
         0001ad 0002 
    1532 0001af CF31                                                  mov ar7, *(#_DBSTAT_SAVE)               ;; this is just for r
         0001b1 0000 
         0001b3 00!  
    1533                                   ;   nop
    1534 0001b4 ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         0001b6 FF00 
         0001b8 0000!
    1535 0001ba EB31                          mov xar7, dbl(*(#_xCompareTCB))
         0001bc F500 
         0001be 0000!
    1536                                      .endif
    1537                      .if 0
    1538                      ;               mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1539                  ;        mov xar6, dbl (*(#_save_xar6))
    1540                                      amov #0x000000, xar7
    1541                                      amov #0x000000, xar6
    1542                                      mov ssp, ar7
    1543                                      mov *ar7(#2), ar6                               ; this is two away now
    1544                                      mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
    1545                                      .endif
    1546                          ;;            mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1547                          ;;            mov dbl (*(#_save_xar6)), xar6                  ; restore xar6
    1548              ;;              mov xsp, dbl (*(#_save_xsp))
    1549              ;;              mov xssp, dbl (*(#_save_xssp))
    1550                                      .if configSTACK_PTR_DEBUG == 1
    1551                                      mov xsp, dbl(*(#_Ssave_xsp))
    1552                          mov xssp, dbl(*(#_Ssave_xssp))
    1553                          .endif
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   40

    1554              ;;;        aadd #1, sp
    1555 ****** MACRO         portSAVE_CONTEXT
    1555              ;                       ;CONTEXT_SAVE
    1555              ;                       ASP  ; Align Stack Pointer
    1555              ;                       CLRC       OVM,PAGE0
    1555              ;                       CLRC       AMODE
    1555              ;                       EALLOW
    1555 0001c0 4652                  bclr C54CM      ; temp - until we figure out what is setting this
    1555              ;;;             bset INTM               ; disable interrupts - already done
    1555              ;                       aadd #1, sp
    1555 0001c2 20                            nop
    1555 0001c3 20                            nop
    1555 0001c4 20                            nop
    1555              
    1555 0001c5 EB31                          mov xsp,  dbl (*(#_Ssave_xsp))                  ; save xsp
         0001c7 4500 
         0001c9 0000!
    1555 0001cb EB31                          mov xssp, dbl (*(#_Ssave_xssp))                 ; save xssp
         0001cd 5500 
         0001cf 0000!
    1555              ;;;                     mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1555              ;;;                     mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1555              
    1555              ;                       pshboth xar7
    1555              ;                       pshboth xar6
    1555              ;                       pshboth xar5
    1555              
    1555              ;;;;                    mov xar7, dbl (*(#_save_xar7))                  ; save xar7 (already saved)
    1555              ;                       .if configUSE_CONTEXT_DEBUG == 1
    1555              ;;;;                    mov xar6, dbl (*(#_save_xar6))                  ; saved in vTick ISR already
    1555              ;                       .endif
    1555 0001d1 4E01                          aadd #1, sp
    1555              ; +++===+++
    1555              
    1555                                      .if 1                                                           ; need to figure out 
    1555 0001d3 EB31                          mov xar1, dbl (*(#_save_xar1))
         0001d5 9500 
         0001d7 0000!
    1555 0001d9 EB31                          mov xar2, dbl (*(#_save_xar2))
         0001db A500 
         0001dd 0000!
    1555 0001df EB31                          mov xar3, dbl (*(#_save_xar3))
         0001e1 B500 
         0001e3 0000!
    1555 0001e5 EB31                          mov xar4, dbl (*(#_save_xar4))
         0001e7 C500 
         0001e9 0000!
    1555 0001eb EC31                          amov #0x000000, xar5
         0001ed DE00 
         0001ef 0000 
    1555 0001f1 EC31                          amov #0x000000, xar6
         0001f3 EE00 
         0001f5 0000 
    1555 0001f7 904D                          mov xsp, xar5
    1555 0001f9 905E                          mov xssp, xar6
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   41

    1555 0001fb EC31                          amov #0x000000, xar2
         0001fd AE00 
         0001ff 0000 
    1555 000201 EC31                          amov #0x000000, xar1
         000203 9E00 
         000205 0000 
    1555 000207 EC31                          amov #0x000000, xar3
         000209 BE00 
         00020b 0000 
    1555 00020d EC31                          amov #0x000000, xar4
         00020f CE00 
         000211 0000 
    1555              ;                       mov dbl (*(#_pxCurrentTCB)), xar5
    1555              
    1555 000213 EDE1                          mov dbl (*ar7), xar4                            ; xsp contains our TCB now
         000215 CF   
    1555 000216 EDED                          mov dbl (*ar7(#2)), xar3
         000218 BF00 
         00021a 02   
    1555 00021b 7B00                          add #0x0064, ar4
         00021d 64CC 
    1555 00021f 402B                          add #0x0002, ar3
    1555              
    1555 000221 AAAD                          mov *ar5(#0), ar2                               ; current xsp contents
         000223 0000 
    1555 000225 A9CD                          mov *ar6(#0), ar1                               ; current xssp contents
         000227 0000 
    1555              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1555 000229 CA81                          mov ar2, *ar4                           ; saves our new PC - but, does this work in e
    1555 00022b C961                          mov ar1, *ar3
    1555                                      .endif
    1555              ;;                      aadd #1, sp
    1555                                      .if 0
    1555                          amov #0x000000, xar7
    1555                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1555                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1555                                      mov dbl (*ar7(#2)), xssp
    1555                          amov #0x000000, xar7
    1555                                      amov #0x000000, xar6
    1555                          mov *(#_save_new_pxcode), ar7
    1555                          mov ar7, *sp(#0)
    1555                          amov #0x000000, xar7
    1555                          mov ssp, ar6
    1555                          mov *(#_save_new_pxlcode), ar7
    1555              ;            mov ar7, *ssp(#0)
    1555                          mov ar7, *ar6(#0)
    1555                              .endif
    1555              
    1555              ;                       mov ssp, ar7
    1555              ;                       mov *ar7(#1), ar6                               ; this is (one)two away now
    1555              ;                       mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
    1555              ;                       .endif
    1555              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1555              ;            mov xar6, dbl (*(#_save_xar6))                  ; save x
    1555                                      .if 0
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   42

    1555                                      amov #0x000000, xar7
    1555                                      amov #0x000000, xar6
    1555                          mov *sp(#0), ar7                                            ;; sp+3
    1555                          mov ar7, *(#_save_new_pxcode)
    1555                          mov ssp, ar6
    1555                          mov *ar6(#1), ar7                                                       ;; ssp+3
    1555                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and if a task, it
    1555                                   ;   nop
    1555                          mov dbl (*(#_pxCurrentTCB)), xar7
    1555                          mov xar7, dbl(*(#_xCompareTCB))
    1555                          .endif
    1555              ; +++===+++
    1555              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1555              ;
    1555              
    1555              
    1555              ; +++===+++
    1555                                      .if 0
    1555              ;                       mov dbl (*(_xCompareTCB)), xar6                 ; need to save our return address
    1555              ;                       mov xar7, ac0
    1555              ;               mov xar6, ac1
    1555              ;                       CMPU AC1 != AC0, TC1
    1555              ;                               BCC $5,TC1
    1555                                      amov #0x000000, xar7
    1555                                          amov #0x000000, xar6
    1555                                          mov  *(#_save_new_pxcode), ar7
    1555                                          mov ar7, *sp(#0)
    1555                              mov *(#_save_new_pxlcode) , ar7
    1555                              mov ssp, ar6
    1555                              mov ar7, *ar6(#0)
    1555                              mov dbl (*(#_save_xar6)), xar6
    1555                                         .endif
    1555              ; +++===+++
    1555 00022d       $5_$2$:
    1555                                              
    1555              ; +++===+++
    1555              ;; what about xssp here?
    1555              ;;                              mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1555              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1555                                 .if configUSE_CONTEXT_DEBUG == 1
    1555              ;; save current PC (and possible loop bits values)
    1555              ;; for debug - to see if this is being corrupted
    1555                                      mov dbl(*ar7), xar6
    1555                                      mov dbl(*ar6), xar7
    1555                                      mov xar7, dbl (*(#_PC_REG_LOW_SAVE))            ; save off the PC
    1555                                      mov xssp, xar7
    1555                                      mov dbl(*ar7), xar6
    1555                                      mov dbl(*ar6), xar7
    1555                                      mov xar7, dbl (*(#_PC_REG_HIGH_SAVE))           ; save off the PC
    1555                                      mov xssp, xar7
    1555                                      add #-2, ar7
    1555                                      mov dbl(*ar7), xar6
    1555                                      mov xar6,  dbl (*(_DBSTAT_SAVE))
    1555                          mov dbl (*(#_save_xar6)), xar6
    1555              
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   43

    1555              ;            mov (*ar7), (*(#_PC_REG_LOW_SAVE))
    1555              ;            mov dbl(*xssp),(*(#_PC_REG_HIGH_SAVE))
    1555              ;                       mov (*ssp(#-2)), (*(#_DBSTAT_SAVE))
    1555                                      .endif
    1555              ; +++===+++
    1555                                      ; save context in our stack(s) frame
    1555              
    1555              ;;;;                    mov dbl (*(#_pxCurrentTCB)), xar7
    1555              ;;;                     mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1555              ;;;                     mov dbl (*ar7(#2)), xssp
    1555              ; +++===+++
    1555              ;                   mov dbl (*(#_pxCurrentTCB)), xar7
    1555                                  ; add #0x0064, ar7
    1555              ;                       mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
    1555              ;                       mov dbl (*ar7(#2)), xssp
    1555              ;           add #0x0064, ar4
    1555              ;                       add #0x0064, ar3
    1555              ;                       mov dbl (*ar5), xar4                            ; xsp contains our TCB now
    1555              ;                       mov dbl (*ar5(#2)), xar3                        ; xssp
    1555              ;                       add #0x0064, ar4
    1555              ;                       add #0x0064, ar3
    1555 00022d EC31                  amov #0x000000, xar7
         00022f FE00 
         000231 0000 
    1555 000233 EC31                          amov #0x000000, xar6
         000235 EE00 
         000237 0000 
    1555 000239 ED31                      mov dbl (*(#_pxCurrentTCB)), xar7
         00023b FF00 
         00023d 0000!
    1555 00023f EDE1                          mov dbl (*ar7), xar6                            ; xsp normal position
         000241 EF   
    1555 000242 7B00                          add #0x0064, ar6
         000244 64EE 
    1555 000246 90E4                          mov xar6, xsp                                           ; actual xsp
    1555 000248 EDED                          mov dbl (*ar7(#2)), xar6                        ; xssp
         00024a EF00 
         00024c 02   
    1555 00024d 402E                          add #0x0002, ar6
    1555 00024f 90E5                          mov xar6, xssp
    1555              
    1555 000251 ED31              mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         000253 FF00 
         000255 0000!
    1555 000257 ED31              mov dbl (*(#_save_xar6)), xar6
         000259 EF00 
         00025b 0000!
    1555              ;            mov dbl (*(#_save_xar1)), xar1                  ; restore xar7
    1555              ;            mov dbl (*(#_save_xar2)), xar2
    1555              ;            mov dbl (*(#_save_xar3)), xar3                  ; restore xar7
    1555              ;            mov dbl (*(#_save_xar4)), xar4
    1555                                        ; restore xar6
    1555              ;;; begin context save:
    1555              
    1555 00025d EB10                          mov xar7, dbl(*sp(#8))                          ; save xar7
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   44

         00025f F5   
    1555 000260 CF0E                          mov ar7, *sp(#7)
    1555              
    1555 000262 EB14                          mov xar6, dbl(*sp(#10))
         000264 E5   
    1555 000265 CE12                          mov ar6, *sp(#9)
    1555              
    1555 000267 EB18                          mov xar5, dbl(*sp(#12))
         000269 D5   
    1555 00026a CD16                          mov ar5, *sp(#11)
    1555              
    1555 00026c EB1C                          mov xar4, dbl(*sp(#14))
         00026e C5   
    1555 00026f CC1A                          mov ar4, *sp(#13)
    1555              
    1555 000271 EB20                          mov xar3, dbl(*sp(#16))
         000273 B5   
    1555 000274 CB1E                          mov ar3, *sp(#15)
    1555              
    1555 000276 EB24                          mov xar2, dbl(*sp(#18))
         000278 A5   
    1555 000279 CA22                          mov ar2, *sp(#17)
    1555              
    1555 00027b EB28                          mov xar1, dbl(*sp(#20))
         00027d 95   
    1555 00027e C926                          mov ar1, *sp(#19)
    1555              
    1555 000280 EB2C                          mov xar0, dbl(*sp(#22))
         000282 85   
    1555 000283 C82A                          mov ar0, *sp(#21)
    1555              
    1555 000285 EB30              mov  ac0, dbl(*sp(#24))
         000287 08   
    1555 000288 C02E              mov ac0, *sp(#23)
    1555              
    1555 00028a C732                          mov t3, *sp(#25)
    1555 00028c C634                          mov t2, *sp(#26)
    1555 00028e C536                          mov t1, *sp(#27)
    1555 000290 C438                          mov t0, *sp(#28)
    1555              ; +++===+++
    1555              ;;                      mov mmap(ST0_55), t0
    1555              ; - this is ok - we are not pushing - it's a relative stack frame
    1555              ;                       mov t0, *sp(#25)
    1555              ;;                      mov t0, *sp(#23)
    1555              ;;                      mov mmap(ST1_55), t1
    1555              ;                       mov t1, *sp(#26)                ; stomping on own mem
    1555              ;;                      mov t1, *sp(#21)                ; stomping on own mem
    1555              ;;                      mov mmap(ST2_55), t2
    1555              ;;                      mov t2, *sp(#22)
    1555              ;                       mov t2, *sp(#27)
    1555              ;;                      mov mmap(ST2_55), t3
    1555              ;                       mov t3, *sp(#28)
    1555              ;;                      mov t3, *sp(#24)
    1555              
    1555              ;                       PSH dbl(AR0) ; 32-bit
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   45

    1555              ;                       PSH dbl(AR1) 
    1555              ;                       PSH dbl(AR2) ; 32-bit
    1555              ;                       PUSH XAR3 ; 32-bit
    1555              ;                       PUSH XAR4 ; 32-bit
    1555                              ;-- Comment these to save cycles --------
    1555              ;                       PUSH XAR5 ; 32-bit
    1555              ;                       PUSH XAR6 ; 32-bit
    1555              ;                       PUSH XAR7 ; 32-bit
    1555                              ;----------------------------------------
    1555              
    1555              ;                       PUSH XT   ; 32-bit
    1555              
    1555              ;                       movl xar6, @_portFLAGS_INT_ENABLED
    1555              ;                       push xar6 ; portFLAGS_INT_ENABLED
    1555              ; +++===+++
    1555              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1555              ;                       mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
    1555              ;                       mov dbl (*ar7(#2)), xssp
    1555              
    1555 000292 ED31                          mov dbl (*(#_portFLAGS_INT_ENABLED)), xar6
         000294 EF00 
         000296 0000!
    1555 000298 EB0C                          mov xar6, dbl(*sp(#6))
         00029a E5   
    1555              
    1555              ;                       movl xar7, @_usCriticalNesting
    1555              ;                       push xar7
    1555 00029b ED31                          mov dbl (*(#_usCriticalNesting)), xar7
         00029d FF00 
         00029f 0000!
    1555 0002a1 EB08                          mov xar7, dbl(*sp(#4))
         0002a3 F5   
    1555              
    1555 0002a4 EC31                          amov #0x000000, xar7
         0002a6 FE00 
         0002a8 0000 
    1555 0002aa EC31                          amov #0x000000, xar6
         0002ac EE00 
         0002ae 0000 
    1555              
    1555 0002b0 AF06                          mov mmap(ST1_55), ar7
         0002b2 98   
    1555 0002b3 CF02                          mov ar7, *sp(#1)
    1555 0002b5 AF96                          mov  mmap(ST2_55), ar7
         0002b7 98   
    1555 0002b8 CF04                          mov ar7, *sp(#2)
    1555              
    1555 0002ba 449F                          mov ssp, ar7
    1555              ;                       mov *(#_LOOP_BITS), ar6                 ; save LOOP_BITS (CFCT)
    1555              ;                       and #0xFF00, ar6
    1555              ;                       mov ar6, *ar7(#1)
    1555              
    1555 0002bc AE04                          mov mmap(ST0_55), ar6
         0002be 98   
    1555 0002bf CEED                          mov ar6, *ar7(#2)
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   46

         0002c1 0002 
    1555                                      
    1555 0002c3 AE31                          mov *(#_DBSTAT_SAVE), ar6               ; save DBSTAT
         0002c5 0000 
         0002c7 00!  
    1555 0002c8 CEED                          mov ar6, *ar7(#1)
         0002ca 0001 
    1555              ; +++===+++
    1555              ;                       mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
    1555              ;                       mov dbl (*(#_save_xssp)), xssp          
    1555              ;;;                     mov  dbl (*(_DBSTAT_SAVE)), *xar7(#2)   ; needs to be DBSTAT - don't overwrite DBSTAT
    1555              ;;;                     mov ar6, *ar7(#2)
    1555              ;                       mov ar7, mmap(ST0_55)
    1555              ;                       mov *ssp(#2), ar7
    1555              ; fix up
    1555              ;                       aadd #20, sp
    1555              ;                       mov sp, t0
    1555              ;                       sub #1, t0
    1555              ;                       mov t0, ssp
    1555              
    1555                                      ; move contents of SP into address of current TCB
    1555              ;                       mov xsp, dbl (*(#_pxCurrentTCB))                ; xsp contains our TCB now
    1555              
    1555              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1555              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1555              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1555              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1555              ;                       mov dbl (*ar7+), xssp
    1555              
    1555              ;                       mov sp, t0              ; we've already saved t0
    1555              ;                       add #1, t0
    1555              ;                       mov t0, ssp
    1555              ; ??
    1555              ;                       mov xsp, dbl (*(#_pxCurrentTCB))
    1555              
    1555              ;                       movl xar6, @_pxCurrentTCB ; XAR6 contains current TCB addr
    1555              ;                       mov al, @sp
    1555              ;                       movl  *xar6, acc        
    1555              ;;                      mov  ar0, @sp
    1555              ;;                      mov  @ar6, alxd
    1555              ;;                      mov  ar0, @sp
    1555              ;;                      movl 0(xar6), sp
    1555              ;                       EDIS
    1555              ;                       NASP
    1555              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1555              ;                       NOP
    1555              ;                       .if configSTACK_PTR_DEBUG == 1
    1555              ;                       mov xsp, dbl(*(#_Ssave_xsp))
    1555              ;            mov xssp, dbl(*(#_Ssave_xssp))
    1555              ;            .endif
    1555                              .if 0
    1555                                      mov  xar7, dbl (*(#_save_xar7))                 ; restore xar7
    1555                          mov  xar6, dbl (*(#_save_xar6))
    1555              
    1555                              amov #0x000000, xar7
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   47

    1555                                      amov #0x000000, xar6
    1555                                  mov dbl (*(#_pxCurrentTCB)), xar7
    1555                                      mov dbl (*ar7), xar6                            ; xsp normal position
    1555                                      add #0x0064, ar6
    1555                                      mov xar6, xsp                                           ; actual xsp
    1555                                      mov dbl (*ar7(#2)), xar6                        ; xssp
    1555                                      add #0x0002, ar6
    1555                                      mov xar6, xssp
    1555              
    1555                          mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1555                          mov dbl (*(#_save_xar6)), xar6
    1555                        .endif
    1555              
    1555              ;;;;                    mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
    1555              ;;;;                    mov dbl (*(#_save_xssp)), xssp
    1555              
    1555 0002cc ED31                          mov dbl (*(#_Ssave_xsp)), xsp                   ; restore xsp*
         0002ce 4F00 
         0002d0 0000!
    1555 0002d2 ED31                          mov dbl (*(#_Ssave_xssp)), xssp                 ; restore xssp
         0002d4 5F00 
         0002d6 0000!
    1555              
    1555 0002d8 20                            nop
    1555              ;                       aadd #-1, sp
    1555 0002d9 20                            nop
    1555              
    1555 0002da 20                            nop
    1555                                                                                      ; ?
    1556              ;        aadd #1, sp
    1557 0002db 6C00          call     #_xTaskIncrementTick
         0002dd 0000!
    1558              ;        aadd #-1, sp
    1559                      .if configUSE_PREEMPTION == 1
    1560              ;        mov xsp, dbl (*(#_save_xsp))                   ; save xsp
    1561              ;           mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1562              ;        aadd #1, sp
    1563 0002df 6C00          call    #_vTaskSwitchContext
         0002e1 0000!
    1564              ;        aadd #-1, sp
    1565              
    1566                                      .if 1
    1567 0002e3 EB31                          mov xar7, dbl (*(#_save_xar7))                  ; save xar7
         0002e5 F500 
         0002e7 0000!
    1568 0002e9 EB31              mov xar6, dbl (*(#_save_xar6))
         0002eb E500 
         0002ed 0000!
    1569 0002ef EB31              mov ac0, dbl (*(#_save_ac0))                  ; save xar7
         0002f1 0800 
         0002f3 0000!
    1570 0002f5 EB31              mov ac1, dbl (*(#_save_ac1))
         0002f7 1800 
         0002f9 0000!
    1571 0002fb EB31              mov xar1, dbl(*(#_save_xar1))
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   48

         0002fd 9500 
         0002ff 0000!
    1572 000301 EC31              amov #0x000000, xar7
         000303 FE00 
         000305 0000 
    1573 000307 EC31                          amov #0x000000, xar6
         000309 EE00 
         00030b 0000 
    1574 00030d ED31                          mov dbl (*(_xCompareTCB)), xar6
         00030f EF00 
         000311 0000!
    1575 000313 ED31                      mov dbl (*(#_pxCurrentTCB)), xar7
         000315 FF00 
         000317 0000!
    1576                          ; need to restore our return address
    1577 000319 3C00              mov #0x000000, ac0
    1578 00031b 3C01                          mov #0x000000, ac1
    1579 00031d 90F0                          mov xar7, ac0
    1580 00031f 90E1              mov xar6, ac1
    1581 000321 1210                  CMPU AC1 == AC0, TC1 ; |1393|
         000323 04   
    1582 000324 0464              BCC $A,TC1 ; |1393|
         000326 36   
    1583 000327 20                nop                 ; breakpoint here - context switch has occurred
    1584                          .if configUSE_TICK_CTR == 1
    1585 000328 F731                      add #1, *(#_context_switch_counter)
         00032a 0001 
         00032c 0000 
         00032e 00!  
    1586                                  .endif
    1587 00032f EC31                      amov #0x000000, xar7
         000331 FE00 
         000333 0000 
    1588 000335 EC31                      amov #0x000000, xar1
         000337 9E00 
         000339 0000 
    1589 00033b AF31                      mov *(#_save_new_pxcode), ar7
         00033d 0000 
         00033f 00!  
    1590 000340 A9CD                      mov *ar6(#0), ar1
         000342 0000 
    1591 000344 7B00                      add #0x0064, ar1
         000346 6499 
    1592 000348 CF21                      mov ar7, *ar1
    1593 00034a AF31                      mov *(#_save_new_pxlcode), ar7
         00034c 0000 
         00034e 00!  
    1594 00034f EC31                      amov #0x000000, xar1
         000351 9E00 
         000353 0000 
    1595 000355 A9CD                      mov *ar6(#2), ar1
         000357 0002 
    1596 000359 4029                      add #0x0002, ar1
    1597 00035b CF21                      mov ar7, *ar1
    1598                                  ; amov #0x000000, xar7
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   49

    1599                                      ;    amov #0x000000, xar6
    1600                          ;  mov  *(#_save_new_pxcode), ar7
    1601                                      ;    mov ar7, *sp(#0)
    1602                          ;                mov *(#_save_new_pxlcode) , ar7
    1603                          ;                mov ssp, ar6
    1604                          ;                mov ar7, *ar6(#0)
    1605              
    1606                          ;                mov dbl (*(#_save_xar6)), xar6
    1607                                      ;                       .endif
    1608              ; +++===+++
    1609 00035d       $A:
    1610 00035d ED31              mov dbl (*(#_save_ac0)), ac0                  ; save xar7
         00035f 0800 
         000361 0000!
    1611 000363 ED31              mov dbl (*(#_save_ac1)), ac1
         000365 1800 
         000367 0000!
    1612 000369 ED31              mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         00036b FF00 
         00036d 0000!
    1613 00036f ED31              mov dbl (*(#_save_xar6)), xar6
         000371 EF00 
         000373 0000!
    1614 000375 ED31              mov dbl (*(#_save_xar1)), xar1
         000377 9F00 
         000379 0000!
    1615                       .endif
    1616                      .endif
    1617              ;$1:
    1618              ;               bclr INTM
    1619 00037b E651                  mov #1, *port(#6166) ; |127|
         00037d 0118 
         00037f 16   
    1620              ;               MOV #0, *port(#6294) ; |92|
    1621 000380 F551                  or #0x0001, *port(#7188) ; |130|
         000382 0001 
         000384 1C14 
    1622               ;       OR #0x0007, *port(#7188) ; |100|
    1623 000386 4E01              aadd #1, sp ;;;
    1624                                              .if 0
    1625                                 POPBOTH XAR5
    1626                                 POP mmap(@CDPH)
    1627                                AMAR *(#00042h),XAR1
    1628                                RPT #10
    1629                                POP dbl(*AR1-)
    1630                                POP mmap(@DPH)
    1631                                POP mmap(@CDP)
    1632                                POP mmap(@BRC0)
    1633                               POP mmap(@BK03)
    1634                              POP mmap(@RPTC)
    1635                              POP mmap(@TRN0)
    1636                             POP mmap(@BRC1)
    1637                               POP mmap(@BRS1)
    1638                                POPBOTH AC3
    1639                               POP mmap(@AC3G)
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   50

    1640                               POPBOTH AC2
    1641                              POP mmap(@AC2G)
    1642                             POPBOTH AC1
    1643                               POP mmap(@AC1G)
    1644                                POPBOTH AC0
    1645                               POP mmap(@AC0G)
    1646                               POP T0,T1
    1647                                POPBOTH XAR4
    1648                                POPBOTH XAR3
    1649                               POPBOTH XAR2
    1650                              POPBOTH XAR1
    1651                              POPBOTH XAR0
    1652                               POP mmap(@ST3_55)
    1653                                  NOP
    1654                                   NOP
    1655                                  NOP
    1656                                   NOP
    1657                                   NOP
    1658                                    NOP
    1659                                              .endif
    1660              
    1661              
    1662                              .if configSTACK_PTR_DEBUG == 1
    1663                                      mov xsp, dbl(*(#_restore_xsp))
    1664                          mov xssp, dbl(*(#_restore_xssp))
    1665                         .endif
    1666 ****** MACRO         portRESTORE_CONTEXT
    1666                                      .C54CM_off
    1666              ;                       .CPL_off
    1666                                      .ARMS_off
    1666                                      .align 4
    1666              
    1666              ; Restore context & return
    1666                                      ;CONTEXT_RESTORE
    1666              ;                       ASP
    1666              ;                       EALLOW
    1666              ;                       nop
    1666              ;                       nop
    1666              ;                       nop
    1666              ;                       nop
    1666 000388 4652                  bclr C54CM
    1666 00038a 20                    nop
    1666 00038b 20                    nop
    1666 00038c 20                    nop
    1666 00038d 20                    nop
    1666 00038e 20                    nop
    1666 00038f 20                    nop
    1666              ;               xssp = dbl(*(#_pxCurrentTCB))
    1666              ;               xsp  = dbl(*(#_pxCurrentTCB))
    1666 000390 EB31                          mov xar7, dbl (*(#_save_xar7))  
         000392 F500 
         000394 0000!
    1666 000396 EB31                          mov xar6, dbl (*(#_save_xar6))
         000398 E500 
         00039a 0000!
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   51

    1666              
    1666              ;                        aadd #-3, sp                           ;;;;
    1666              ;            aadd #-3, xsp
    1666              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1666              ;            BCC $1,TC1 ; |216|
    1666              ;;                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1666              ;;                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1666              ;            B $4
    1666 00039c EB31                          mov xsp, dbl (*(#_restore_xsp))                 ; save xsp
         00039e 4500 
         0003a0 0000!
    1666 0003a2 EB31                          mov xssp, dbl (*(#_restore_xssp))                       ; save xssp
         0003a4 5500 
         0003a6 0000!
    1666               ;                      aadd #3, xsp
    1666 0003a8 4EFF                  aadd #-1, sp
    1666              ;$1
    1666              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1666              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
    1666              ;$4
    1666                                      .if 1
    1666 0003aa 904F                          mov xsp, xar7
    1666 0003ac 905E                          mov xssp, xar6
    1666 0003ae EC31                          amov #0x000000, xar2
         0003b0 AE00 
         0003b2 0000 
    1666 0003b4 EC31                          amov #0x000000, xar1
         0003b6 9E00 
         0003b8 0000 
    1666              
    1666 0003ba ED31                          mov dbl (*(#_pxCurrentTCB)), xar5
         0003bc DF00 
         0003be 0000!
    1666                                                                                               ;; points to our variables n
    1666 0003c0 EDA1                          mov dbl (*ar5), xar4                            ; xsp contains our TCB now
         0003c2 CF   
    1666 0003c3 EDAD                          mov dbl (*ar5(#2)), xar3
         0003c5 BF00 
         0003c7 02   
    1666 0003c8 7B00                          add #0x0064, ar4
         0003ca 64CC 
    1666 0003cc 402B                          add #0x0002, ar3
    1666                                      
    1666              ;;                      mov xar4, xsp
    1666              ;;                      mov xar3, xssp
    1666              
    1666 0003ce AA81                          mov *ar4, ar2
    1666 0003d0 A961                          mov *ar3, ar1                           ; maybe not on a yield here
    1666              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1666 0003d2 CAE1                          mov ar2, *ar7
    1666 0003d4 C9C1                          mov ar1, *ar6
    1666              
    1666 0003d6 AF06                          mov mmap(ST1_55), ar7
         0003d8 98   
    1666 0003d9 7DF7                          and #0xf7ff, ar7                        ; <here>#0800h
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   52

         0003db FFFF 
    1666 0003dd CF02                          mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1666 0003df CF8D                          mov ar7, *ar4(#1)                       ; save in TCB
         0003e1 0001 
    1666 0003e3 AF96                          mov mmap(ST2_55), ar7
         0003e5 98   
    1666 0003e6 CF04                          mov ar7, *sp(#2)
    1666 0003e8 CF8D                          mov ar7, *ar4(#2)
         0003ea 0002 
    1666              
    1666 0003ec 449F                          mov ssp, ar7
    1666 0003ee AE04                          mov mmap(ST0_55), ar6
         0003f0 98   
    1666 0003f1 CEED                          mov ar6, *ar7(#2)
         0003f3 0002 
    1666 0003f5 CE6D                          mov ar6, *ar3(#2)
         0003f7 0002 
    1666 0003f9 AE31                          mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
         0003fb 0000 
         0003fd 00!  
    1666              ;;                      mov ar6, *ar7(#1)
    1666 0003fe CE6D                          mov ar6, *ar3(#1)
         000400 0001 
    1666                                      .endif
    1666              
    1666              ;                       mov #0, ssp     
    1666              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1666              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1666                                      ; 32-bit mode - will act on SP and SSP:
    1666              ;                       'fix-up' current SP and SSP - is this dangerous????
    1666              ;                       aadd #-3, sp
    1666              ;;                      mov *ar7, *sp
    1666              ;                       mov dbl (*ar7), ar6
    1666              ;                       mov ar6, *sp                            ; xsp contains our TCB now
    1666              ;                       mov *ar7(#2), *ssp                      
    1666              ;                       POP mmap(ST3_55)
    1666              ;                       pshboth xar7                            ; should increment both
    1666                                      .if 0
    1666                                      mov mmap(ST1_55), ar7
    1666                                      and #0xf7ff, ar7                        ; <here>#0800h
    1666                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1666                                      mov mmap(ST2_55), ar7
    1666                                      mov ar7, *sp(#2)
    1666              
    1666                                      mov ssp, ar7
    1666                                      mov mmap(ST0_55), ar6
    1666                                      mov ar6, *ar7(#2)
    1666              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
    1666              ;;                      mov ar6, *ar7(#1)
    1666                                      .endif
    1666              ; +++===+++
    1666                                      .if 0
    1666                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1666                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1666                                      mov dbl (*ar7(#2)), xssp        
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   53

    1666                                      .endif
    1666              ; +++===+++
    1666                                      .if 0
    1666                                      mov dbl (*(_xCompareTCB)), xar6
    1666              ; need to restore our return address
    1666                                      mov xar7, ac0
    1666                                          mov xar6, ac1
    1666                                          CMPU AC1 != AC0, TC1 ; |1393|
    1666                                          BCC $6,TC1 ; |1393|
    1666                                          amov #0x000000, xar7
    1666                                          amov #0x000000, xar6
    1666                                          mov  *(#_save_new_pxcode), ar7
    1666                                          mov ar7, *sp(#0)
    1666                                          mov *(#_save_new_pxlcode) , ar7
    1666                                          mov ssp, ar6
    1666                                          mov ar7, *ar6(#0)
    1666              
    1666                                          mov dbl (*(#_save_xar6)), xar6
    1666                                                              .endif
    1666              ; +++===+++
    1666 000402       $6_$3$:
    1666              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
    1666              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1666                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
    1666                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1666                                      mov xar6, dbl (*(#_save_xar6))
    1666              
    1666              ;; this is for debug
    1666                                      mov dbl(*ar7), xar6
    1666                                      mov dbl(*ar6), xar7
    1666                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
    1666                                      mov xssp, xar7
    1666                                      mov dbl(*ar7), xar6
    1666                                      mov dbl(*ar6), xar7
    1666                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
    1666                                      mov xssp, xar7
    1666                                      add #-2, ar7
    1666                                      mov dbl(*ar7), xar6
    1666                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
    1666                                      mov dbl (*(#_save_xar6)), xar6
    1666                                      
    1666                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1666                                      .endif
    1666              ; +++===+++
    1666              ;                       mov mmap(ST0_55), *ssp(#1)
    1666              ;                       mov mmap(STO_55), *ssp(#2)
    1666              ;                       mov mmap(ST1_55), *sp(#1)
    1666              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
    1666              ;                       mov *ar7, t0
    1666              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
    1666              ;                       mov *ar7(#2), t0
    1666              ;                       mov t0, *ssp(#0)                        
    1666              
    1666              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
    1666              ; what about xssp?
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   54

    1666              ;                       mov xar6, xsp
    1666              ;                       mov xssp, xar7
    1666              ;                       add #1, ar7
    1666              ;                       mov xar7, xsp
    1666              ;                       mov sp, t0
    1666              ;                       mov ssp, t1
    1666              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
    1666              ;                       ar0 = *ar6
    1666              ;                       xssp = xar0
    1666              ;                       mov *xar6, xar0
    1666              ;                       mov xar0, xssp  ; stack now points to our TCB
    1666              ;;                      mov sp, *ar6
    1666              ;;                      mov sp, ar0
    1666              ;;                      mov sp, *_pxCurrentTCB
    1666              ;;                      clr ar0
    1666              ;;                      mov ar0, @xar6
    1666              ;;                      mov sp, AR0
    1666              ;;                      add sp, xar6
    1666              
    1666              ;;                      pshboth xar7
    1666              ;;                      pshboth xar6
    1666              ;;                      pshboth xar5
    1666              
    1666              ;;                      popboth xar5
    1666              ;;                      popboth xar6
    1666              ;;                      popboth xar7
    1666              
    1666              ;;;                     mov *sp(#1), ar7 
    1666              ;                       mov dbl(*sp(#1)), ar7
    1666              ;;;                     mov  ar7, mmap(ST1_55)
    1666              ; +++===+++
    1666              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1666              ;                       add #0x0064, ar7
    1666              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1666              ;                       mov *ar7(#2)
    1666              ;                       mov dbl (*ar7(#2)), xssp
    1666              ; ===+++===
    1666                 .if 0
    1666                              amov #0x000000, xar7
    1666                                      amov #0x000000, xar6
    1666                                  mov dbl (*(#_pxCurrentTCB)), xar7
    1666                                      mov dbl (*ar7), xar6                            ; xsp normal position
    1666                                      add #0x0064, ar6
    1666                                      mov xar6, xsp                                           ; actual xsp
    1666                                      mov dbl (*ar7(#2)), xar6                        ; xssp
    1666                                      add #0x0002, ar6
    1666                                      mov xar6, xssp
    1666                 .endif
    1666              ; ===+++===
    1666              ;                       add #0x0064, xssp
    1666              ; +++===+++
    1666                                      .if 0
    1666                                      mov *sp(#2), ar7
    1666                                      mov ar7, mmap(ST2_55)
    1666                                      mov ssp, ar7
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   55

    1666                                      mov *ar7(#2), ar6
    1666                                      mov ar6, mmap(ST0_55)
    1666                                      .endif
    1666              ;                       mov *ar7(#2), ar6
    1666              ;                       mov ar6, *ssp(#2)
    1666              ;                       mov *ssp(#2), ar7
    1666              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
    1666              ;
    1666              ; restore context
    1666              
    1666 000402 EC31                          amov #0x000000, xar2
         000404 AE00 
         000406 0000 
    1666 000408 EC31                          amov #0x000000, xar1
         00040a 9E00 
         00040c 0000 
    1666              
    1666                                      .if 0
    1666                                      mov mmap(ST1_55), ar7
    1666                                      and #0xf7ff, ar7                        ; <here>#0800h
    1666                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1666                                      mov ar7, mmap(ST1_55)
    1666              ;                       mov ar7, *ar4(#1)                       ; save in TCB
    1666                                      mov mmap(ST2_55), ar7
    1666                                      mov ar7, *sp(#2)
    1666              ;                       mov ar7, *ar4(#2)
    1666              
    1666                                      mov ssp, ar7
    1666                                      mov mmap(ST0_55), ar6
    1666                                      mov ar6, *ar7(#2)
    1666              ;                       mov ar6, *ar3(#2)
    1666                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
    1666                                      mov ar6, *ar7(#1)
    1666              ;                       mov ar6, *ar3(#2)
    1666                                      .endif
    1666              ;;                      mov *(#_LOOP_BITS), ar6         ; have to restore this
    1666              ;;                      and #0xFF00, ar6
    1666              ;;                      mov ar6, *ar7(#1)
    1666              
    1666 00040e ED08                          mov dbl(*sp(#4)), xar7
         000410 FF   
    1666              ;                       mov *sp(#1), ar7
    1666 000411 EB31                          mov xar7, dbl(*(#_usCriticalNesting))   
         000413 F500 
         000415 0000!
    1666              
    1666 000417 ED0C                          mov dbl(*sp(#6)), xar6
         000419 EF   
    1666              ;                       mov *sp(#3), ar6
    1666              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
    1666 00041a EB31                          mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))       
         00041c E500 
         00041e 0000!
    1666              ;                       POP XT
    1666                              ;-- Comment these to save cycles ---
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   56

    1666 000420 ED10                          mov dbl(*sp(#8)), xar7
         000422 FF   
    1666 000423 AF0E                          mov *sp(#7), ar7
    1666              ;                       mov *sp(#5), ar7
    1666              ;                       mov dbl(*sp(#0)), hi(ar7)
    1666              ;                       mov (*sp(#0)), lo(ar7)
    1666 000425 ED14                          mov dbl(*sp(#10)), xar6
         000427 EF   
    1666 000428 AE12                          mov *sp(#9), ar6
    1666 00042a ED18                          mov dbl(*sp(#12)), xar5
         00042c DF   
    1666 00042d AD16                          mov *sp(#11), ar5
    1666              ;; pvPararmeters currently here - needs to be verified --- jcw
    1666 00042f ED1C                          mov dbl(*sp(#14)), xar4
         000431 CF   
    1666 000432 AC1A                          mov *sp(#13), ar4
    1666 000434 ED20                          mov dbl(*sp(#16)), xar3
         000436 BF   
    1666 000437 AB1E                          mov *sp(#15), ar3
    1666 000439 ED24                          mov dbl(*sp(#18)), xar2
         00043b AF   
    1666 00043c AA22                          mov *sp(#17), ar2
    1666 00043e ED28                          mov dbl(*sp(#20)), xar1
         000440 9F   
    1666 000441 A926                          mov *sp(#19), ar1
    1666 000443 ED2C                          mov dbl(*sp(#22)), xar0
         000445 8F   
    1666 000446 A82A                          mov *sp(#21), ar0
    1666 000448 ED30                      mov dbl(*sp(#24)), ac0
         00044a 08   
    1666 00044b A02E              mov *sp(#23), ac0
    1666              
    1666 00044d A732                          mov *sp(#25), t3
    1666 00044f A634                          mov *sp(#26), t2
    1666 000451 A536                          mov *sp(#27), t1
    1666 000453 A438                          mov *sp(#28), t0
    1666              
    1666              ;                       mov dbl(*sp(#21)), *xssp(#0)
    1666              ;                       mov *sp(#21), *ssp
    1666              ;                       mov *sp(#21), RETA
    1666              ; need to move 23-16 to XSSP contents
    1666              ;                       mov xar0, dbl (*(#_save_xar7))
    1666              ;                       mov ssp, ar0
    1666              ;                       mov #0, ssp 
    1666              ;                       mov xssp, xar0
    1666              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
    1666              ;                       aadd #20, sp            ; this is ok - ssp also incremented
    1666                      ;               add #1, xssp            ; 32-bit return address pointer
    1666                      ;               amar *xssp+
    1666              ;                       mov sp, t0
    1666              ;                       add #1, t0
    1666              ;                       mov t0, ssp
    1666              ;                       incr ssp
    1666              ;                       asub #20, ar0
    1666              ;                       mov xar0, xssp
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   57

    1666              ;                       mov ar0, ssp
    1666              ;                       mov ar0, 
    1666              ;;                      mov *sp(#1), t0
    1666              ;;                      mov *sp(#3), t3         ; ST0
    1666              ;;                      mov *sp(#4), t2         ; DBSTAT
    1666              ;;                      mov t3, *ar0(#2)
    1666                      ;;              mov t2, *ar0(#1)
    1666              ;;                      mov t0, *ar0(#0)
    1666              
    1666              ;;                      mov *sp(#5), t0
    1666              ;;                      mov *sp(#6), t1
    1666              ;;                      mov *sp(#7), t2
    1666                      ;;              mov *sp(#8), t3
    1666              
    1666              ; restore ar0
    1666              ;                       mov dbl(*sp(#-2)), xar0
    1666              ;                       mov #-1, ar0
    1666              ;;                      mov dbl (*(#_save_xar7)), xar0
    1666              ;;
    1666              ;;                      mov sp, t0
    1666              ;;                      add #1, t0
    1666              ;;                      mov t0, ssp
    1666              
    1666              ;                       mov *sp(#3), *(#00004ch+#1)
    1666              
    1666              ;                       mov t3, *ssp(#1) 
    1666              ;                       mov t2, *ssp(#2)
    1666              
    1666              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
    1666              ;;                      mov t3, *(ssp(#0))
    1666              ;                       mov t3, *ssp
    1666              ;                       mov *sp(#3), t3 ; 
    1666              ;                       mov t3, *ssp(#1)
    1666              ;;                      mov *sp(#21), PC        
    1666              
    1666              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1666              ;                       mov dbl(xsp), dbl(lcrpc)
    1666              ;                       popboth XAR7
    1666              ;                       add #1, sp
    1666              ;                       add #1, ssp
    1666              ;                       add #2, t0
    1666              ;                       add #2, t1
    1666              ;                       mov t0, sp
    1666              ;                       mov t1, ssp
    1666              ;                       popboth XAR6
    1666              ;                       add #2, t0
    1666              ;                       add #2, t1
    1666              ;                       mov t0, sp
    1666              ;                       mov t1, ssp
    1666              ;                       popboth XAR5
    1666              ;                       add #2, t0
    1666              ;                       add #2, t1
    1666              ;                       mov t0, sp
    1666              ;                       mov t1, ssp
    1666                              ;-----------------------------------
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   58

    1666              ;                       popboth XAR4
    1666              ;                       add #2, t0
    1666              ;                       add #2, t1
    1666              ;                       mov t0, sp
    1666              ;                       mov t1, ssp
    1666              ;                       popboth XAR3
    1666              ;                       add #2, t0
    1666              ;                       add #2, t1
    1666              ;                       mov t0, sp
    1666              ;                       mov t1, ssp
    1666              ;                       popboth XAR2
    1666              ;                       add #2, t0
    1666              ;                       add #2, t1
    1666              ;                       mov t0, sp
    1666              ;                       mov t1, ssp
    1666              ;                       popboth XAR1
    1666              ;                       add #2, t0
    1666              ;                       add #2, t1
    1666              ;                       mov t0, sp
    1666              ;                       mov t1, ssp
    1666              ;                       popboth XAR0
    1666              ;                       add #2, t0
    1666              ;                       add #2, t1
    1666              ;                       mov t0, sp
    1666              ;                       mov t1, ssp
    1666              ;                       EDIS
    1666              ;                       NASP    ; Un-align stack pointer
    1666              ;;                      pop mmap(ST3_55)
    1666              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1666              ;            BCC $2,TC1 ; |216|
    1666                                      .if 0
    1666                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1666              
    1666                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1666                                      mov dbl (*ar7(#2)), xssp                
    1666                                      .endif
    1666              
    1666 000455 ED31                   mov dbl(*(#_restore_xsp)), xsp
         000457 4F00 
         000459 0000!
    1666 00045b ED31               mov dbl(*(#_restore_xssp)), xssp
         00045d 5F00 
         00045f 0000!
    1666              
    1666              ;;;;;;                  mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1666              ;;;;;;                  mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1666              
    1666              
    1666                                      .if 0
    1666                                      mov dbl (*(_xCompareTCB)), xar6
    1666              ; need to restore our return address
    1666                                      mov xar7, ac0
    1666                          mov xar6, ac1
    1666                              CMPU AC1 != AC0, TC1 ; |1393|
    1666                          BCC $6,TC1 ; |1393|
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   59

    1666                          amov #0x000000, xar7
    1666                                      amov #0x000000, xar6
    1666                          mov  *(#_save_new_pxcode), ar7
    1666                                      mov ar7, *sp(#0)
    1666                          mov *(#_save_new_pxlcode) , ar7
    1666                          mov ssp, ar6
    1666                          mov ar7, *ar6(#0)
    1666              
    1666                          mov dbl (*(#_save_xar6)), xar6
    1666                                      .endif
    1666              
    1666              ;;                      mov dbl (*(#_save_xar7)), xar7
    1666              
    1666              ;               .if configSTACK_PTR_DEBUG == 1
    1666              ;;                      mov dbl(*(#_restore_xsp)), xsp
    1666              ;;            mov dbl(*(#_restore_xssp)), xssp
    1666              ;;            .endif
    1666              
    1666              ;                       B $3
    1666              ;$2
    1666              ;           MOV #0, *(#_first_flag) ; |217|
    1666              ;               mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1666              ;                       mov dbl (*(#_first_save_xssp)), xssp
    1666              ;$3
    1666                                      .if 0
    1666                              amov #0x000000, xar7
    1666                                      amov #0x000000, xar6
    1666                                  mov dbl (*(#_pxCurrentTCB)), xar7
    1666                                      mov dbl (*ar7), xar6                            ; xsp normal position
    1666                                      add #0x0064, ar6
    1666                                      mov xar6, xsp                                           ; actual xsp
    1666                                      mov dbl (*ar7(#2)), xar6                        ; xssp
    1666                                      add #0x0002, ar6
    1666                                      mov xar6, xssp
    1666                                      .endif
    1666              
    1666 000461 4EFF                          aadd #-1, sp                    ; on yield, need to do this
    1666 000463 46B2                          bclr INTM               ; enable interrupts
    1666 000465 20                            nop
    1666 000466 20                            nop
    1666 000467 20                            nop
    1666 000468 20                            nop
    1666 000469 20                            nop
    1666 00046a 20                            nop
    1666              
    1666              ;                       aadd #1, sp
    1666 00046b 4805                          RETI
    1666              ;                       mov #1860h, ssp
    1666 00046d 20                            nop
    1666 00046e 20                            nop
    1666              ;                       nop
    1667              
    1668              ; /*-----------------------------------------------------------*/
    1669              
    1670              
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   60

    1671              ;/*
    1672              ; * Manual context switch called by the portYIELD() macro.
    1673              ; */
    1674              
    1675              ; We are using the slow return model:
    1676              
    1677              ; System Stack (SSP)                    Data Stack (SP)
    1678              ; SSP = x - 3:  (Loop Bits):PC(23-16)   SP = y - 3: PC(15-0)  <<= Last pushed - first to POP
    1679              ; SSP = x - 2:  DBSTAT                  SP = y - 2: ST1_55
    1680              ; SSP = x - 1:  ST0_55                  SP = y - 1: ST2_55
    1681              ; SSP = x:      Previously saved data   SP = y:     Previously saved data
    1682              
    1683              
    1684 00046f       _vPortYield:                                    ;; note - most testing done with preemptive kernel - so this 
    1685              
    1686 00046f 4EFF                  aadd #-1, sp
    1687 000471 E651                  MOV #0, *port(#6166) ; |119|
         000473 0018 
         000475 16   
    1688 000476 F402              AND #0x0010, mmap(@IFR0)
         000478 0010 
         00047a 98   
    1689 00047b 46B3                  bset INTM
    1690              ;                /* Mimic an interrupt by pushing the SR. */
    1691              
    1692              ;               /* SR is 16-bits in 430X architecture */
    1693              
    1694              ;;                pushx.w    SR
    1695              
    1696              ;                /* Now the SR is stacked we can disable interrupts. */
    1697              
    1698              ;                dint
    1699              
    1700              ;                 bset INTM             ; disable interrupts
    1701              
    1702              ;;                bicx.w #0xF000,0(r1)
    1703              ;;                swpbx.w +4(r1)
    1704              ;;                rlax.w +4(r1)
    1705              ;;                rlax.w +4(r1)
    1706              ;;                rlax.w +4(r1)
    1707              ;;                rlax.w +4(r1)
    1708              ;;                addx.w +4(r1),0(r1)
    1709              ;;                movx.w +2(r1),+4(r1)
    1710              ;;                movx.w 0(r1),+2(r1)
    1711              ;;                incdx.a r1
    1712              
    1713              ;                /* Save the context of the current task. */
    1714              ;;        psh mmap(ST3_55)
    1715                  .if 1
    1716 00047d EB31                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
         00047f F500 
         000481 0000!
    1717 000483 EB31                          mov xar6, dbl (*(#_save_xar6))                  ; save x
         000485 E500 
         000487 0000!
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   61

    1718 000489 EC31                                                  amov #0x000000, xar7
         00048b FE00 
         00048d 0000 
    1719 00048f EC31                                                  amov #0x000000, xar6
         000491 EE00 
         000493 0000 
    1720              
    1721 000495 AF02                          mov *sp(#1), ar7                                            ;; sp+3
    1722 000497 CF31                          mov ar7, *(#_save_new_pxcode)
         000499 0000 
         00049b 00!  
    1723 00049c 449E                          mov ssp, ar6
    1724 00049e AFCD                          mov *ar6(#1), ar7                                                       ;; ssp+3
         0004a0 0001 
    1725 0004a2 CF31                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and i
         0004a4 0000 
         0004a6 00!  
    1726 0004a7 EC31                          amov #0x000000, xar7
         0004a9 FE00 
         0004ab 0000 
    1727 0004ad AFCD                          mov *ar6(#2), ar7                               ; this is two away now
         0004af 0002 
    1728 0004b1 CF31                                                  mov ar7, *(#_DBSTAT_SAVE)               ;; this is just for r
         0004b3 0000 
         0004b5 00!  
    1729                                   ;   nop
    1730 0004b6 ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         0004b8 FF00 
         0004ba 0000!
    1731 0004bc EB31                          mov xar7, dbl(*(#_xCompareTCB))
         0004be F500 
         0004c0 0000!
    1732                                      .endif
    1733              
    1734              
    1735 ****** MACRO         portSAVE_CONTEXT
    1735              ;                       ;CONTEXT_SAVE
    1735              ;                       ASP  ; Align Stack Pointer
    1735              ;                       CLRC       OVM,PAGE0
    1735              ;                       CLRC       AMODE
    1735              ;                       EALLOW
    1735 0004c2 4652                  bclr C54CM      ; temp - until we figure out what is setting this
    1735              ;;;             bset INTM               ; disable interrupts - already done
    1735              ;                       aadd #1, sp
    1735 0004c4 20                            nop
    1735 0004c5 20                            nop
    1735 0004c6 20                            nop
    1735              
    1735 0004c7 EB31                          mov xsp,  dbl (*(#_Ssave_xsp))                  ; save xsp
         0004c9 4500 
         0004cb 0000!
    1735 0004cd EB31                          mov xssp, dbl (*(#_Ssave_xssp))                 ; save xssp
         0004cf 5500 
         0004d1 0000!
    1735              ;;;                     mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   62

    1735              ;;;                     mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1735              
    1735              ;                       pshboth xar7
    1735              ;                       pshboth xar6
    1735              ;                       pshboth xar5
    1735              
    1735              ;;;;                    mov xar7, dbl (*(#_save_xar7))                  ; save xar7 (already saved)
    1735              ;                       .if configUSE_CONTEXT_DEBUG == 1
    1735              ;;;;                    mov xar6, dbl (*(#_save_xar6))                  ; saved in vTick ISR already
    1735              ;                       .endif
    1735 0004d3 4E01                          aadd #1, sp
    1735              ; +++===+++
    1735              
    1735                                      .if 1                                                           ; need to figure out 
    1735 0004d5 EB31                          mov xar1, dbl (*(#_save_xar1))
         0004d7 9500 
         0004d9 0000!
    1735 0004db EB31                          mov xar2, dbl (*(#_save_xar2))
         0004dd A500 
         0004df 0000!
    1735 0004e1 EB31                          mov xar3, dbl (*(#_save_xar3))
         0004e3 B500 
         0004e5 0000!
    1735 0004e7 EB31                          mov xar4, dbl (*(#_save_xar4))
         0004e9 C500 
         0004eb 0000!
    1735 0004ed EC31                          amov #0x000000, xar5
         0004ef DE00 
         0004f1 0000 
    1735 0004f3 EC31                          amov #0x000000, xar6
         0004f5 EE00 
         0004f7 0000 
    1735 0004f9 904D                          mov xsp, xar5
    1735 0004fb 905E                          mov xssp, xar6
    1735 0004fd EC31                          amov #0x000000, xar2
         0004ff AE00 
         000501 0000 
    1735 000503 EC31                          amov #0x000000, xar1
         000505 9E00 
         000507 0000 
    1735 000509 EC31                          amov #0x000000, xar3
         00050b BE00 
         00050d 0000 
    1735 00050f EC31                          amov #0x000000, xar4
         000511 CE00 
         000513 0000 
    1735              ;                       mov dbl (*(#_pxCurrentTCB)), xar5
    1735              
    1735 000515 EDE1                          mov dbl (*ar7), xar4                            ; xsp contains our TCB now
         000517 CF   
    1735 000518 EDED                          mov dbl (*ar7(#2)), xar3
         00051a BF00 
         00051c 02   
    1735 00051d 7B00                          add #0x0064, ar4
         00051f 64CC 
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   63

    1735 000521 402B                          add #0x0002, ar3
    1735              
    1735 000523 AAAD                          mov *ar5(#0), ar2                               ; current xsp contents
         000525 0000 
    1735 000527 A9CD                          mov *ar6(#0), ar1                               ; current xssp contents
         000529 0000 
    1735              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1735 00052b CA81                          mov ar2, *ar4                           ; saves our new PC - but, does this work in e
    1735 00052d C961                          mov ar1, *ar3
    1735                                      .endif
    1735              ;;                      aadd #1, sp
    1735                                      .if 0
    1735                          amov #0x000000, xar7
    1735                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1735                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1735                                      mov dbl (*ar7(#2)), xssp
    1735                          amov #0x000000, xar7
    1735                                      amov #0x000000, xar6
    1735                          mov *(#_save_new_pxcode), ar7
    1735                          mov ar7, *sp(#0)
    1735                          amov #0x000000, xar7
    1735                          mov ssp, ar6
    1735                          mov *(#_save_new_pxlcode), ar7
    1735              ;            mov ar7, *ssp(#0)
    1735                          mov ar7, *ar6(#0)
    1735                              .endif
    1735              
    1735              ;                       mov ssp, ar7
    1735              ;                       mov *ar7(#1), ar6                               ; this is (one)two away now
    1735              ;                       mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
    1735              ;                       .endif
    1735              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1735              ;            mov xar6, dbl (*(#_save_xar6))                  ; save x
    1735                                      .if 0
    1735                                      amov #0x000000, xar7
    1735                                      amov #0x000000, xar6
    1735                          mov *sp(#0), ar7                                            ;; sp+3
    1735                          mov ar7, *(#_save_new_pxcode)
    1735                          mov ssp, ar6
    1735                          mov *ar6(#1), ar7                                                       ;; ssp+3
    1735                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and if a task, it
    1735                                   ;   nop
    1735                          mov dbl (*(#_pxCurrentTCB)), xar7
    1735                          mov xar7, dbl(*(#_xCompareTCB))
    1735                          .endif
    1735              ; +++===+++
    1735              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1735              ;
    1735              
    1735              
    1735              ; +++===+++
    1735                                      .if 0
    1735              ;                       mov dbl (*(_xCompareTCB)), xar6                 ; need to save our return address
    1735              ;                       mov xar7, ac0
    1735              ;               mov xar6, ac1
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   64

    1735              ;                       CMPU AC1 != AC0, TC1
    1735              ;                               BCC $5,TC1
    1735                                      amov #0x000000, xar7
    1735                                          amov #0x000000, xar6
    1735                                          mov  *(#_save_new_pxcode), ar7
    1735                                          mov ar7, *sp(#0)
    1735                              mov *(#_save_new_pxlcode) , ar7
    1735                              mov ssp, ar6
    1735                              mov ar7, *ar6(#0)
    1735                              mov dbl (*(#_save_xar6)), xar6
    1735                                         .endif
    1735              ; +++===+++
    1735 00052f       $5_$4$:
    1735                                              
    1735              ; +++===+++
    1735              ;; what about xssp here?
    1735              ;;                              mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1735              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1735                                 .if configUSE_CONTEXT_DEBUG == 1
    1735              ;; save current PC (and possible loop bits values)
    1735              ;; for debug - to see if this is being corrupted
    1735                                      mov dbl(*ar7), xar6
    1735                                      mov dbl(*ar6), xar7
    1735                                      mov xar7, dbl (*(#_PC_REG_LOW_SAVE))            ; save off the PC
    1735                                      mov xssp, xar7
    1735                                      mov dbl(*ar7), xar6
    1735                                      mov dbl(*ar6), xar7
    1735                                      mov xar7, dbl (*(#_PC_REG_HIGH_SAVE))           ; save off the PC
    1735                                      mov xssp, xar7
    1735                                      add #-2, ar7
    1735                                      mov dbl(*ar7), xar6
    1735                                      mov xar6,  dbl (*(_DBSTAT_SAVE))
    1735                          mov dbl (*(#_save_xar6)), xar6
    1735              
    1735              ;            mov (*ar7), (*(#_PC_REG_LOW_SAVE))
    1735              ;            mov dbl(*xssp),(*(#_PC_REG_HIGH_SAVE))
    1735              ;                       mov (*ssp(#-2)), (*(#_DBSTAT_SAVE))
    1735                                      .endif
    1735              ; +++===+++
    1735                                      ; save context in our stack(s) frame
    1735              
    1735              ;;;;                    mov dbl (*(#_pxCurrentTCB)), xar7
    1735              ;;;                     mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1735              ;;;                     mov dbl (*ar7(#2)), xssp
    1735              ; +++===+++
    1735              ;                   mov dbl (*(#_pxCurrentTCB)), xar7
    1735                                  ; add #0x0064, ar7
    1735              ;                       mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
    1735              ;                       mov dbl (*ar7(#2)), xssp
    1735              ;           add #0x0064, ar4
    1735              ;                       add #0x0064, ar3
    1735              ;                       mov dbl (*ar5), xar4                            ; xsp contains our TCB now
    1735              ;                       mov dbl (*ar5(#2)), xar3                        ; xssp
    1735              ;                       add #0x0064, ar4
    1735              ;                       add #0x0064, ar3
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   65

    1735 00052f EC31                  amov #0x000000, xar7
         000531 FE00 
         000533 0000 
    1735 000535 EC31                          amov #0x000000, xar6
         000537 EE00 
         000539 0000 
    1735 00053b ED31                      mov dbl (*(#_pxCurrentTCB)), xar7
         00053d FF00 
         00053f 0000!
    1735 000541 EDE1                          mov dbl (*ar7), xar6                            ; xsp normal position
         000543 EF   
    1735 000544 7B00                          add #0x0064, ar6
         000546 64EE 
    1735 000548 90E4                          mov xar6, xsp                                           ; actual xsp
    1735 00054a EDED                          mov dbl (*ar7(#2)), xar6                        ; xssp
         00054c EF00 
         00054e 02   
    1735 00054f 402E                          add #0x0002, ar6
    1735 000551 90E5                          mov xar6, xssp
    1735              
    1735 000553 ED31              mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         000555 FF00 
         000557 0000!
    1735 000559 ED31              mov dbl (*(#_save_xar6)), xar6
         00055b EF00 
         00055d 0000!
    1735              ;            mov dbl (*(#_save_xar1)), xar1                  ; restore xar7
    1735              ;            mov dbl (*(#_save_xar2)), xar2
    1735              ;            mov dbl (*(#_save_xar3)), xar3                  ; restore xar7
    1735              ;            mov dbl (*(#_save_xar4)), xar4
    1735                                        ; restore xar6
    1735              ;;; begin context save:
    1735              
    1735 00055f EB10                          mov xar7, dbl(*sp(#8))                          ; save xar7
         000561 F5   
    1735 000562 CF0E                          mov ar7, *sp(#7)
    1735              
    1735 000564 EB14                          mov xar6, dbl(*sp(#10))
         000566 E5   
    1735 000567 CE12                          mov ar6, *sp(#9)
    1735              
    1735 000569 EB18                          mov xar5, dbl(*sp(#12))
         00056b D5   
    1735 00056c CD16                          mov ar5, *sp(#11)
    1735              
    1735 00056e EB1C                          mov xar4, dbl(*sp(#14))
         000570 C5   
    1735 000571 CC1A                          mov ar4, *sp(#13)
    1735              
    1735 000573 EB20                          mov xar3, dbl(*sp(#16))
         000575 B5   
    1735 000576 CB1E                          mov ar3, *sp(#15)
    1735              
    1735 000578 EB24                          mov xar2, dbl(*sp(#18))
         00057a A5   
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   66

    1735 00057b CA22                          mov ar2, *sp(#17)
    1735              
    1735 00057d EB28                          mov xar1, dbl(*sp(#20))
         00057f 95   
    1735 000580 C926                          mov ar1, *sp(#19)
    1735              
    1735 000582 EB2C                          mov xar0, dbl(*sp(#22))
         000584 85   
    1735 000585 C82A                          mov ar0, *sp(#21)
    1735              
    1735 000587 EB30              mov  ac0, dbl(*sp(#24))
         000589 08   
    1735 00058a C02E              mov ac0, *sp(#23)
    1735              
    1735 00058c C732                          mov t3, *sp(#25)
    1735 00058e C634                          mov t2, *sp(#26)
    1735 000590 C536                          mov t1, *sp(#27)
    1735 000592 C438                          mov t0, *sp(#28)
    1735              ; +++===+++
    1735              ;;                      mov mmap(ST0_55), t0
    1735              ; - this is ok - we are not pushing - it's a relative stack frame
    1735              ;                       mov t0, *sp(#25)
    1735              ;;                      mov t0, *sp(#23)
    1735              ;;                      mov mmap(ST1_55), t1
    1735              ;                       mov t1, *sp(#26)                ; stomping on own mem
    1735              ;;                      mov t1, *sp(#21)                ; stomping on own mem
    1735              ;;                      mov mmap(ST2_55), t2
    1735              ;;                      mov t2, *sp(#22)
    1735              ;                       mov t2, *sp(#27)
    1735              ;;                      mov mmap(ST2_55), t3
    1735              ;                       mov t3, *sp(#28)
    1735              ;;                      mov t3, *sp(#24)
    1735              
    1735              ;                       PSH dbl(AR0) ; 32-bit
    1735              ;                       PSH dbl(AR1) 
    1735              ;                       PSH dbl(AR2) ; 32-bit
    1735              ;                       PUSH XAR3 ; 32-bit
    1735              ;                       PUSH XAR4 ; 32-bit
    1735                              ;-- Comment these to save cycles --------
    1735              ;                       PUSH XAR5 ; 32-bit
    1735              ;                       PUSH XAR6 ; 32-bit
    1735              ;                       PUSH XAR7 ; 32-bit
    1735                              ;----------------------------------------
    1735              
    1735              ;                       PUSH XT   ; 32-bit
    1735              
    1735              ;                       movl xar6, @_portFLAGS_INT_ENABLED
    1735              ;                       push xar6 ; portFLAGS_INT_ENABLED
    1735              ; +++===+++
    1735              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1735              ;                       mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
    1735              ;                       mov dbl (*ar7(#2)), xssp
    1735              
    1735 000594 ED31                          mov dbl (*(#_portFLAGS_INT_ENABLED)), xar6
         000596 EF00 
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   67

         000598 0000!
    1735 00059a EB0C                          mov xar6, dbl(*sp(#6))
         00059c E5   
    1735              
    1735              ;                       movl xar7, @_usCriticalNesting
    1735              ;                       push xar7
    1735 00059d ED31                          mov dbl (*(#_usCriticalNesting)), xar7
         00059f FF00 
         0005a1 0000!
    1735 0005a3 EB08                          mov xar7, dbl(*sp(#4))
         0005a5 F5   
    1735              
    1735 0005a6 EC31                          amov #0x000000, xar7
         0005a8 FE00 
         0005aa 0000 
    1735 0005ac EC31                          amov #0x000000, xar6
         0005ae EE00 
         0005b0 0000 
    1735              
    1735 0005b2 AF06                          mov mmap(ST1_55), ar7
         0005b4 98   
    1735 0005b5 CF02                          mov ar7, *sp(#1)
    1735 0005b7 AF96                          mov  mmap(ST2_55), ar7
         0005b9 98   
    1735 0005ba CF04                          mov ar7, *sp(#2)
    1735              
    1735 0005bc 449F                          mov ssp, ar7
    1735              ;                       mov *(#_LOOP_BITS), ar6                 ; save LOOP_BITS (CFCT)
    1735              ;                       and #0xFF00, ar6
    1735              ;                       mov ar6, *ar7(#1)
    1735              
    1735 0005be AE04                          mov mmap(ST0_55), ar6
         0005c0 98   
    1735 0005c1 CEED                          mov ar6, *ar7(#2)
         0005c3 0002 
    1735                                      
    1735 0005c5 AE31                          mov *(#_DBSTAT_SAVE), ar6               ; save DBSTAT
         0005c7 0000 
         0005c9 00!  
    1735 0005ca CEED                          mov ar6, *ar7(#1)
         0005cc 0001 
    1735              ; +++===+++
    1735              ;                       mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
    1735              ;                       mov dbl (*(#_save_xssp)), xssp          
    1735              ;;;                     mov  dbl (*(_DBSTAT_SAVE)), *xar7(#2)   ; needs to be DBSTAT - don't overwrite DBSTAT
    1735              ;;;                     mov ar6, *ar7(#2)
    1735              ;                       mov ar7, mmap(ST0_55)
    1735              ;                       mov *ssp(#2), ar7
    1735              ; fix up
    1735              ;                       aadd #20, sp
    1735              ;                       mov sp, t0
    1735              ;                       sub #1, t0
    1735              ;                       mov t0, ssp
    1735              
    1735                                      ; move contents of SP into address of current TCB
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   68

    1735              ;                       mov xsp, dbl (*(#_pxCurrentTCB))                ; xsp contains our TCB now
    1735              
    1735              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1735              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1735              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1735              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1735              ;                       mov dbl (*ar7+), xssp
    1735              
    1735              ;                       mov sp, t0              ; we've already saved t0
    1735              ;                       add #1, t0
    1735              ;                       mov t0, ssp
    1735              ; ??
    1735              ;                       mov xsp, dbl (*(#_pxCurrentTCB))
    1735              
    1735              ;                       movl xar6, @_pxCurrentTCB ; XAR6 contains current TCB addr
    1735              ;                       mov al, @sp
    1735              ;                       movl  *xar6, acc        
    1735              ;;                      mov  ar0, @sp
    1735              ;;                      mov  @ar6, alxd
    1735              ;;                      mov  ar0, @sp
    1735              ;;                      movl 0(xar6), sp
    1735              ;                       EDIS
    1735              ;                       NASP
    1735              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1735              ;                       NOP
    1735              ;                       .if configSTACK_PTR_DEBUG == 1
    1735              ;                       mov xsp, dbl(*(#_Ssave_xsp))
    1735              ;            mov xssp, dbl(*(#_Ssave_xssp))
    1735              ;            .endif
    1735                              .if 0
    1735                                      mov  xar7, dbl (*(#_save_xar7))                 ; restore xar7
    1735                          mov  xar6, dbl (*(#_save_xar6))
    1735              
    1735                              amov #0x000000, xar7
    1735                                      amov #0x000000, xar6
    1735                                  mov dbl (*(#_pxCurrentTCB)), xar7
    1735                                      mov dbl (*ar7), xar6                            ; xsp normal position
    1735                                      add #0x0064, ar6
    1735                                      mov xar6, xsp                                           ; actual xsp
    1735                                      mov dbl (*ar7(#2)), xar6                        ; xssp
    1735                                      add #0x0002, ar6
    1735                                      mov xar6, xssp
    1735              
    1735                          mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1735                          mov dbl (*(#_save_xar6)), xar6
    1735                        .endif
    1735              
    1735              ;;;;                    mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
    1735              ;;;;                    mov dbl (*(#_save_xssp)), xssp
    1735              
    1735 0005ce ED31                          mov dbl (*(#_Ssave_xsp)), xsp                   ; restore xsp*
         0005d0 4F00 
         0005d2 0000!
    1735 0005d4 ED31                          mov dbl (*(#_Ssave_xssp)), xssp                 ; restore xssp
         0005d6 5F00 
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   69

         0005d8 0000!
    1735              
    1735 0005da 20                            nop
    1735              ;                       aadd #-1, sp
    1735 0005db 20                            nop
    1735              
    1735 0005dc 20                            nop
    1735                                                                                      ; ?
    1736              
    1737              ;        /* Switch to the highest priority task that is ready to run. */
    1738 0005dd 6C00          call    #_vTaskSwitchContext
         0005df 0000!
    1739                                      .if 1
    1740 0005e1 EB31                          mov xar7, dbl (*(#_save_xar7))                  ; save xar7
         0005e3 F500 
         0005e5 0000!
    1741 0005e7 EB31              mov xar6, dbl (*(#_save_xar6))
         0005e9 E500 
         0005eb 0000!
    1742 0005ed EB31              mov ac0, dbl (*(#_save_ac0))                  ; save xar7
         0005ef 0800 
         0005f1 0000!
    1743 0005f3 EB31              mov ac1, dbl (*(#_save_ac1))
         0005f5 1800 
         0005f7 0000!
    1744 0005f9 EB31              mov xar1, dbl(*(#_save_xar1))
         0005fb 9500 
         0005fd 0000!
    1745 0005ff EC31              amov #0x000000, xar7
         000601 FE00 
         000603 0000 
    1746 000605 EC31                          amov #0x000000, xar6
         000607 EE00 
         000609 0000 
    1747 00060b ED31                          mov dbl (*(_xCompareTCB)), xar6
         00060d EF00 
         00060f 0000!
    1748 000611 ED31                      mov dbl (*(#_pxCurrentTCB)), xar7
         000613 FF00 
         000615 0000!
    1749                          ; need to restore our return address
    1750 000617 3C00              mov #0x000000, ac0
    1751 000619 3C01                          mov #0x000000, ac1
    1752 00061b 90F0                          mov xar7, ac0
    1753 00061d 90E1              mov xar6, ac1
    1754 00061f 1210                  CMPU AC1 == AC0, TC1 ; |1393|
         000621 04   
    1755 000622 0464              BCC $B,TC1 ; |1393|
         000624 36   
    1756 000625 20                nop                 ; breakpoint here - context switch has occurred
    1757                          .if configUSE_TICK_CTR == 1
    1758 000626 F731                      add #1, *(#_context_switch_counter)
         000628 0001 
         00062a 0000 
         00062c 00!  
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   70

    1759                                  .endif
    1760 00062d EC31                      amov #0x000000, xar7
         00062f FE00 
         000631 0000 
    1761 000633 EC31                      amov #0x000000, xar1
         000635 9E00 
         000637 0000 
    1762 000639 AF31                      mov *(#_save_new_pxcode), ar7
         00063b 0000 
         00063d 00!  
    1763 00063e A9CD                      mov *ar6(#0), ar1
         000640 0000 
    1764 000642 7B00                      add #0x0064, ar1
         000644 6499 
    1765 000646 CF21                      mov ar7, *ar1
    1766 000648 AF31                      mov *(#_save_new_pxlcode), ar7
         00064a 0000 
         00064c 00!  
    1767 00064d EC31                      amov #0x000000, xar1
         00064f 9E00 
         000651 0000 
    1768 000653 A9CD                      mov *ar6(#2), ar1
         000655 0002 
    1769 000657 4029                      add #0x0002, ar1
    1770 000659 CF21                      mov ar7, *ar1
    1771                                  ; amov #0x000000, xar7
    1772                                      ;    amov #0x000000, xar6
    1773                          ;  mov  *(#_save_new_pxcode), ar7
    1774                                      ;    mov ar7, *sp(#0)
    1775                          ;                mov *(#_save_new_pxlcode) , ar7
    1776                          ;                mov ssp, ar6
    1777                          ;                mov ar7, *ar6(#0)
    1778              
    1779                          ;                mov dbl (*(#_save_xar6)), xar6
    1780                                      ;                       .endif
    1781              ; +++===+++
    1782 00065b       $B:
    1783 00065b ED31              mov dbl (*(#_save_ac0)), ac0                  ; save xar7
         00065d 0800 
         00065f 0000!
    1784 000661 ED31              mov dbl (*(#_save_ac1)), ac1
         000663 1800 
         000665 0000!
    1785 000667 ED31              mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         000669 FF00 
         00066b 0000!
    1786 00066d ED31              mov dbl (*(#_save_xar6)), xar6
         00066f EF00 
         000671 0000!
    1787 000673 ED31              mov dbl (*(#_save_xar1)), xar1
         000675 9F00 
         000677 0000!
    1788                       .endif
    1789              ;        .endif
    1790              
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   71

    1791 000679 E651          mov #1, *port(#6166) ; |127|
         00067b 0118 
         00067d 16   
    1792 00067e F551                  or #0x0001, *port(#7188) ; |130|
         000680 0001 
         000682 1C14 
    1793 000684 4E01                  aadd #1, sp
    1794 ****** MACRO         portRESTORE_CONTEXT
    1794                                      .C54CM_off
    1794              ;                       .CPL_off
    1794                                      .ARMS_off
    1794                                      .align 4
    1794              
    1794              ; Restore context & return
    1794                                      ;CONTEXT_RESTORE
    1794              ;                       ASP
    1794              ;                       EALLOW
    1794              ;                       nop
    1794              ;                       nop
    1794              ;                       nop
    1794              ;                       nop
    1794 000688 4652                  bclr C54CM
    1794 00068a 20                    nop
    1794 00068b 20                    nop
    1794 00068c 20                    nop
    1794 00068d 20                    nop
    1794 00068e 20                    nop
    1794 00068f 20                    nop
    1794              ;               xssp = dbl(*(#_pxCurrentTCB))
    1794              ;               xsp  = dbl(*(#_pxCurrentTCB))
    1794 000690 EB31                          mov xar7, dbl (*(#_save_xar7))  
         000692 F500 
         000694 0000!
    1794 000696 EB31                          mov xar6, dbl (*(#_save_xar6))
         000698 E500 
         00069a 0000!
    1794              
    1794              ;                        aadd #-3, sp                           ;;;;
    1794              ;            aadd #-3, xsp
    1794              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1794              ;            BCC $1,TC1 ; |216|
    1794              ;;                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1794              ;;                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1794              ;            B $4
    1794 00069c EB31                          mov xsp, dbl (*(#_restore_xsp))                 ; save xsp
         00069e 4500 
         0006a0 0000!
    1794 0006a2 EB31                          mov xssp, dbl (*(#_restore_xssp))                       ; save xssp
         0006a4 5500 
         0006a6 0000!
    1794               ;                      aadd #3, xsp
    1794 0006a8 4EFF                  aadd #-1, sp
    1794              ;$1
    1794              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1794              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   72

    1794              ;$4
    1794                                      .if 1
    1794 0006aa 904F                          mov xsp, xar7
    1794 0006ac 905E                          mov xssp, xar6
    1794 0006ae EC31                          amov #0x000000, xar2
         0006b0 AE00 
         0006b2 0000 
    1794 0006b4 EC31                          amov #0x000000, xar1
         0006b6 9E00 
         0006b8 0000 
    1794              
    1794 0006ba ED31                          mov dbl (*(#_pxCurrentTCB)), xar5
         0006bc DF00 
         0006be 0000!
    1794                                                                                               ;; points to our variables n
    1794 0006c0 EDA1                          mov dbl (*ar5), xar4                            ; xsp contains our TCB now
         0006c2 CF   
    1794 0006c3 EDAD                          mov dbl (*ar5(#2)), xar3
         0006c5 BF00 
         0006c7 02   
    1794 0006c8 7B00                          add #0x0064, ar4
         0006ca 64CC 
    1794 0006cc 402B                          add #0x0002, ar3
    1794                                      
    1794              ;;                      mov xar4, xsp
    1794              ;;                      mov xar3, xssp
    1794              
    1794 0006ce AA81                          mov *ar4, ar2
    1794 0006d0 A961                          mov *ar3, ar1                           ; maybe not on a yield here
    1794              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1794 0006d2 CAE1                          mov ar2, *ar7
    1794 0006d4 C9C1                          mov ar1, *ar6
    1794              
    1794 0006d6 AF06                          mov mmap(ST1_55), ar7
         0006d8 98   
    1794 0006d9 7DF7                          and #0xf7ff, ar7                        ; <here>#0800h
         0006db FFFF 
    1794 0006dd CF02                          mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1794 0006df CF8D                          mov ar7, *ar4(#1)                       ; save in TCB
         0006e1 0001 
    1794 0006e3 AF96                          mov mmap(ST2_55), ar7
         0006e5 98   
    1794 0006e6 CF04                          mov ar7, *sp(#2)
    1794 0006e8 CF8D                          mov ar7, *ar4(#2)
         0006ea 0002 
    1794              
    1794 0006ec 449F                          mov ssp, ar7
    1794 0006ee AE04                          mov mmap(ST0_55), ar6
         0006f0 98   
    1794 0006f1 CEED                          mov ar6, *ar7(#2)
         0006f3 0002 
    1794 0006f5 CE6D                          mov ar6, *ar3(#2)
         0006f7 0002 
    1794 0006f9 AE31                          mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
         0006fb 0000 
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   73

         0006fd 00!  
    1794              ;;                      mov ar6, *ar7(#1)
    1794 0006fe CE6D                          mov ar6, *ar3(#1)
         000700 0001 
    1794                                      .endif
    1794              
    1794              ;                       mov #0, ssp     
    1794              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1794              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1794                                      ; 32-bit mode - will act on SP and SSP:
    1794              ;                       'fix-up' current SP and SSP - is this dangerous????
    1794              ;                       aadd #-3, sp
    1794              ;;                      mov *ar7, *sp
    1794              ;                       mov dbl (*ar7), ar6
    1794              ;                       mov ar6, *sp                            ; xsp contains our TCB now
    1794              ;                       mov *ar7(#2), *ssp                      
    1794              ;                       POP mmap(ST3_55)
    1794              ;                       pshboth xar7                            ; should increment both
    1794                                      .if 0
    1794                                      mov mmap(ST1_55), ar7
    1794                                      and #0xf7ff, ar7                        ; <here>#0800h
    1794                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1794                                      mov mmap(ST2_55), ar7
    1794                                      mov ar7, *sp(#2)
    1794              
    1794                                      mov ssp, ar7
    1794                                      mov mmap(ST0_55), ar6
    1794                                      mov ar6, *ar7(#2)
    1794              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
    1794              ;;                      mov ar6, *ar7(#1)
    1794                                      .endif
    1794              ; +++===+++
    1794                                      .if 0
    1794                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1794                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1794                                      mov dbl (*ar7(#2)), xssp        
    1794                                      .endif
    1794              ; +++===+++
    1794                                      .if 0
    1794                                      mov dbl (*(_xCompareTCB)), xar6
    1794              ; need to restore our return address
    1794                                      mov xar7, ac0
    1794                                          mov xar6, ac1
    1794                                          CMPU AC1 != AC0, TC1 ; |1393|
    1794                                          BCC $6,TC1 ; |1393|
    1794                                          amov #0x000000, xar7
    1794                                          amov #0x000000, xar6
    1794                                          mov  *(#_save_new_pxcode), ar7
    1794                                          mov ar7, *sp(#0)
    1794                                          mov *(#_save_new_pxlcode) , ar7
    1794                                          mov ssp, ar6
    1794                                          mov ar7, *ar6(#0)
    1794              
    1794                                          mov dbl (*(#_save_xar6)), xar6
    1794                                                              .endif
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   74

    1794              ; +++===+++
    1794 000702       $6_$5$:
    1794              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
    1794              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1794                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
    1794                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1794                                      mov xar6, dbl (*(#_save_xar6))
    1794              
    1794              ;; this is for debug
    1794                                      mov dbl(*ar7), xar6
    1794                                      mov dbl(*ar6), xar7
    1794                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
    1794                                      mov xssp, xar7
    1794                                      mov dbl(*ar7), xar6
    1794                                      mov dbl(*ar6), xar7
    1794                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
    1794                                      mov xssp, xar7
    1794                                      add #-2, ar7
    1794                                      mov dbl(*ar7), xar6
    1794                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
    1794                                      mov dbl (*(#_save_xar6)), xar6
    1794                                      
    1794                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1794                                      .endif
    1794              ; +++===+++
    1794              ;                       mov mmap(ST0_55), *ssp(#1)
    1794              ;                       mov mmap(STO_55), *ssp(#2)
    1794              ;                       mov mmap(ST1_55), *sp(#1)
    1794              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
    1794              ;                       mov *ar7, t0
    1794              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
    1794              ;                       mov *ar7(#2), t0
    1794              ;                       mov t0, *ssp(#0)                        
    1794              
    1794              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
    1794              ; what about xssp?
    1794              ;                       mov xar6, xsp
    1794              ;                       mov xssp, xar7
    1794              ;                       add #1, ar7
    1794              ;                       mov xar7, xsp
    1794              ;                       mov sp, t0
    1794              ;                       mov ssp, t1
    1794              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
    1794              ;                       ar0 = *ar6
    1794              ;                       xssp = xar0
    1794              ;                       mov *xar6, xar0
    1794              ;                       mov xar0, xssp  ; stack now points to our TCB
    1794              ;;                      mov sp, *ar6
    1794              ;;                      mov sp, ar0
    1794              ;;                      mov sp, *_pxCurrentTCB
    1794              ;;                      clr ar0
    1794              ;;                      mov ar0, @xar6
    1794              ;;                      mov sp, AR0
    1794              ;;                      add sp, xar6
    1794              
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   75

    1794              ;;                      pshboth xar7
    1794              ;;                      pshboth xar6
    1794              ;;                      pshboth xar5
    1794              
    1794              ;;                      popboth xar5
    1794              ;;                      popboth xar6
    1794              ;;                      popboth xar7
    1794              
    1794              ;;;                     mov *sp(#1), ar7 
    1794              ;                       mov dbl(*sp(#1)), ar7
    1794              ;;;                     mov  ar7, mmap(ST1_55)
    1794              ; +++===+++
    1794              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1794              ;                       add #0x0064, ar7
    1794              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1794              ;                       mov *ar7(#2)
    1794              ;                       mov dbl (*ar7(#2)), xssp
    1794              ; ===+++===
    1794                 .if 0
    1794                              amov #0x000000, xar7
    1794                                      amov #0x000000, xar6
    1794                                  mov dbl (*(#_pxCurrentTCB)), xar7
    1794                                      mov dbl (*ar7), xar6                            ; xsp normal position
    1794                                      add #0x0064, ar6
    1794                                      mov xar6, xsp                                           ; actual xsp
    1794                                      mov dbl (*ar7(#2)), xar6                        ; xssp
    1794                                      add #0x0002, ar6
    1794                                      mov xar6, xssp
    1794                 .endif
    1794              ; ===+++===
    1794              ;                       add #0x0064, xssp
    1794              ; +++===+++
    1794                                      .if 0
    1794                                      mov *sp(#2), ar7
    1794                                      mov ar7, mmap(ST2_55)
    1794                                      mov ssp, ar7
    1794                                      mov *ar7(#2), ar6
    1794                                      mov ar6, mmap(ST0_55)
    1794                                      .endif
    1794              ;                       mov *ar7(#2), ar6
    1794              ;                       mov ar6, *ssp(#2)
    1794              ;                       mov *ssp(#2), ar7
    1794              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
    1794              ;
    1794              ; restore context
    1794              
    1794 000702 EC31                          amov #0x000000, xar2
         000704 AE00 
         000706 0000 
    1794 000708 EC31                          amov #0x000000, xar1
         00070a 9E00 
         00070c 0000 
    1794              
    1794                                      .if 0
    1794                                      mov mmap(ST1_55), ar7
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   76

    1794                                      and #0xf7ff, ar7                        ; <here>#0800h
    1794                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1794                                      mov ar7, mmap(ST1_55)
    1794              ;                       mov ar7, *ar4(#1)                       ; save in TCB
    1794                                      mov mmap(ST2_55), ar7
    1794                                      mov ar7, *sp(#2)
    1794              ;                       mov ar7, *ar4(#2)
    1794              
    1794                                      mov ssp, ar7
    1794                                      mov mmap(ST0_55), ar6
    1794                                      mov ar6, *ar7(#2)
    1794              ;                       mov ar6, *ar3(#2)
    1794                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
    1794                                      mov ar6, *ar7(#1)
    1794              ;                       mov ar6, *ar3(#2)
    1794                                      .endif
    1794              ;;                      mov *(#_LOOP_BITS), ar6         ; have to restore this
    1794              ;;                      and #0xFF00, ar6
    1794              ;;                      mov ar6, *ar7(#1)
    1794              
    1794 00070e ED08                          mov dbl(*sp(#4)), xar7
         000710 FF   
    1794              ;                       mov *sp(#1), ar7
    1794 000711 EB31                          mov xar7, dbl(*(#_usCriticalNesting))   
         000713 F500 
         000715 0000!
    1794              
    1794 000717 ED0C                          mov dbl(*sp(#6)), xar6
         000719 EF   
    1794              ;                       mov *sp(#3), ar6
    1794              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
    1794 00071a EB31                          mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))       
         00071c E500 
         00071e 0000!
    1794              ;                       POP XT
    1794                              ;-- Comment these to save cycles ---
    1794 000720 ED10                          mov dbl(*sp(#8)), xar7
         000722 FF   
    1794 000723 AF0E                          mov *sp(#7), ar7
    1794              ;                       mov *sp(#5), ar7
    1794              ;                       mov dbl(*sp(#0)), hi(ar7)
    1794              ;                       mov (*sp(#0)), lo(ar7)
    1794 000725 ED14                          mov dbl(*sp(#10)), xar6
         000727 EF   
    1794 000728 AE12                          mov *sp(#9), ar6
    1794 00072a ED18                          mov dbl(*sp(#12)), xar5
         00072c DF   
    1794 00072d AD16                          mov *sp(#11), ar5
    1794              ;; pvPararmeters currently here - needs to be verified --- jcw
    1794 00072f ED1C                          mov dbl(*sp(#14)), xar4
         000731 CF   
    1794 000732 AC1A                          mov *sp(#13), ar4
    1794 000734 ED20                          mov dbl(*sp(#16)), xar3
         000736 BF   
    1794 000737 AB1E                          mov *sp(#15), ar3
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   77

    1794 000739 ED24                          mov dbl(*sp(#18)), xar2
         00073b AF   
    1794 00073c AA22                          mov *sp(#17), ar2
    1794 00073e ED28                          mov dbl(*sp(#20)), xar1
         000740 9F   
    1794 000741 A926                          mov *sp(#19), ar1
    1794 000743 ED2C                          mov dbl(*sp(#22)), xar0
         000745 8F   
    1794 000746 A82A                          mov *sp(#21), ar0
    1794 000748 ED30                      mov dbl(*sp(#24)), ac0
         00074a 08   
    1794 00074b A02E              mov *sp(#23), ac0
    1794              
    1794 00074d A732                          mov *sp(#25), t3
    1794 00074f A634                          mov *sp(#26), t2
    1794 000751 A536                          mov *sp(#27), t1
    1794 000753 A438                          mov *sp(#28), t0
    1794              
    1794              ;                       mov dbl(*sp(#21)), *xssp(#0)
    1794              ;                       mov *sp(#21), *ssp
    1794              ;                       mov *sp(#21), RETA
    1794              ; need to move 23-16 to XSSP contents
    1794              ;                       mov xar0, dbl (*(#_save_xar7))
    1794              ;                       mov ssp, ar0
    1794              ;                       mov #0, ssp 
    1794              ;                       mov xssp, xar0
    1794              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
    1794              ;                       aadd #20, sp            ; this is ok - ssp also incremented
    1794                      ;               add #1, xssp            ; 32-bit return address pointer
    1794                      ;               amar *xssp+
    1794              ;                       mov sp, t0
    1794              ;                       add #1, t0
    1794              ;                       mov t0, ssp
    1794              ;                       incr ssp
    1794              ;                       asub #20, ar0
    1794              ;                       mov xar0, xssp
    1794              ;                       mov ar0, ssp
    1794              ;                       mov ar0, 
    1794              ;;                      mov *sp(#1), t0
    1794              ;;                      mov *sp(#3), t3         ; ST0
    1794              ;;                      mov *sp(#4), t2         ; DBSTAT
    1794              ;;                      mov t3, *ar0(#2)
    1794                      ;;              mov t2, *ar0(#1)
    1794              ;;                      mov t0, *ar0(#0)
    1794              
    1794              ;;                      mov *sp(#5), t0
    1794              ;;                      mov *sp(#6), t1
    1794              ;;                      mov *sp(#7), t2
    1794                      ;;              mov *sp(#8), t3
    1794              
    1794              ; restore ar0
    1794              ;                       mov dbl(*sp(#-2)), xar0
    1794              ;                       mov #-1, ar0
    1794              ;;                      mov dbl (*(#_save_xar7)), xar0
    1794              ;;
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   78

    1794              ;;                      mov sp, t0
    1794              ;;                      add #1, t0
    1794              ;;                      mov t0, ssp
    1794              
    1794              ;                       mov *sp(#3), *(#00004ch+#1)
    1794              
    1794              ;                       mov t3, *ssp(#1) 
    1794              ;                       mov t2, *ssp(#2)
    1794              
    1794              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
    1794              ;;                      mov t3, *(ssp(#0))
    1794              ;                       mov t3, *ssp
    1794              ;                       mov *sp(#3), t3 ; 
    1794              ;                       mov t3, *ssp(#1)
    1794              ;;                      mov *sp(#21), PC        
    1794              
    1794              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1794              ;                       mov dbl(xsp), dbl(lcrpc)
    1794              ;                       popboth XAR7
    1794              ;                       add #1, sp
    1794              ;                       add #1, ssp
    1794              ;                       add #2, t0
    1794              ;                       add #2, t1
    1794              ;                       mov t0, sp
    1794              ;                       mov t1, ssp
    1794              ;                       popboth XAR6
    1794              ;                       add #2, t0
    1794              ;                       add #2, t1
    1794              ;                       mov t0, sp
    1794              ;                       mov t1, ssp
    1794              ;                       popboth XAR5
    1794              ;                       add #2, t0
    1794              ;                       add #2, t1
    1794              ;                       mov t0, sp
    1794              ;                       mov t1, ssp
    1794                              ;-----------------------------------
    1794              ;                       popboth XAR4
    1794              ;                       add #2, t0
    1794              ;                       add #2, t1
    1794              ;                       mov t0, sp
    1794              ;                       mov t1, ssp
    1794              ;                       popboth XAR3
    1794              ;                       add #2, t0
    1794              ;                       add #2, t1
    1794              ;                       mov t0, sp
    1794              ;                       mov t1, ssp
    1794              ;                       popboth XAR2
    1794              ;                       add #2, t0
    1794              ;                       add #2, t1
    1794              ;                       mov t0, sp
    1794              ;                       mov t1, ssp
    1794              ;                       popboth XAR1
    1794              ;                       add #2, t0
    1794              ;                       add #2, t1
    1794              ;                       mov t0, sp
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   79

    1794              ;                       mov t1, ssp
    1794              ;                       popboth XAR0
    1794              ;                       add #2, t0
    1794              ;                       add #2, t1
    1794              ;                       mov t0, sp
    1794              ;                       mov t1, ssp
    1794              ;                       EDIS
    1794              ;                       NASP    ; Un-align stack pointer
    1794              ;;                      pop mmap(ST3_55)
    1794              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1794              ;            BCC $2,TC1 ; |216|
    1794                                      .if 0
    1794                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1794              
    1794                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1794                                      mov dbl (*ar7(#2)), xssp                
    1794                                      .endif
    1794              
    1794 000755 ED31                   mov dbl(*(#_restore_xsp)), xsp
         000757 4F00 
         000759 0000!
    1794 00075b ED31               mov dbl(*(#_restore_xssp)), xssp
         00075d 5F00 
         00075f 0000!
    1794              
    1794              ;;;;;;                  mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1794              ;;;;;;                  mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1794              
    1794              
    1794                                      .if 0
    1794                                      mov dbl (*(_xCompareTCB)), xar6
    1794              ; need to restore our return address
    1794                                      mov xar7, ac0
    1794                          mov xar6, ac1
    1794                              CMPU AC1 != AC0, TC1 ; |1393|
    1794                          BCC $6,TC1 ; |1393|
    1794                          amov #0x000000, xar7
    1794                                      amov #0x000000, xar6
    1794                          mov  *(#_save_new_pxcode), ar7
    1794                                      mov ar7, *sp(#0)
    1794                          mov *(#_save_new_pxlcode) , ar7
    1794                          mov ssp, ar6
    1794                          mov ar7, *ar6(#0)
    1794              
    1794                          mov dbl (*(#_save_xar6)), xar6
    1794                                      .endif
    1794              
    1794              ;;                      mov dbl (*(#_save_xar7)), xar7
    1794              
    1794              ;               .if configSTACK_PTR_DEBUG == 1
    1794              ;;                      mov dbl(*(#_restore_xsp)), xsp
    1794              ;;            mov dbl(*(#_restore_xssp)), xssp
    1794              ;;            .endif
    1794              
    1794              ;                       B $3
TMS320C55x Assembler PC v4.4.1 Tue Oct 02 02:34:00 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   80

    1794              ;$2
    1794              ;           MOV #0, *(#_first_flag) ; |217|
    1794              ;               mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1794              ;                       mov dbl (*(#_first_save_xssp)), xssp
    1794              ;$3
    1794                                      .if 0
    1794                              amov #0x000000, xar7
    1794                                      amov #0x000000, xar6
    1794                                  mov dbl (*(#_pxCurrentTCB)), xar7
    1794                                      mov dbl (*ar7), xar6                            ; xsp normal position
    1794                                      add #0x0064, ar6
    1794                                      mov xar6, xsp                                           ; actual xsp
    1794                                      mov dbl (*ar7(#2)), xar6                        ; xssp
    1794                                      add #0x0002, ar6
    1794                                      mov xar6, xssp
    1794                                      .endif
    1794              
    1794 000761 4EFF                          aadd #-1, sp                    ; on yield, need to do this
    1794 000763 46B2                          bclr INTM               ; enable interrupts
    1794 000765 20                            nop
    1794 000766 20                            nop
    1794 000767 20                            nop
    1794 000768 20                            nop
    1794 000769 20                            nop
    1794 00076a 20                            nop
    1794              
    1794              ;                       aadd #1, sp
    1794 00076b 4805                          RETI
    1794              ;                       mov #1860h, ssp
    1794 00076d 20                            nop
    1794 00076e 20                            nop
    1794              ;                       nop
    1795              
    1796              ;;;
    1797              
    1798              ;                /* Place the tick ISR in the correct vector. */
    1799              
    1800              ;;;                .sect ".int49"                       ; TIMER1_A0_VECTOR
    1801              ;;                .sect ".int14"                        ; CPUTIMER2
    1802              ;                 .sect ".text"                 ; CPUTIMER2
    1803              ;;;;             .sect ".INT14_ISR"
    1804              ;               .global _INT14_ISR
    1805              ;;;; _INT14_ISR:
    1806              ;;;;                .short   _vTickISR
    1807              ;;;;            LCR #_vTickISR
    1808                                      .end

No Assembly Errors, No Assembly Warnings
